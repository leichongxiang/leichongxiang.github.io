<!doctype html>
<html class="theme-next use-motion theme-next-mist">
<head><meta name="generator" content="Hexo 3.9.0">
  

<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">








  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5">



  
    <link href="//fonts.lug.ustc.edu.cn/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  


<link rel="stylesheet" type="text/css" href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0">

<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.5.2">


    <meta name="description" content="记录时间">



  <meta name="keywords" content="MHA,">





  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=0.4.5.2">


<meta name="description" content="一直想写一篇关于mysql高可用架构MHA的博文，因为在企业中这种架构还是比较常用的成熟的，之前做过实验，但是未做记录，今天借此机会整理一下MHA。   简介：MHA（Master High Availability）目前在MySQL高可用方面是一个相对成熟的解决方案，它由日本DeNA公司youshimaton（现就职于Facebook公司）开发，是一套优秀的作为MySQL高可用性环境下故障切换和">
<meta name="keywords" content="MHA">
<meta property="og:type" content="article">
<meta property="og:title" content="MHA">
<meta property="og:url" content="http://leichongxiang.github.io/2016/02/26/mysql_MHA/index.html">
<meta property="og:site_name" content="Vike&#39;s Blog">
<meta property="og:description" content="一直想写一篇关于mysql高可用架构MHA的博文，因为在企业中这种架构还是比较常用的成熟的，之前做过实验，但是未做记录，今天借此机会整理一下MHA。   简介：MHA（Master High Availability）目前在MySQL高可用方面是一个相对成熟的解决方案，它由日本DeNA公司youshimaton（现就职于Facebook公司）开发，是一套优秀的作为MySQL高可用性环境下故障切换和">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://ww4.sinaimg.cn/large/8e712944jw1f1ctlw6dcjj208c04omxc.jpg">
<meta property="og:updated_time" content="2021-03-05T07:53:32.212Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MHA">
<meta name="twitter:description" content="一直想写一篇关于mysql高可用架构MHA的博文，因为在企业中这种架构还是比较常用的成熟的，之前做过实验，但是未做记录，今天借此机会整理一下MHA。   简介：MHA（Master High Availability）目前在MySQL高可用方面是一个相对成熟的解决方案，它由日本DeNA公司youshimaton（现就职于Facebook公司）开发，是一套优秀的作为MySQL高可用性环境下故障切换和">
<meta name="twitter:image" content="http://ww4.sinaimg.cn/large/8e712944jw1f1ctlw6dcjj208c04omxc.jpg">


<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mist',
    sidebar: 'post'
  };
</script>



  <title> MHA | Vike's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?f77b20a6d14f2ad51ff2830ef9fbf36d";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <div class="container one-column page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta custom-logo">
  

  <div class="custom-logo-site-title">
    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Vike's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">人生苦短，我用python</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu menu-left">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home"></i> <br>
            
            首页
          </a>
        </li>
		
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th"></i> <br>
            
            分类
          </a>
        </li>
		
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive"></i> <br>
            
            归档
          </a>
        </li>
		
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags"></i> <br>
            
            标签
          </a>
        </li>
		
      

      
      
    </ul>
  

  
    <div class="site-search">
      
  
  <form class="site-search-form">
    <input type="text" id="st-search-input" class="st-search-input st-default-search-input">
  </form>


<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', '6ywXKaDWo7MbiWzbPCVP','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content"> 

  <div id="posts" class="posts-expand">
    

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                MHA
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            发表于
            <time itemprop="dateCreated" datetime="2016-02-26T16:30:35+08:00" content="2016-02-26">
              2016-02-26
            </time>
          </span>

          
            <span class="post-category">
              &nbsp; | &nbsp; 分类于
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index">
                    <span itemprop="name">mysql</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/02/26/mysql_MHA/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/02/26/mysql_MHA/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          
          
	  
	     <span id="/2016/02/26/mysql_MHA/" class="leancloud_visitors" data-flag-title="MHA">
	     &nbsp; | &nbsp; 阅读次数
	     </span>
	  
        </div>
      </header>
    


    <div class="post-body">

      
      
        <div class="post-gallery" itemscope itemtype="http://schema.org/ImageGallery">
          
          
            <div class="post-gallery-row">
              <a class="post-gallery-img fancybox" href="http://ww4.sinaimg.cn/large/8e712944jw1f1ctlw6dcjj208c04omxc.jpg" rel="gallery_cklw07jxy0088gqj8k8de2iz1" itemscope itemtype="http://schema.org/ImageObject" itemprop="url">
                <img src="http://ww4.sinaimg.cn/large/8e712944jw1f1ctlw6dcjj208c04omxc.jpg" itemprop="contentUrl">
              </a>
            
          

          
          </div>
        </div>
      

      
        <span itemprop="articleBody"><p>一直想写一篇关于mysql高可用架构MHA的博文，因为在企业中这种架构还是比较常用的成熟的，之前做过实验，但是未做记录，今天借此机会整理一下MHA。</p>
<embed src="http://www.xiami.com/widget/79497088_1769819218/singlePlayer.swf" type="application/x-shockwave-flash" width="257" height="33" wmode="transparent">

<h2 id="简介："><a href="#简介：" class="headerlink" title="简介："></a>简介：</h2><p>MHA（Master High Availability）目前在MySQL高可用方面是一个相对成熟的解决方案，它由日本DeNA公司youshimaton（现就职于Facebook公司）开发，是一套优秀的作为MySQL高可用性环境下故障切换和主从提升的高可用软件。在MySQL故障切换过程中，MHA能做到在0~30秒之内自动完成数据库的故障切换操作，并且在进行故障切换的过程中，MHA能在最大程度上保证数据的一致性，以达到真正意义上的高可用。</p>
<font color="red">该软件由两部分组成：MHA Manager（管理节点）和MHA Node（数据节点）。</font> MHA Manager可以单独部署在一台独立的机器上管理多个master-slave集群，也可以部署在一台slave节点上。MHA Node运行在每台MySQL服务器上，MHA Manager会定时探测集群中的master节点，当master出现故障时，它可以自动将最新数据的slave提升为新的master，然后将所有其他的slave重新指向新的master。整个故障转移过程对应用程序完全透明。<br><br>在MHA自动故障切换过程中，MHA试图从宕机的主服务器上保存二进制日志，最大程度的保证数据的不丢失，但这并不总是可行的。例如，如果主服务器硬件故障或无法通过ssh访问，MHA没法保存二进制日志，只进行故障转移而丢失了最新的数据。使用MySQL 5.5的半同步复制，可以大大降低数据丢失的风险。MHA可以与半同步复制结合起来。如果只有一个slave已经收到了最新的二进制日志，MHA可以将最新的二进制日志应用于其他所有的slave服务器上，因此可以保证所有节点的数据一致性。<br><br>目前MHA主要支持一主多从的架构，<font color="red"> 要搭建MHA,要求一个复制集群中必须最少有三台数据库服务器，一主二从，</font>即一台充当master，一台充当备用master，另外一台充当从库，因为至少需要三台服务器，出于机器成本的考虑，淘宝也在该基础上进行了改造，目前淘宝TMHA已经支持一主一从。<br><br>我们自己使用其实也可以使用1主1从，但是master主机宕机后无法切换，以及无法补全binlog。master的mysqld进程crash后，还是可以切换成功，以及补全binlog的。<br><br>官方介绍：<a href="https://code.google.com/p/mysql-master-ha/" target="_blank" rel="noopener">https://code.google.com/p/mysql-master-ha/</a><br><br>图01展示了如何通过MHA Manager管理多组主从复制。可以将MHA工作原理总结为如下：<br><img src="http://ww4.sinaimg.cn/large/8e712944jw1f1ctyqjukhj20hk0d5dih.jpg" alt="图01"><br><a id="more"></a><br><font color="red">（1）从宕机崩溃的master保存二进制日志事件（binlog events）;</font><br><font color="red">（2）识别含有最新更新的slave；                             </font><br><font color="red">（3）应用差异的中继日志（relay log）到其他的slave；        </font><br><font color="red">（4）应用从master保存的二进制日志事件（binlog events）；   </font><br><font color="red">（5）提升一个slave为新的master；                           </font><br><font color="red">（6）使其他的slave连接新的master进行复制；                 </font>

<p>MHA软件由两部分组成，Manager工具包和Node工具包，具体的说明如下。</p>
<p>Manager工具包主要包括以下几个工具：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">masterha_check_ssh              检查MHA的SSH配置状况</span><br><span class="line">masterha_check_repl             检查MySQL复制状况</span><br><span class="line">masterha_manger                 启动MHA</span><br><span class="line">masterha_check_status           检测当前MHA运行状态</span><br><span class="line">masterha_master_monitor         检测master是否宕机</span><br><span class="line">masterha_master_switch          控制故障转移（自动或者手动）</span><br><span class="line">masterha_conf_host              添加或删除配置的server信息</span><br></pre></td></tr></table></figure></p>
<p>Node工具包（这些工具通常由MHA Manager的脚本触发，无需人为操作）主要包括以下几个工具：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">save_binary_logs                保存和复制master的二进制日志</span><br><span class="line">apply_diff_relay_logs           识别差异的中继日志事件并将其差异的事件应用于其他的slave</span><br><span class="line">filter_mysqlbinlog              去除不必要的ROLLBACK事件（MHA已不再使用这个工具）</span><br><span class="line">purge_relay_logs                清除中继日志（不会阻塞SQL线程）</span><br></pre></td></tr></table></figure></p>
<font color="red">注意：</font><br><font color="red">为了尽可能的减少主库硬件损坏宕机造成的数据丢失，因此在配置MHA的同时建议配置成MySQL 5.5的半同步复制。关于半同步复制原理各位自己进行查阅。（不是必须）</font>

<h3 id="1-部署MHA"><a href="#1-部署MHA" class="headerlink" title="1.部署MHA"></a>1.部署MHA</h3><p>接下来部署MHA，具体的搭建环境如下（所有操作系统均为centos 6.2 64bit，不是必须，server03和server04是server02的从，复制环境搭建后面会简单演示，但是相关的安全复制不会详细说明，需要的童鞋请参考前面的文章，MySQL Replication需要注意的问题）：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">角色                    ip地址          主机名          server_id                  类型</span><br><span class="line">Monitor host            192.168.0.20    server01            -                      监控复制组</span><br><span class="line">Master                  192.168.0.50    server02            1                      写入</span><br><span class="line">Candicate master        192.168.0.60    server03            2                      读</span><br><span class="line">Slave                   192.168.0.70    server04            3                      读</span><br></pre></td></tr></table></figure></p>
<p>其中master对外提供写服务，备选master（实际的slave，主机名server03）提供读服务，slave也提供相关的读服务，一旦master宕机，将会把备选master提升为新的master，slave指向新的master</p>
<p>（1）在所有节点安装MHA node所需的perl模块（DBD:mysql），安装脚本如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@192.168.0.50 ~]<span class="comment"># cat install.sh </span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">wget http://xrl.us/cpanm --no-check-certificate</span><br><span class="line">mv cpanm /usr/bin</span><br><span class="line">chmod 755 /usr/bin/cpanm</span><br><span class="line">cat &gt; /root/list &lt;&lt; EOF</span><br><span class="line">install DBD::mysql</span><br><span class="line">EOF</span><br><span class="line"><span class="keyword">for</span> package <span class="keyword">in</span> `cat /root/list`</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    cpanm <span class="variable">$package</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">[root@192.168.0.50 ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p>如果有安装epel源，也可以使用yum安装<br><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span> perl-DBD-MySQL -y</span><br></pre></td></tr></table></figure></p>
<p>（2）在所有的节点安装mha node：<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget http://mysql-<span class="literal">master</span>-ha.googlecode.com/files/mha4mysql-<span class="keyword">node</span><span class="title">-0</span>.<span class="number">53</span>.tar.gz</span><br><span class="line">tar xf mha4mysql-<span class="keyword">node</span><span class="title">-0</span>.<span class="number">53</span>.tar.gz</span><br><span class="line">cd mha4mysql-<span class="keyword">node</span><span class="title">-0</span>.<span class="number">53</span></span><br><span class="line">perl Makefile.PL</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure></p>
<p>安装完成后会在/usr/local/bin目录下生成以下脚本文件：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@192.168.0.50</span> <span class="string">bin]#</span> <span class="string">pwd</span></span><br><span class="line"><span class="string">/usr/local/bin</span></span><br><span class="line"><span class="string">[root@192.168.0.50</span> <span class="string">bin]#</span> <span class="string">ll</span></span><br><span class="line"><span class="string">total</span> <span class="number">40</span></span><br><span class="line"><span class="string">-r-xr-xr-x</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">15498</span> <span class="string">Apr</span> <span class="number">20</span> <span class="number">10</span><span class="string">:05</span> <span class="string">apply_diff_relay_logs</span></span><br><span class="line"><span class="string">-r-xr-xr-x</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>  <span class="number">4807</span> <span class="string">Apr</span> <span class="number">20</span> <span class="number">10</span><span class="string">:05</span> <span class="string">filter_mysqlbinlog</span></span><br><span class="line"><span class="string">-r-xr-xr-x</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>  <span class="number">7401</span> <span class="string">Apr</span> <span class="number">20</span> <span class="number">10</span><span class="string">:05</span> <span class="string">purge_relay_logs</span></span><br><span class="line"><span class="string">-r-xr-xr-x</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>  <span class="number">7263</span> <span class="string">Apr</span> <span class="number">20</span> <span class="number">10</span><span class="string">:05</span> <span class="string">save_binary_logs</span></span><br><span class="line"><span class="string">[root@192.168.0.50</span> <span class="string">bin]#</span></span><br></pre></td></tr></table></figure></p>
<p>关于上面脚本的功能，上面已经介绍过了，这里不再重复了。</p>
<h3 id="2-安装MHA-Manager"><a href="#2-安装MHA-Manager" class="headerlink" title="2.安装MHA Manager"></a>2.安装MHA Manager</h3><p>MHA Manager中主要包括了几个管理员的命令行工具，例如master_manger，master_master_switch等。MHA Manger也依赖于perl模块，具体如下：</p>
<p>（1）安装MHA Node软件包之前需要安装依赖。我这里使用yum完成，没有epel源的可以使用上面提到的脚本（epel源安装也简单）。注意：在MHA Manager的主机也是需要安装MHA Node。<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh <span class="symbol">http:</span>/<span class="regexp">/dl.fedoraproject.org/pub</span><span class="regexp">/epel/</span><span class="number">6</span>/x86_64/epel-release-<span class="number">6</span>-<span class="number">8</span>.noarch.rpm</span><br><span class="line">yum install perl-DBD-MySQL -y</span><br></pre></td></tr></table></figure></p>
<p>安装MHA Node软件包，和上面的方法一样，如下：<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget http://mysql-<span class="literal">master</span>-ha.googlecode.com/files/mha4mysql-<span class="keyword">node</span><span class="title">-0</span>.<span class="number">53</span>.tar.gz</span><br><span class="line">tar xf mha4mysql-<span class="keyword">node</span><span class="title">-0</span>.<span class="number">53</span>.tar.gz</span><br><span class="line">cd mha4mysql-<span class="keyword">node</span><span class="title">-0</span>.<span class="number">53</span></span><br><span class="line">perl Makefile.PL</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure></p>
<p>（2）安装MHA Manager。首先安装MHA Manger依赖的perl模块（我这里使用yum安装）：<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install <span class="keyword">perl</span>-DBD-MySQL <span class="keyword">perl</span>-Config-Tiny <span class="keyword">perl</span>-Log-Dispatch <span class="keyword">perl</span>-Parallel-ForkManager <span class="keyword">perl</span>-Time-HiRes -<span class="keyword">y</span></span><br></pre></td></tr></table></figure></p>
<p>安装MHA Manager软件包：<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget http://mysql-master-<span class="keyword">ha</span>.googlecode.<span class="keyword">com</span>/<span class="keyword">files</span>/mha4mysql-manager-<span class="number">0.53</span>.tar.gz</span><br><span class="line">tar xf mha4mysql-manager-<span class="number">0.53</span>.tar.gz </span><br><span class="line"><span class="keyword">cd</span> mha4mysql-manager-<span class="number">0.53</span></span><br><span class="line"><span class="keyword">perl</span> Makefile.PL</span><br><span class="line"><span class="keyword">make</span> &amp;&amp; <span class="keyword">make</span> install</span><br></pre></td></tr></table></figure></p>
<p>安装完成后会在/usr/local/bin目录下面生成以下脚本文件，前面已经说过这些脚本的作用，这里不再重复<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="string">[root@192.168.0.20</span> <span class="string">bin]#</span> <span class="string">pwd</span></span><br><span class="line"><span class="string">/usr/local/bin</span></span><br><span class="line"><span class="string">[root@192.168.0.20</span> <span class="string">bin]#</span> <span class="string">ll</span></span><br><span class="line"><span class="string">total</span> <span class="number">76</span></span><br><span class="line"><span class="string">-r-xr-xr-x</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">15498</span> <span class="string">Apr</span> <span class="number">20</span> <span class="number">10</span><span class="string">:58</span> <span class="string">apply_diff_relay_logs</span></span><br><span class="line"><span class="string">-r-xr-xr-x</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>  <span class="number">4807</span> <span class="string">Apr</span> <span class="number">20</span> <span class="number">10</span><span class="string">:58</span> <span class="string">filter_mysqlbinlog</span></span><br><span class="line"><span class="string">-r-xr-xr-x</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>  <span class="number">1995</span> <span class="string">Apr</span> <span class="number">20</span> <span class="number">11</span><span class="string">:33</span> <span class="string">masterha_check_repl</span></span><br><span class="line"><span class="string">-r-xr-xr-x</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>  <span class="number">1779</span> <span class="string">Apr</span> <span class="number">20</span> <span class="number">11</span><span class="string">:33</span> <span class="string">masterha_check_ssh</span></span><br><span class="line"><span class="string">-r-xr-xr-x</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>  <span class="number">1865</span> <span class="string">Apr</span> <span class="number">20</span> <span class="number">11</span><span class="string">:33</span> <span class="string">masterha_check_status</span></span><br><span class="line"><span class="string">-r-xr-xr-x</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>  <span class="number">3201</span> <span class="string">Apr</span> <span class="number">20</span> <span class="number">11</span><span class="string">:33</span> <span class="string">masterha_conf_host</span></span><br><span class="line"><span class="string">-r-xr-xr-x</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>  <span class="number">2517</span> <span class="string">Apr</span> <span class="number">20</span> <span class="number">11</span><span class="string">:33</span> <span class="string">masterha_manager</span></span><br><span class="line"><span class="string">-r-xr-xr-x</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>  <span class="number">2165</span> <span class="string">Apr</span> <span class="number">20</span> <span class="number">11</span><span class="string">:33</span> <span class="string">masterha_master_monitor</span></span><br><span class="line"><span class="string">-r-xr-xr-x</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>  <span class="number">2373</span> <span class="string">Apr</span> <span class="number">20</span> <span class="number">11</span><span class="string">:33</span> <span class="string">masterha_master_switch</span></span><br><span class="line"><span class="string">-r-xr-xr-x</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>  <span class="number">3749</span> <span class="string">Apr</span> <span class="number">20</span> <span class="number">11</span><span class="string">:33</span> <span class="string">masterha_secondary_check</span></span><br><span class="line"><span class="string">-r-xr-xr-x</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>  <span class="number">1739</span> <span class="string">Apr</span> <span class="number">20</span> <span class="number">11</span><span class="string">:33</span> <span class="string">masterha_stop</span></span><br><span class="line"><span class="string">-r-xr-xr-x</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>  <span class="number">7401</span> <span class="string">Apr</span> <span class="number">20</span> <span class="number">10</span><span class="string">:58</span> <span class="string">purge_relay_logs</span></span><br><span class="line"><span class="string">-r-xr-xr-x</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>  <span class="number">7263</span> <span class="string">Apr</span> <span class="number">20</span> <span class="number">10</span><span class="string">:58</span> <span class="string">save_binary_logs</span></span><br><span class="line"><span class="string">[root@192.168.0.20</span> <span class="string">bin]#</span></span><br></pre></td></tr></table></figure></p>
<p>复制相关脚本到/usr/local/bin目录(软件包解压缩后就有了，不是必须，因为这些脚本不完整，需要自己修改，这是软件开发着留给我们自己发挥的,如果开启下面的任何一个脚本对应的参数，而对应这里的脚本又没有修改，则会抛错，自己被坑的很惨)<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@<span class="number">192.168</span><span class="number">.0</span><span class="number">.20</span> scripts]# pwd</span><br><span class="line">/root/mha4mysql-manager<span class="number">-0.53</span>/samples/scripts</span><br><span class="line">[root@<span class="number">192.168</span><span class="number">.0</span><span class="number">.20</span> scripts]# ll</span><br><span class="line">total <span class="number">32</span></span><br><span class="line">-rwxr-xr-x <span class="number">1</span> root root  <span class="number">3443</span> Jan  <span class="number">8</span>  <span class="number">2012</span> master_ip_failover                #自动切换时vip管理的脚本，不是必须，如果我们使用keepalived的，我们可以自己编写脚本完成对vip的管理，比如监控mysql，如果mysql异常，我们停止keepalived就行，这样vip就会自动漂移</span><br><span class="line">-rwxr-xr-x <span class="number">1</span> root root  <span class="number">9186</span> Jan  <span class="number">8</span>  <span class="number">2012</span> master_ip_online_change           #在线切换时vip的管理，不是必须，同样可以可以自行编写简单的shell完成</span><br><span class="line">-rwxr-xr-x <span class="number">1</span> root root <span class="number">11867</span> Jan  <span class="number">8</span>  <span class="number">2012</span> power_manager                     #故障发生后关闭主机的脚本，不是必须</span><br><span class="line">-rwxr-xr-x <span class="number">1</span> root root  <span class="number">1360</span> Jan  <span class="number">8</span>  <span class="number">2012</span> send_report                       #因故障切换后发送报警的脚本，不是必须，可自行编写简单的shell完成。</span><br><span class="line">[root@<span class="number">192.168</span><span class="number">.0</span><span class="number">.20</span> scripts]# cp * /usr/local/bin/</span><br><span class="line">[root@<span class="number">192.168</span><span class="number">.0</span><span class="number">.20</span> scripts]#</span><br></pre></td></tr></table></figure></p>
<h3 id="3-配置SSH登录无密码验证（使用key登录，工作中常用）"><a href="#3-配置SSH登录无密码验证（使用key登录，工作中常用）" class="headerlink" title="3.配置SSH登录无密码验证（使用key登录，工作中常用）"></a>3.配置SSH登录无密码验证（使用key登录，工作中常用）</h3><p>我的测试环境已经是使用key登录，服务器之间无需密码验证的。关于配置使用key登录，我想我不再重复。但是有一点需要注意：不能禁止<font color="red"> password 登陆，否则会出现错误</font></p>
<h3 id="4-搭建主从复制环境"><a href="#4-搭建主从复制环境" class="headerlink" title="4.搭建主从复制环境"></a>4.搭建主从复制环境</h3><font color="red">注意：binlog-do-db 和 replicate-ignore-db 设置必须相同。 MHA 在启动时候会检测过滤规则，如果过滤规则不同，MHA 不启动监控和故障转移。</font>

<p>（1）在server02上执行备份（192.168.0.50）<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="number">192.168</span><span class="number">.0</span><span class="number">.50</span> ~]# mysqldump --master-data=<span class="number">2</span> --single-transaction -R --triggers -A &gt; all.sql</span><br></pre></td></tr></table></figure></p>
<p>其中–master-data=2代表备份时刻记录master的Binlog位置和Position，–single-transaction意思是获取一致性快照，-R意思是备份存储过程和函数，–triggres的意思是备份触发器，-A代表备份所有的库。更多信息请自行mysqldump –help查看。</p>
<p>（2）在server02上创建复制用户：<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">mysql&gt; grant replication slave <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">'repl'</span>@<span class="string">'192.168.0.%'</span> identified <span class="keyword">by</span> <span class="string">'123456'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure></p>
<p>（3）查看主库备份时的binlog名称和位置，MASTER_LOG_FILE和MASTER_LOG_POS：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="number">192.168</span><span class="number">.0</span><span class="number">.50</span> ~]# head -n <span class="number">30</span> all.sql | grep 'CHANGE MASTER TO'</span><br><span class="line">-- CHANGE MASTER TO MASTER_LOG_FILE='mysql-bin<span class="number">.000010</span>', MASTER_LOG_POS=<span class="number">112</span>;</span><br><span class="line">[root@<span class="number">192.168</span><span class="number">.0</span><span class="number">.50</span> ~]#</span><br></pre></td></tr></table></figure></p>
<p>（4）把备份复制到server03和server04，也就是192.168.0.60和192.168.0.70<br><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scp <span class="built_in">all</span>.sql server03:/<span class="keyword">data</span>/</span><br><span class="line">scp <span class="built_in">all</span>.sql server04:/<span class="keyword">data</span>/</span><br></pre></td></tr></table></figure></p>
<p>（5）导入备份到server03，执行复制相关命令<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql &lt; /data/all.sql</span><br><span class="line"></span><br><span class="line">mysql&gt; CHANGE MASTER TO MASTER_HOST='<span class="number">192.168</span><span class="number">.0</span><span class="number">.50</span>',MASTER_USER='repl', MASTER_PASSWORD='<span class="number">123456</span>',MASTER_LOG_FILE='mysql-bin<span class="number">.000010</span>',MASTER_LOG_POS=<span class="number">112</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; start slave;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure></p>
<p>查看复制状态（可以看见复制成功）：</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@192</span><span class="number">.168</span><span class="number">.0</span><span class="number">.60</span> ~]<span class="meta"># mysql -e <span class="string">'show slave status\G'</span> | egrep <span class="string">'Slave_IO|Slave_SQL'</span></span></span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master <span class="keyword">to</span> <span class="built_in">send</span> event</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">[root<span class="symbol">@192</span><span class="number">.168</span><span class="number">.0</span><span class="number">.60</span> ~]<span class="meta">#</span></span><br></pre></td></tr></table></figure>
<p>（6）在server04（192.168.0.70）上搭建复制环境，操作和上面一样。<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql &lt; /data/all.sql</span><br><span class="line"></span><br><span class="line">mysql&gt; CHANGE MASTER TO MASTER_HOST='<span class="number">192.168</span><span class="number">.0</span><span class="number">.50</span>',MASTER_USER='repl', MASTER_PASSWORD='<span class="number">123456</span>',MASTER_LOG_FILE='mysql-bin<span class="number">.000010</span>',MASTER_LOG_POS=<span class="number">112</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.07</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; start slave;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure></p>
<p>查看复制状态：<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@192</span><span class="number">.168</span><span class="number">.0</span><span class="number">.70</span> ~]<span class="meta"># mysql -e <span class="string">'show slave status\G'</span> | egrep <span class="string">'Slave_IO|Slave_SQL'</span></span></span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master <span class="keyword">to</span> <span class="built_in">send</span> event</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">[root<span class="symbol">@192</span><span class="number">.168</span><span class="number">.0</span><span class="number">.70</span> ~]<span class="meta">#</span></span><br></pre></td></tr></table></figure></p>
<p>（7）两台slave服务器设置read_only（从库对外提供读服务，只所以没有写进配置文件，<font color="red">是因为随时slave会提升为master</font>）<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="number">192.168</span><span class="number">.0</span><span class="number">.60</span> ~]# mysql -e 'set global read_only=<span class="number">1</span>'</span><br><span class="line">[root@<span class="number">192.168</span><span class="number">.0</span><span class="number">.60</span> ~]# </span><br><span class="line"></span><br><span class="line">[root@<span class="number">192.168</span><span class="number">.0</span><span class="number">.70</span> ~]# mysql -e 'set global read_only=<span class="number">1</span>'</span><br><span class="line">[root@<span class="number">192.168</span><span class="number">.0</span><span class="number">.70</span> ~]#</span><br></pre></td></tr></table></figure></p>
<p>（8）创建监控用户（在master上执行，也就是192.168.0.50）：<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">mysql&gt; grant <span class="literal">all</span> privileges <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">'root'</span>@<span class="string">'192.168.0.%'</span> identified  <span class="keyword">by</span> <span class="string">'123456'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; flush  privileges;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure></p>
<p>到这里整个集群环境已经搭建完毕，剩下的就是配置MHA软件了。</p>
<h3 id="5-配置MHA"><a href="#5-配置MHA" class="headerlink" title="5.配置MHA"></a>5.配置MHA</h3><p>（1）创建MHA的工作目录，并且创建相关配置文件（在软件包解压后的目录里面有样例配置文件）。<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="number">192.168</span><span class="number">.0</span><span class="number">.20</span> ~]# mkdir -p /etc/masterha</span><br><span class="line">[root@<span class="number">192.168</span><span class="number">.0</span><span class="number">.20</span> ~]# cp mha4mysql-manager<span class="number">-0.53</span>/samples/conf/app1.cnf /etc/masterha/</span><br><span class="line">[root@<span class="number">192.168</span><span class="number">.0</span><span class="number">.20</span> ~]#</span><br></pre></td></tr></table></figure></p>
<p>修改app1.cnf配置文件，修改后的文件内容如下（注意，配置文件中的注释需要去掉，我这里是为了解释清楚）：<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="section">[root@192.168.0.20 ~]</span><span class="comment"># cat /etc/masterha/app1.cnf </span></span><br><span class="line"><span class="section">[server default]</span></span><br><span class="line"><span class="attr">manager_workdir</span>=/var/log/masterha/app1.log              //设置manager的工作目录</span><br><span class="line"><span class="attr">manager_log</span>=/var/log/masterha/app1/manager.log          //设置manager的日志</span><br><span class="line"><span class="attr">master_binlog_dir</span>=/data/mysql                         //设置master 保存binlog的位置，以便MHA可以找到master的日志，我这里的也就是mysql的数据目录</span><br><span class="line"><span class="attr">master_ip_failover_script</span>= /usr/local/bin/master_ip_failover    //设置自动failover时候的切换脚本</span><br><span class="line"><span class="attr">master_ip_online_change_script</span>= /usr/local/bin/master_ip_online_change  //设置手动切换时候的切换脚本</span><br><span class="line"><span class="attr">password</span>=<span class="number">123456</span>         //设置mysql中root用户的密码，这个密码是前文中创建监控用户的那个密码</span><br><span class="line"><span class="attr">user</span>=root               设置监控用户root</span><br><span class="line"><span class="attr">ping_interval</span>=<span class="number">1</span>         //设置监控主库，发送ping包的时间间隔，默认是<span class="number">3</span>秒，尝试三次没有回应的时候自动进行railover</span><br><span class="line"><span class="attr">remote_workdir</span>=/tmp     //设置远端mysql在发生切换时binlog的保存位置</span><br><span class="line"><span class="attr">repl_password</span>=<span class="number">123456</span>    //设置复制用户的密码</span><br><span class="line"><span class="attr">repl_user</span>=repl          //设置复制环境中的复制用户名</span><br><span class="line"><span class="attr">report_script</span>=/usr/local/send_report    //设置发生切换后发送的报警的脚本</span><br><span class="line"><span class="attr">secondary_check_script</span>= /usr/local/bin/masterha_secondary_check -s server03 -s server02 --user=root --master_host=server02 --master_ip=<span class="number">192.168</span>.<span class="number">0.50</span> --master_port=<span class="number">3306</span>               //一旦MHA到server02的监控之间出现问题，MHA Manager将会尝试从server03登录到server02</span><br><span class="line"><span class="attr">shutdown_script</span>=<span class="string">""</span>      //设置故障发生后关闭故障主机脚本（该脚本的主要作用是关闭主机放在发生脑裂,这里没有使用）</span><br><span class="line"><span class="attr">ssh_user</span>=root           //设置ssh的登录用户名</span><br><span class="line"></span><br><span class="line"><span class="section">[server1]</span></span><br><span class="line"><span class="attr">hostname</span>=<span class="number">192.168</span>.<span class="number">0.50</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">3306</span></span><br><span class="line"></span><br><span class="line"><span class="section">[server2]</span></span><br><span class="line"><span class="attr">hostname</span>=<span class="number">192.168</span>.<span class="number">0.60</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">3306</span></span><br><span class="line"><span class="attr">candidate_master</span>=<span class="number">1</span>   //设置为候选master，如果设置该参数以后，发生主从切换以后将会将此从库提升为主库，即使这个主库不是集群中事件最新的slave</span><br><span class="line"><span class="attr">check_repl_delay</span>=<span class="number">0</span>   //默认情况下如果一个slave落后master <span class="number">100</span>M的relay logs的话，MHA将不会选择该slave作为一个新的master，因为对于这个slave的恢复需要花费很长时间，通过设置check_repl_delay=<span class="number">0</span>,MHA触发切换在选择一个新的master的时候将会忽略复制延时，这个参数对于设置了candidate_master=<span class="number">1</span>的主机非常有用，因为这个候选主在切换的过程中一定是新的master</span><br><span class="line"></span><br><span class="line"><span class="section">[server3]</span></span><br><span class="line"><span class="attr">hostname</span>=<span class="number">192.168</span>.<span class="number">0.70</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">3306</span></span><br><span class="line"><span class="section">[root@192.168.0.20 ~]</span><span class="comment">#</span></span><br></pre></td></tr></table></figure></p>
<p>（2）设置relay log的清除方式（在每个slave节点上）：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="number">192.168</span><span class="number">.0</span><span class="number">.60</span> ~]# mysql -e 'set global relay_log_purge=<span class="number">0</span>'</span><br><span class="line">[root@<span class="number">192.168</span><span class="number">.0</span><span class="number">.70</span> ~]# mysql -e 'set global relay_log_purge=<span class="number">0</span>'</span><br></pre></td></tr></table></figure></p>
<font color="red">注意：</font><br><font color="red">MHA在发生切换的过程中，从库的恢复过程中依赖于relay log的相关信息，所以这里要将relay log的自动清除设置为OFF，采用手动清除relay log的方式。在默认情况下，从服务器上的中继日志会在SQL线程执行完毕后被自动删除。但是在MHA环境中，这些中继日志在恢复其他从服务器时可能会被用到，因此需要禁用中继日志的自动删除功能。定期清除中继日志需要考虑到复制延时的问题。在ext3的文件系统下，删除大的文件需要一定的时间，会导致严重的复制延时。为了避免复制延时，需要暂时为中继日志创建硬链接，因为在linux系统中通过硬链接删除大文件速度会很快。（在mysql数据库中，删除大表时，通常也采用建立硬链接的方式）</font>

<p>MHA节点中包含了pure_relay_logs命令工具，它可以为中继日志创建硬链接，执行SET GLOBAL relay_log_purge=1,等待几秒钟以便SQL线程切换到新的中继日志，再执行SET GLOBAL relay_log_purge=0。</p>
<p>pure_relay_logs脚本参数如下所示：<br><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">--user</span> mysql                      用户名</span><br><span class="line"><span class="params">--password</span> mysql                  密码</span><br><span class="line"><span class="params">--port</span>                            端口号</span><br><span class="line"><span class="params">--workdir</span>                         指定创建relay log的硬链接的位置，默认是<span class="string">/var/tmp</span>，由于系统不同分区创建硬链接文件会失败，故需要执行硬链接具体位置，成功执行脚本后，硬链接的中继日志文件被删除</span><br><span class="line"><span class="params">--disable_relay_log_purge</span>         默认情况下，如果relay_log_purge=1，脚本会什么都不清理，自动退出，通过设定这个参数，当relay_log_purge=1的情况下会将relay_log_purge设置为0。清理relay log之后，最后将参数设置为OFF。</span><br></pre></td></tr></table></figure></p>
<p>（3）设置定期清理relay脚本（两台slave服务器）<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@192.168.0.60 ~]# cat purge_relay_log.sh </span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="attribute">user</span>=root</span><br><span class="line"><span class="attribute">passwd</span>=123456</span><br><span class="line"><span class="attribute">port</span>=3306</span><br><span class="line"><span class="attribute">log_dir</span>=<span class="string">'/data/masterha/log'</span></span><br><span class="line"><span class="attribute">work_dir</span>=<span class="string">'/data'</span></span><br><span class="line"><span class="attribute">purge</span>=<span class="string">'/usr/local/bin/purge_relay_logs'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -d <span class="variable">$log_dir</span> ]</span><br><span class="line">then</span><br><span class="line">   mkdir <span class="variable">$log_dir</span> -p</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="variable">$purge</span> <span class="attribute">--user</span>=<span class="variable">$user</span> <span class="attribute">--password</span>=<span class="variable">$passwd</span> --disable_relay_log_purge <span class="attribute">--port</span>=<span class="variable">$port</span> <span class="attribute">--workdir</span>=<span class="variable">$work_dir</span> &gt;&gt; <span class="variable">$log_dir</span>/purge_relay_logs.log 2&gt;&amp;1</span><br><span class="line">[root@192.168.0.60 ~]#</span><br></pre></td></tr></table></figure></p>
<p>添加到crontab定期执行</p>
<p>[<a href="mailto:root@192.168.0.60" target="_blank" rel="noopener">root@192.168.0.60</a> ~]# crontab -l<br>0 4 <em> </em> * /bin/bash /root/purge_relay_log.sh<br>[<a href="mailto:root@192.168.0.60" target="_blank" rel="noopener">root@192.168.0.60</a> ~]# </p>
<p>purge_relay_logs脚本删除中继日志不会阻塞SQL线程。下面我们手动执行看看什么情况。<br><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@<span class="number">192.168</span><span class="number">.0</span><span class="number">.60</span> ~]# purge_relay_logs --user=root --password=<span class="number">123456</span> --port=<span class="number">3306</span> -disable_relay_log_purge --workdir=/data/</span><br><span class="line"><span class="number">2014</span><span class="number">-04</span><span class="number">-20</span> <span class="number">15</span>:<span class="number">47</span>:<span class="number">24</span>: purge_relay_logs script started.</span><br><span class="line"> Found relay_log.info: /data/mysql/relay-<span class="built-in">log</span>.info</span><br><span class="line"> Removing hard linked relay <span class="built-in">log</span> <span class="keyword">files</span> server03-relay-bin* under /data/.. done.</span><br><span class="line"> Current relay <span class="built-in">log</span> <span class="keyword">file</span>: /data/mysql/server03-relay-bin<span class="number">.000002</span></span><br><span class="line"> Archiving unused relay <span class="built-in">log</span> <span class="keyword">files</span> (up to /data/mysql/server03-relay-bin<span class="number">.000001</span>) ...</span><br><span class="line"> Creating hard link <span class="keyword">for</span> /data/mysql/server03-relay-bin<span class="number">.000001</span> under /data<span class="comment">//server03-relay-bin.000001 .. ok.</span></span><br><span class="line"> Creating hard links <span class="keyword">for</span> unused relay <span class="built-in">log</span> <span class="keyword">files</span> completed.</span><br><span class="line"> Executing <span class="keyword">SET</span> GLOBAL <span class="comment">relay_log_purge=1</span>; FLUSH LOGS; sleeping a few seconds so that SQL thread can delete older relay <span class="built-in">log</span> <span class="keyword">files</span> (<span class="keyword">if</span> it keeps up); <span class="keyword">SET</span> GLOBAL <span class="comment">relay_log_purge=0</span>; .. ok.</span><br><span class="line"> Removing hard linked relay <span class="built-in">log</span> <span class="keyword">files</span> server03-relay-bin* under /data/.. done.</span><br><span class="line"><span class="number">2014</span><span class="number">-04</span><span class="number">-20</span> <span class="number">15</span>:<span class="number">47</span>:<span class="number">27</span>: <span class="keyword">All</span> relay <span class="built-in">log</span> purging operations succeeded.</span><br><span class="line">[root@<span class="number">192.168</span><span class="number">.0</span><span class="number">.60</span> ~]#</span><br></pre></td></tr></table></figure></p>
<h3 id="6-检查SSH配置"><a href="#6-检查SSH配置" class="headerlink" title="6.检查SSH配置"></a>6.检查SSH配置</h3><p>检查MHA Manger到所有MHA Node的SSH连接状态：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@192.168.0.20 ~]# masterha_check_ssh <span class="attribute">--conf</span>=/etc/masterha/app1.cnf </span><br><span class="line">Sun Apr 20 17:17:39 2014 - [<span class="builtin-name">warning</span>] Global configuration file /etc/masterha_default.cnf <span class="keyword">not</span> found. Skipping.</span><br><span class="line">Sun Apr 20 17:17:39 2014 - [<span class="builtin-name">info</span>] Reading application<span class="built_in"> default </span>configurations <span class="keyword">from</span> /etc/masterha/app1.cnf<span class="built_in">..</span></span><br><span class="line">Sun Apr 20 17:17:39 2014 - [<span class="builtin-name">info</span>] Reading<span class="built_in"> server </span>configurations <span class="keyword">from</span> /etc/masterha/app1.cnf<span class="built_in">..</span></span><br><span class="line">Sun Apr 20 17:17:39 2014 - [<span class="builtin-name">info</span>] Starting SSH<span class="built_in"> connection </span>tests<span class="built_in">..</span></span><br><span class="line">Sun Apr 20 17:17:40 2014 - [<span class="builtin-name">debug</span>] </span><br><span class="line">Sun Apr 20 17:17:39 2014 - [<span class="builtin-name">debug</span>]  Connecting via SSH <span class="keyword">from</span> root@192.168.0.50(192.168.0.50:22) <span class="keyword">to</span> root@192.168.0.60(192.168.0.60:22)<span class="built_in">..</span></span><br><span class="line">Sun Apr 20 17:17:39 2014 - [<span class="builtin-name">debug</span>]   ok.</span><br><span class="line">Sun Apr 20 17:17:39 2014 - [<span class="builtin-name">debug</span>]  Connecting via SSH <span class="keyword">from</span> root@192.168.0.50(192.168.0.50:22) <span class="keyword">to</span> root@192.168.0.70(192.168.0.70:22)<span class="built_in">..</span></span><br><span class="line">Sun Apr 20 17:17:39 2014 - [<span class="builtin-name">debug</span>]   ok.</span><br><span class="line">Sun Apr 20 17:17:40 2014 - [<span class="builtin-name">debug</span>] </span><br><span class="line">Sun Apr 20 17:17:40 2014 - [<span class="builtin-name">debug</span>]  Connecting via SSH <span class="keyword">from</span> root@192.168.0.60(192.168.0.60:22) <span class="keyword">to</span> root@192.168.0.50(192.168.0.50:22)<span class="built_in">..</span></span><br><span class="line">Sun Apr 20 17:17:40 2014 - [<span class="builtin-name">debug</span>]   ok.</span><br><span class="line">Sun Apr 20 17:17:40 2014 - [<span class="builtin-name">debug</span>]  Connecting via SSH <span class="keyword">from</span> root@192.168.0.60(192.168.0.60:22) <span class="keyword">to</span> root@192.168.0.70(192.168.0.70:22)<span class="built_in">..</span></span><br><span class="line">Sun Apr 20 17:17:40 2014 - [<span class="builtin-name">debug</span>]   ok.</span><br><span class="line">Sun Apr 20 17:17:41 2014 - [<span class="builtin-name">debug</span>] </span><br><span class="line">Sun Apr 20 17:17:40 2014 - [<span class="builtin-name">debug</span>]  Connecting via SSH <span class="keyword">from</span> root@192.168.0.70(192.168.0.70:22) <span class="keyword">to</span> root@192.168.0.50(192.168.0.50:22)<span class="built_in">..</span></span><br><span class="line">Sun Apr 20 17:17:40 2014 - [<span class="builtin-name">debug</span>]   ok.</span><br><span class="line">Sun Apr 20 17:17:40 2014 - [<span class="builtin-name">debug</span>]  Connecting via SSH <span class="keyword">from</span> root@192.168.0.70(192.168.0.70:22) <span class="keyword">to</span> root@192.168.0.60(192.168.0.60:22)<span class="built_in">..</span></span><br><span class="line">Sun Apr 20 17:17:41 2014 - [<span class="builtin-name">debug</span>]   ok.</span><br><span class="line">Sun Apr 20 17:17:41 2014 - [<span class="builtin-name">info</span>] All SSH<span class="built_in"> connection </span>tests passed successfully.</span><br></pre></td></tr></table></figure></p>
<p>可以看见各个节点ssh验证都是ok的。</p>
<h3 id="7-检查整个复制环境状况。"><a href="#7-检查整个复制环境状况。" class="headerlink" title="7.检查整个复制环境状况。"></a>7.检查整个复制环境状况。</h3><p>通过masterha_check_repl脚本查看整个集群的状态<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@192.168.0.20 ~]# masterha_check_repl <span class="attribute">--conf</span>=/etc/masterha/app1.cnf</span><br><span class="line">Sun Apr 20 18:36:55 2014 - [<span class="builtin-name">info</span>] Checking replication<span class="built_in"> health </span>on 192.168.0.60<span class="built_in">..</span></span><br><span class="line">Sun Apr 20 18:36:55 2014 - [<span class="builtin-name">info</span>]  ok.</span><br><span class="line">Sun Apr 20 18:36:55 2014 - [<span class="builtin-name">info</span>] Checking replication<span class="built_in"> health </span>on 192.168.0.70<span class="built_in">..</span></span><br><span class="line">Sun Apr 20 18:36:55 2014 - [<span class="builtin-name">info</span>]  ok.</span><br><span class="line">Sun Apr 20 18:36:55 2014 - [<span class="builtin-name">info</span>] Checking master_ip_failover_script status:</span><br><span class="line">Sun Apr 20 18:36:55 2014 - [<span class="builtin-name">info</span>]   /usr/local/bin/master_ip_failover <span class="attribute">--command</span>=status <span class="attribute">--ssh_user</span>=root <span class="attribute">--orig_master_host</span>=192.168.0.50 <span class="attribute">--orig_master_ip</span>=192.168.0.50 <span class="attribute">--orig_master_port</span>=3306 </span><br><span class="line">Bareword <span class="string">"FIXME_xxx"</span> <span class="keyword">not</span> allowed <span class="keyword">while</span> <span class="string">"strict subs"</span> <span class="keyword">in</span> use at /usr/local/bin/master_ip_failover line 88.</span><br><span class="line">Execution of /usr/local/bin/master_ip_failover aborted due <span class="keyword">to</span> compilation errors.</span><br><span class="line">Sun Apr 20 18:36:55 2014 - [<span class="builtin-name">error</span>][/usr/local/share/perl5/MHA/MasterMonitor.pm, ln214]  Failed <span class="keyword">to</span> <span class="builtin-name">get</span> master_ip_failover_script status with return code 255:0.</span><br><span class="line">Sun Apr 20 18:36:55 2014 - [<span class="builtin-name">error</span>][/usr/local/share/perl5/MHA/MasterMonitor.pm, ln383] <span class="builtin-name">Error</span> happend on checking configurations.  at /usr/local/bin/masterha_check_repl line 48</span><br><span class="line">Sun Apr 20 18:36:55 2014 - [<span class="builtin-name">error</span>][/usr/local/share/perl5/MHA/MasterMonitor.pm, ln478] <span class="builtin-name">Error</span> happened on monitoring servers.</span><br><span class="line">Sun Apr 20 18:36:55 2014 - [<span class="builtin-name">info</span>] Got exit code 1 (<span class="keyword">Not</span> master dead).</span><br><span class="line"></span><br><span class="line">MySQL Replication<span class="built_in"> Health </span>is <span class="keyword">NOT</span> OK!</span><br></pre></td></tr></table></figure></p>
<font color="red">发现最后的结论说我的复制不是ok的。但是上面的信息明明说是正常的，自己也进数据库查看了。这里一直踩坑。一直纠结，后来无意中发现火丁笔记的博客，这才知道了原因，原来Failover两种方式：一种是虚拟IP地址，一种是全局配置文件。MHA并没有限定使用哪一种方式，而是让用户自己选择，虚拟IP地址的方式会牵扯到其它的软件,比如keepalive软件，而且还要修改脚本master_ip_failover。</font>

<p>如果发现如下错误：<br><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Can't exec "mysqlbinlog": No such file or directory at /usr/local/share/perl5/MHA/BinlogManager.pm line 99.</span><br><span class="line">mysqlbinlog version not found!</span><br><span class="line"></span><br><span class="line"><span class="keyword">Testing </span>mysql connection and privileges..sh: mysql: command not found</span><br></pre></td></tr></table></figure></p>
<p>解决方法如下，添加软连接（所有节点）<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ln -s <span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/mysql/</span>bin/mysqlbinlog <span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/bin/</span>mysqlbinlog</span><br><span class="line"></span><br><span class="line">ln -s <span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/mysql/</span>bin/mysql <span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/bin/</span>mysql</span><br></pre></td></tr></table></figure></p>
<p>所以先暂时注释master_ip_failover_script= /usr/local/bin/master_ip_failover这个选项。后面引入keepalived后和修改该脚本以后再开启该选项。<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="number">192.168</span><span class="number">.0</span><span class="number">.20</span> ~]# grep master_ip_failover /etc/masterha/app1.cnf</span><br><span class="line">#master_ip_failover_script= /usr/local/bin/master_ip_failover</span><br><span class="line">[root@<span class="number">192.168</span><span class="number">.0</span><span class="number">.20</span> ~]#</span><br></pre></td></tr></table></figure></p>
<p>再次进行状态查看：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Sun Apr 20 18:46:08 2014 - [<span class="builtin-name">info</span>] Checking replication<span class="built_in"> health </span>on 192.168.0.60<span class="built_in">..</span></span><br><span class="line">Sun Apr 20 18:46:08 2014 - [<span class="builtin-name">info</span>]  ok.</span><br><span class="line">Sun Apr 20 18:46:08 2014 - [<span class="builtin-name">info</span>] Checking replication<span class="built_in"> health </span>on 192.168.0.70<span class="built_in">..</span></span><br><span class="line">Sun Apr 20 18:46:08 2014 - [<span class="builtin-name">info</span>]  ok.</span><br><span class="line">Sun Apr 20 18:46:08 2014 - [<span class="builtin-name">warning</span>] master_ip_failover_script is <span class="keyword">not</span> defined.</span><br><span class="line">Sun Apr 20 18:46:08 2014 - [<span class="builtin-name">warning</span>] shutdown_script is <span class="keyword">not</span> defined.</span><br><span class="line">Sun Apr 20 18:46:08 2014 - [<span class="builtin-name">info</span>] Got exit code 0 (<span class="keyword">Not</span> master dead).</span><br><span class="line"></span><br><span class="line">MySQL Replication<span class="built_in"> Health </span>is OK.</span><br></pre></td></tr></table></figure></p>
<p>已经没有明显报错，只有两个警告而已，复制也显示正常了。</p>
<h3 id="8-检查MHA-Manager的状态："><a href="#8-检查MHA-Manager的状态：" class="headerlink" title="8.检查MHA Manager的状态："></a>8.检查MHA Manager的状态：</h3><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">通过master_check_status脚本查看Manager的状态：</span><br><span class="line"></span><br><span class="line">[root<span class="variable">@192</span>.<span class="number">168.0</span>.<span class="number">20</span> ~]<span class="comment"># masterha_check_status --conf=/etc/masterha/app1.cnf</span></span><br><span class="line">app1 is stopped(<span class="number">2</span><span class="symbol">:NOT_RUNNING</span>).</span><br><span class="line">[root<span class="variable">@192</span>.<span class="number">168.0</span>.<span class="number">20</span> ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p>注意：如果正常，会显示”PING_OK”，否则会显示”NOT_RUNNING”，这代表MHA监控没有开启。</p>
<h3 id="9-开启MHA-Manager监控"><a href="#9-开启MHA-Manager监控" class="headerlink" title="9.开启MHA Manager监控"></a>9.开启MHA Manager监控</h3><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="number">192.168</span><span class="number">.0</span><span class="number">.20</span> ~]# nohup masterha_manager --conf=/etc/masterha/app1.cnf --remove_dead_master_conf --ignore_last_failover &lt; /dev/null &gt; /var/log/masterha/app1/manager.log <span class="number">2</span>&gt;&amp;<span class="number">1</span> &amp;  </span><br><span class="line">[<span class="number">1</span>] <span class="number">30867</span></span><br><span class="line">[root@<span class="number">192.168</span><span class="number">.0</span><span class="number">.20</span> ~]#</span><br></pre></td></tr></table></figure>
<font color="red">启动参数介绍：</font><br><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">--remove_dead_master_conf</span>      该参数代表当发生主从切换后，老的主库的ip将会从配置文件中移除。</span><br><span class="line"><span class="params">--manger_log</span>                            日志存放位置</span><br><span class="line"><span class="params">--ignore_last_failover</span>                 在缺省情况下，如果MHA检测到连续发生宕机，且两次宕机间隔不足8小时的话，则不会进行Failover，之所以这样限制是为了避免ping-pong效应。该参数代表忽略上次MHA触发切换产生的文件，默认情况下，MHA发生切换后会在日志目录，也就是上面我设置的<span class="string">/data</span>产生app1.failover.complete文件，下次再次切换的时候如果发现该目录下存在该文件将不允许触发切换，除非在第一次切换后收到删除该文件，为了方便，这里设置为<span class="params">--ignore_last_failover</span>。</span><br></pre></td></tr></table></figure><br><br>查看MHA Manager监控是否正常：<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="number">192.168</span><span class="number">.0</span><span class="number">.20</span> ~]<span class="comment"># masterha_check_status --conf=/etc/masterha/app1.cnf</span></span><br><span class="line">app1 (pid:<span class="number">20386</span>) <span class="keyword">is</span> <span class="built_in">running</span>(<span class="number">0</span>:PING_OK), master:<span class="number">192.168</span><span class="number">.0</span><span class="number">.50</span></span><br></pre></td></tr></table></figure><br><br>可以看见已经在监控了，而且master的主机为192.168.0.50<br><strong>  10.查看启动日志 </strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@192.168.0.20 ~]<span class="comment"># tail -n20 /var/log/masterha/app1/manager.log</span></span><br><span class="line">Sun Apr 20 19:12:01 2014 - [info]   Connecting to root@192.168.0.70(192.168.0.70:22).. </span><br><span class="line">  Checking slave recovery environment settings..</span><br><span class="line">    Opening /data/mysql/relay-log.info ... ok.</span><br><span class="line">    Relay <span class="built_in">log</span> found at /data/mysql, up to server04-relay-bin.000002</span><br><span class="line">    Temporary relay <span class="built_in">log</span> file is /data/mysql/server04-relay-bin.000002</span><br><span class="line">    Testing mysql connection and privileges.. <span class="keyword">done</span>.</span><br><span class="line">    Testing mysqlbinlog output.. <span class="keyword">done</span>.</span><br><span class="line">    Cleaning up <span class="built_in">test</span> file(s).. <span class="keyword">done</span>.</span><br><span class="line">Sun Apr 20 19:12:01 2014 - [info] Slaves settings check <span class="keyword">done</span>.</span><br><span class="line">Sun Apr 20 19:12:01 2014 - [info] </span><br><span class="line">192.168.0.50 (current master)</span><br><span class="line"> +--192.168.0.60</span><br><span class="line"> +--192.168.0.70</span><br><span class="line"></span><br><span class="line">Sun Apr 20 19:12:01 2014 - [warning] master_ip_failover_script is not defined.</span><br><span class="line">Sun Apr 20 19:12:01 2014 - [warning] shutdown_script is not defined.</span><br><span class="line">Sun Apr 20 19:12:01 2014 - [info] Set master ping interval 1 seconds.</span><br><span class="line">Sun Apr 20 19:12:01 2014 - [info] Set secondary check script: /usr/<span class="built_in">local</span>/bin/masterha_secondary_check -s server03 -s server02 --user=root --master_host=server02 --master_ip=192.168.0.50 --master_port=3306</span><br><span class="line">Sun Apr 20 19:12:01 2014 - [info] Starting ping health check on 192.168.0.50(192.168.0.50:3306)..</span><br><span class="line">Sun Apr 20 19:12:01 2014 - [info] Ping(SELECT) succeeded, waiting until MySQL doesn<span class="string">'t respond..</span></span><br><span class="line"><span class="string">[root@192.168.0.20 ~]#</span></span><br></pre></td></tr></table></figure><br><br>其中”Ping(SELECT) succeeded, waiting until MySQL doesn’t respond..”说明整个系统已经开始监控了。<br><br><strong> 11.关闭MHA Manage监控 </strong><br>关闭很简单，使用masterha_stop命令完成。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@192.168.0.20 ~]<span class="comment"># masterha_stop --conf=/etc/masterha/app1.cnf</span></span><br><span class="line">Stopped app1 successfully.</span><br><span class="line">[1]+  Exit 1                  nohup masterha_manager --conf=/etc/masterha/app1.cnf --remove_dead_master_conf --ignore_last_failover --manager_log=/data/mamanager.log</span><br><span class="line">[root@192.168.0.20 ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure><br><br><strong>  12.配置VIP </strong><br>vip配置可以采用两种方式，一种通过keepalived的方式管理虚拟ip的浮动；另外一种通过脚本方式启动虚拟ip的方式（即不需要keepalived或者heartbeat类似的软件）。<br><strong><em> 1.keepalived方式管理虚拟ip，keepalived配置方法如下：</em></strong><br>（1）下载软件进行并进行安装（两台master，准确的说一台是master，另外一台是备选master，在没有切换以前是slave）：<br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="number">192.168</span>.<span class="number">0.50</span> <span class="symbol">~]# wget http</span>:<span class="comment">//www.keepalived.org/software/keepalived-1.2.12.tar.gz</span></span><br></pre></td></tr></table></figure><br><br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">tar xf keepalived<span class="number">-1.2</span><span class="number">.12</span>.tar.gz           </span><br><span class="line">cd keepalived<span class="number">-1.2</span><span class="number">.12</span></span><br><span class="line">.<span class="regexp">/configure --prefix=/</span>usr<span class="regexp">/local/</span>keepalived</span><br><span class="line">make &amp;&amp;  make install</span><br><span class="line">cp <span class="regexp">/usr/</span>local<span class="regexp">/keepalived/</span>etc<span class="regexp">/rc.d/</span>init.d<span class="regexp">/keepalived /</span>etc<span class="regexp">/init.d/</span></span><br><span class="line">cp <span class="regexp">/usr/</span>local<span class="regexp">/keepalived/</span>etc<span class="regexp">/sysconfig/</span>keepalived <span class="regexp">/etc/</span>sysconfig/</span><br><span class="line">mkdir <span class="regexp">/etc/</span>keepalived</span><br><span class="line">cp <span class="regexp">/usr/</span>local<span class="regexp">/keepalived/</span>etc<span class="regexp">/keepalived/</span>keepalived.conf <span class="regexp">/etc/</span>keepalived/</span><br><span class="line">cp <span class="regexp">/usr/</span>local<span class="regexp">/keepalived/</span>sbin<span class="regexp">/keepalived /</span>usr<span class="regexp">/sbin/</span></span><br></pre></td></tr></table></figure><br><br>（2）配置keepalived的配置文件，在master上配置（192.168.0.50）<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@<span class="number">192.168</span><span class="number">.0</span><span class="number">.50</span> ~]# cat /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">     notification_email &#123;</span><br><span class="line">     saltstack@<span class="number">163.</span>com</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from dba@dbserver.com</span><br><span class="line">   smtp_server <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">   smtp_connect_timeout <span class="number">30</span></span><br><span class="line">   router_id MySQL-HA</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    <span class="section">state</span> BACKUP</span><br><span class="line">    interface eth1</span><br><span class="line">    virtual_router_id <span class="number">51</span></span><br><span class="line">    priority <span class="number">150</span></span><br><span class="line">    advert_int <span class="number">1</span></span><br><span class="line">    nopreempt</span><br><span class="line"></span><br><span class="line">    authentication &#123;</span><br><span class="line">    auth_type PASS</span><br><span class="line">    auth_pass <span class="number">1111</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        <span class="number">192.168</span><span class="number">.0</span><span class="number">.88</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@<span class="number">192.168</span><span class="number">.0</span><span class="number">.50</span> ~]#</span><br></pre></td></tr></table></figure><br><br>其中router_id MySQL HA表示设定keepalived组的名称，将192.168.0.88这个虚拟ip绑定到该主机的eth1网卡上，并且设置了状态为backup模式，将keepalived的模式设置为非抢占模式（nopreempt），priority 150表示设置的优先级为150。下面的配置略有不同，但是都是一个意思。<br>在候选master上配置（192.168.0.60）<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@<span class="number">192.168</span><span class="number">.0</span><span class="number">.60</span> ~]# cat /etc/keepalived/keepalived.conf </span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">     notification_email &#123;</span><br><span class="line">     saltstack@<span class="number">163.</span>com</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from dba@dbserver.com</span><br><span class="line">   smtp_server <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">   smtp_connect_timeout <span class="number">30</span></span><br><span class="line">   router_id MySQL-HA</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    <span class="section">state</span> BACKUP</span><br><span class="line">    interface eth1</span><br><span class="line">    virtual_router_id <span class="number">51</span></span><br><span class="line">    priority <span class="number">120</span></span><br><span class="line">    advert_int <span class="number">1</span></span><br><span class="line">    nopreempt</span><br><span class="line"></span><br><span class="line">    authentication &#123;</span><br><span class="line">    auth_type PASS</span><br><span class="line">    auth_pass <span class="number">1111</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        <span class="number">192.168</span><span class="number">.0</span><span class="number">.88</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@<span class="number">192.168</span><span class="number">.0</span><span class="number">.60</span> ~]#</span><br></pre></td></tr></table></figure><br><br>（3）启动keepalived服务，在master上启动并查看日志<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="string">[root@192.168.0.50</span> <span class="string">~]#</span> <span class="string">/etc/init.d/keepalived</span> <span class="string">start</span></span><br><span class="line"><span class="attr">Starting keepalived:</span>                                       <span class="string">[</span>  <span class="string">OK</span>  <span class="string">]</span></span><br><span class="line"><span class="string">[root@192.168.0.50</span> <span class="string">~]#</span> <span class="string">tail</span> <span class="string">-f</span> <span class="string">/var/log/messages</span></span><br><span class="line"><span class="string">Apr</span> <span class="number">20</span> <span class="number">20</span><span class="string">:22:16</span> <span class="number">192</span> <span class="string">Keepalived_healthcheckers[15334]:</span> <span class="string">Opening</span> <span class="string">file</span> <span class="string">'/etc/keepalived/keepalived.conf'</span><span class="string">.</span></span><br><span class="line"><span class="string">Apr</span> <span class="number">20</span> <span class="number">20</span><span class="string">:22:16</span> <span class="number">192</span> <span class="string">Keepalived_healthcheckers[15334]:</span> <span class="attr">Configuration is using :</span> <span class="number">7231</span> <span class="string">Bytes</span></span><br><span class="line"><span class="attr">Apr 20 20:22:16 192 kernel: IPVS:</span> <span class="string">Connection</span> <span class="string">hash</span> <span class="string">table</span> <span class="string">configured</span> <span class="string">(size=4096,</span> <span class="string">memory=64Kbytes)</span></span><br><span class="line"><span class="attr">Apr 20 20:22:16 192 kernel: IPVS:</span> <span class="string">ipvs</span> <span class="string">loaded.</span></span><br><span class="line"><span class="string">Apr</span> <span class="number">20</span> <span class="number">20</span><span class="string">:22:16</span> <span class="number">192</span> <span class="string">Keepalived_healthcheckers[15334]:</span> <span class="string">Using</span> <span class="string">LinkWatch</span> <span class="string">kernel</span> <span class="string">netlink</span> <span class="string">reflector...</span></span><br><span class="line"><span class="string">Apr</span> <span class="number">20</span> <span class="number">20</span><span class="string">:22:19</span> <span class="number">192</span> <span class="string">Keepalived_vrrp[15335]:</span> <span class="string">VRRP_Instance(VI_1)</span> <span class="string">Transition</span> <span class="string">to</span> <span class="string">MASTER</span> <span class="string">STATE</span></span><br><span class="line"><span class="string">Apr</span> <span class="number">20</span> <span class="number">20</span><span class="string">:22:20</span> <span class="number">192</span> <span class="string">Keepalived_vrrp[15335]:</span> <span class="string">VRRP_Instance(VI_1)</span> <span class="string">Entering</span> <span class="string">MASTER</span> <span class="string">STATE</span></span><br><span class="line"><span class="string">Apr</span> <span class="number">20</span> <span class="number">20</span><span class="string">:22:20</span> <span class="number">192</span> <span class="string">Keepalived_vrrp[15335]:</span> <span class="string">VRRP_Instance(VI_1)</span> <span class="string">setting</span> <span class="string">protocol</span> <span class="string">VIPs.</span></span><br><span class="line"><span class="string">Apr</span> <span class="number">20</span> <span class="number">20</span><span class="string">:22:20</span> <span class="number">192</span> <span class="string">Keepalived_vrrp[15335]:</span> <span class="string">VRRP_Instance(VI_1)</span> <span class="string">Sending</span> <span class="string">gratuitous</span> <span class="string">ARPs</span> <span class="string">on</span> <span class="string">eth1</span> <span class="string">for</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.88</span></span><br><span class="line"><span class="string">Apr</span> <span class="number">20</span> <span class="number">20</span><span class="string">:22:20</span> <span class="number">192</span> <span class="string">Keepalived_healthcheckers[15334]:</span> <span class="string">Netlink</span> <span class="string">reflector</span> <span class="string">reports</span> <span class="string">IP</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.88</span> <span class="string">added</span></span><br><span class="line"><span class="string">Apr</span> <span class="number">20</span> <span class="number">20</span><span class="string">:22:25</span> <span class="number">192</span> <span class="string">Keepalived_vrrp[15335]:</span> <span class="string">VRRP_Instance(VI_1)</span> <span class="string">Sending</span> <span class="string">gratuitous</span> <span class="string">ARPs</span> <span class="string">on</span> <span class="string">eth1</span> <span class="string">for</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.88</span></span><br></pre></td></tr></table></figure><br><br>发现已经将虚拟ip 192.168.0.88绑定了网卡eth1上。<br>（4）查看绑定情况<br><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="number">192.168</span>.<span class="number">0.50</span> ~]<span class="comment"># ip addr | grep eth1</span></span><br><span class="line"><span class="number">3</span>: eth1: <span class="variable">&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span> mtu <span class="number">1500</span> qdisc pfifo_fast <span class="keyword">state</span> UP qlen <span class="number">1000</span></span><br><span class="line">    <span class="keyword">inet</span> <span class="number">192.168</span>.<span class="number">0.50</span>/<span class="number">24</span> brd <span class="number">192.168</span>.<span class="number">0.255</span> scope <span class="keyword">global</span> eth1</span><br><span class="line">    <span class="keyword">inet</span> <span class="number">192.168</span>.<span class="number">0.88</span>/<span class="number">32</span> scope <span class="keyword">global</span> eth1</span><br><span class="line">[root@<span class="number">192.168</span>.<span class="number">0.50</span> ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure><br><br>在另外一台服务器，候选master上启动keepalived服务，并观察<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@192.168.0.60 ~]# /etc/init.d/keepalived start ; tail -f /var/log/messages</span><br><span class="line">Starting keepalived:                                       [  OK  ]</span><br><span class="line">Apr 20 20:26:18 192 Keepalived_vrrp[9472]: Registering gratuitous ARP shared channel</span><br><span class="line">Apr 20 20:26:18 192 Keepalived_vrrp[9472]: Opening file <span class="string">'/etc/keepalived/keepalived.conf'</span>.</span><br><span class="line">Apr 20 20:26:18 192 Keepalived_vrrp[9472]: Configuration is using : 62976 Bytes</span><br><span class="line">Apr 20 20:26:18 192 Keepalived_vrrp[9472]: Using LinkWatch kernel netlink reflector<span class="built_in">..</span>.</span><br><span class="line">Apr 20 20:26:18 192 Keepalived_vrrp[9472]: VRRP_Instance(VI_1) Entering BACKUP STATE</span><br><span class="line">Apr 20 20:26:18 192 Keepalived_vrrp[9472]:<span class="built_in"> VRRP </span>sockpool: [ifindex(3), proto(112), unicast(0), fd(10,11)]</span><br><span class="line">Apr 20 20:26:18 192 Keepalived_healthcheckers[9471]: Netlink reflector reports<span class="built_in"> IP </span>192.168.80.138 added</span><br><span class="line">Apr 20 20:26:18 192 Keepalived_healthcheckers[9471]: Netlink reflector reports<span class="built_in"> IP </span>192.168.0.60 added</span><br><span class="line">Apr 20 20:26:18 192 Keepalived_healthcheckers[9471]: Netlink reflector reports<span class="built_in"> IP </span>fe80::20c:29ff:fe9d:6a9e added</span><br><span class="line">Apr 20 20:26:18 192 Keepalived_healthcheckers[9471]: Netlink reflector reports<span class="built_in"> IP </span>fe80::20c:29ff:fe9d:6aa8 added</span><br><span class="line">Apr 20 20:26:18 192 Keepalived_healthcheckers[9471]: Registering Kernel netlink reflector</span><br><span class="line">Apr 20 20:26:18 192 Keepalived_healthcheckers[9471]: Registering Kernel netlink command channel</span><br><span class="line">Apr 20 20:26:18 192 Keepalived_healthcheckers[9471]: Opening file <span class="string">'/etc/keepalived/keepalived.conf'</span>.</span><br><span class="line">Apr 20 20:26:18 192 Keepalived_healthcheckers[9471]: Configuration is using : 7231 Bytes</span><br><span class="line">Apr 20 20:26:18 192 kernel: IPVS: Registered protocols (TCP, UDP, AH, ESP)</span><br><span class="line">Apr 20 20:26:18 192 kernel: IPVS:<span class="built_in"> Connection </span>hash table configured (<span class="attribute">size</span>=4096, <span class="attribute">memory</span>=64Kbytes)</span><br><span class="line">Apr 20 20:26:18 192 kernel: IPVS: ipvs loaded.</span><br><span class="line">Apr 20 20:26:18 192 Keepalived_healthcheckers[9471]: Using LinkWatch kernel netlink reflector<span class="built_in">..</span>.</span><br></pre></td></tr></table></figure><br><br>从上面的信息可以看到keepalived已经配置成功。<br><font color="red">注意：</font><br><font color="red">上面两台服务器的keepalived都设置为了BACKUP模式，在keepalived中2种模式，分别是master-&gt;backup模式和backup-&gt;backup模式。这两种模式有很大区别。在master-&gt;backup模式下，一旦主库宕机，虚拟ip会自动漂移到从库，当主库修复后，keepalived启动后，还会把虚拟ip抢占过来，即使设置了非抢占模式（nopreempt）抢占ip的动作也会发生。在backup-&gt;backup模式下，当主库宕机后虚拟ip会自动漂移到从库上，当原主库恢复和keepalived服务启动后，并不会抢占新主的虚拟ip，即使是优先级高于从库的优先级别，也不会发生抢占。为了减少ip漂移次数，通常是把修复好的主库当做新的备库。</font>

<p>（5）MHA引入keepalived（MySQL服务进程挂掉时通过MHA 停止keepalived）:</p>
<p>要想把keepalived服务引入MHA，我们只需要修改切换是触发的脚本文件master_ip_failover即可，在该脚本中添加在master发生宕机时对keepalived的处理。</p>
<p>编辑脚本/usr/local/bin/master_ip_failover，修改后如下，我对perl不熟悉，所以我这里完整贴出该脚本（主库上操作，192.168.0.50）。</p>
<p>在MHA Manager修改脚本修改后的内容如下（参考资料比较少）：<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#!/usr/bin/env perl</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> strict;</span><br><span class="line"><span class="keyword">use</span> warnings <span class="string">FATAL =&gt;</span> <span class="string">'all'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> Getopt::Long;</span><br><span class="line"></span><br><span class="line"><span class="keyword">my</span> (</span><br><span class="line">    $command,          $ssh_user,        $orig_master_host, $orig_master_ip,</span><br><span class="line">    $orig_master_port, $new_master_host, $new_master_ip,    $new_master_port</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">my</span> $vip = <span class="string">'192.168.0.88'</span>;</span><br><span class="line"><span class="keyword">my</span> $ssh_start_vip = <span class="string">"/etc/init.d/keepalived start"</span>;</span><br><span class="line"><span class="keyword">my</span> $ssh_stop_vip = <span class="string">"/etc/init.d/keepalived stop"</span>;</span><br><span class="line"></span><br><span class="line">GetOptions(</span><br><span class="line">    <span class="string">'command=s'</span>          =&gt; \$command,</span><br><span class="line">    <span class="string">'ssh_user=s'</span>         =&gt; \$ssh_user,</span><br><span class="line">    <span class="string">'orig_master_host=s'</span> =&gt; \$orig_master_host,</span><br><span class="line">    <span class="string">'orig_master_ip=s'</span>   =&gt; \$orig_master_ip,</span><br><span class="line">    <span class="string">'orig_master_port=i'</span> =&gt; \$orig_master_port,</span><br><span class="line">    <span class="string">'new_master_host=s'</span>  =&gt; \$new_master_host,</span><br><span class="line">    <span class="string">'new_master_ip=s'</span>    =&gt; \$new_master_ip,</span><br><span class="line">    <span class="string">'new_master_port=i'</span>  =&gt; \$new_master_port,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">exit</span> &amp;main();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">main</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"\n\nIN SCRIPT TEST====$ssh_stop_vip==$ssh_start_vip===\n\n"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( $command eq <span class="string">"stop"</span> || $command eq <span class="string">"stopssh"</span> ) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">my</span> $exit_code = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">eval</span> &#123;</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"Disabling the VIP on old master: $orig_master_host \n"</span>;</span><br><span class="line">            &amp;stop_vip();</span><br><span class="line">            $exit_code = <span class="number">0</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> ($@) &#123;</span><br><span class="line">            <span class="keyword">warn</span> <span class="string">"Got Error: $@\n"</span>;</span><br><span class="line">            <span class="keyword">exit</span> $exit_code;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">exit</span> $exit_code;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">elsif</span> ( $command eq <span class="string">"start"</span> ) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">my</span> $exit_code = <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">eval</span> &#123;</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"Enabling the VIP - $vip on the new master - $new_master_host \n"</span>;</span><br><span class="line">            &amp;start_vip();</span><br><span class="line">            $exit_code = <span class="number">0</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> ($@) &#123;</span><br><span class="line">            <span class="keyword">warn</span> $@;</span><br><span class="line">            <span class="keyword">exit</span> $exit_code;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">exit</span> $exit_code;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">elsif</span> ( $command eq <span class="string">"status"</span> ) &#123;</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Checking the Status of the script.. OK \n"</span>;</span><br><span class="line">        <span class="comment">#`ssh $ssh_user\@cluster1 \" $ssh_start_vip \"`;</span></span><br><span class="line">        <span class="keyword">exit</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        &amp;usage();</span><br><span class="line">        <span class="keyword">exit</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># A simple system call that enable the VIP on the new master</span></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">start_vip</span>() </span>&#123;</span><br><span class="line">    <span class="string">`ssh $ssh_user\@$new_master_host \" $ssh_start_vip \"`</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># A simple system call that disable the VIP on the old_master</span></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">stop_vip</span>() </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="number">0</span>  <span class="keyword">unless</span>  ($ssh_user);</span><br><span class="line">    <span class="string">`ssh $ssh_user\@$orig_master_host \" $ssh_stop_vip \"`</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">usage</span> </span>&#123;</span><br><span class="line">    <span class="keyword">print</span></span><br><span class="line">    <span class="string">"Usage: master_ip_failover --command=start|stop|stopssh|status --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\n"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>现在已经修改这个脚本了，我们现在打开在上面提到过的参数，再检查集群状态，看是否会报错。<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@192</span><span class="number">.168</span><span class="number">.0</span><span class="number">.20</span> ~]<span class="meta"># grep <span class="string">'master_ip_failover_script'</span> /etc/masterha/app1.cnf</span></span><br><span class="line">master_ip_failover_script= /usr/<span class="keyword">local</span>/bin/master_ip_failover</span><br><span class="line">[root<span class="symbol">@192</span><span class="number">.168</span><span class="number">.0</span><span class="number">.20</span> ~]<span class="meta">#</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@192.168.0.20 ~]# masterha_check_repl <span class="attribute">--conf</span>=/etc/masterha/app1.cnf  </span><br><span class="line">Sun Apr 20 23:10:01 2014 - [<span class="builtin-name">info</span>] Slaves<span class="built_in"> settings </span>check done.</span><br><span class="line">Sun Apr 20 23:10:01 2014 - [<span class="builtin-name">info</span>] </span><br><span class="line">192.168.0.50 (current master)</span><br><span class="line"> +--192.168.0.60</span><br><span class="line"> +--192.168.0.70</span><br><span class="line"></span><br><span class="line">Sun Apr 20 23:10:01 2014 - [<span class="builtin-name">info</span>] Checking replication<span class="built_in"> health </span>on 192.168.0.60<span class="built_in">..</span></span><br><span class="line">Sun Apr 20 23:10:01 2014 - [<span class="builtin-name">info</span>]  ok.</span><br><span class="line">Sun Apr 20 23:10:01 2014 - [<span class="builtin-name">info</span>] Checking replication<span class="built_in"> health </span>on 192.168.0.70<span class="built_in">..</span></span><br><span class="line">Sun Apr 20 23:10:01 2014 - [<span class="builtin-name">info</span>]  ok.</span><br><span class="line">Sun Apr 20 23:10:01 2014 - [<span class="builtin-name">info</span>] Checking master_ip_failover_script status:</span><br><span class="line">Sun Apr 20 23:10:01 2014 - [<span class="builtin-name">info</span>]   /usr/local/bin/master_ip_failover <span class="attribute">--command</span>=status <span class="attribute">--ssh_user</span>=root <span class="attribute">--orig_master_host</span>=192.168.0.50 <span class="attribute">--orig_master_ip</span>=192.168.0.50 <span class="attribute">--orig_master_port</span>=3306 </span><br><span class="line">Sun Apr 20 23:10:01 2014 - [<span class="builtin-name">info</span>]  OK.</span><br><span class="line">Sun Apr 20 23:10:01 2014 - [<span class="builtin-name">warning</span>] shutdown_script is <span class="keyword">not</span> defined.</span><br><span class="line">Sun Apr 20 23:10:01 2014 - [<span class="builtin-name">info</span>] Got exit code 0 (<span class="keyword">Not</span> master dead).</span><br><span class="line"></span><br><span class="line">MySQL Replication<span class="built_in"> Health </span>is OK.</span><br></pre></td></tr></table></figure>
<p>可以看见已经没有报错了。哈哈<br> /usr/local/bin/master_ip_failover添加或者修改的内容意思是当主库数据库发生故障时，会触发MHA切换，MHA Manager会停掉主库上的keepalived服务，触发虚拟ip漂移到备选从库，从而完成切换。当然可以在keepalived里面引入脚本，这个脚本监控mysql是否正常运行，如果不正常，则调用该脚本杀掉keepalived进程。</p>
<h4 id="2-通过脚本的方式管理VIP"><a href="#2-通过脚本的方式管理VIP" class="headerlink" title="2.通过脚本的方式管理VIP"></a>2.通过脚本的方式管理VIP</h4><p><strong>这里是修改/usr/local/bin/master_ip_failover，也可以使用其他的语言完成，比如php语言。使用php脚本编写的failover这里就不介绍了。修改完成后内容如下，而且如果使用脚本管理vip的话，需要手动在master服务器上绑定一个vip</strong><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@192.168.0.50</span> <span class="string">~]#</span> <span class="string">/sbin/ifconfig</span> <span class="string">eth1:1</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.88</span><span class="string">/24</span></span><br></pre></td></tr></table></figure></p>
<p>通过脚本来维护vip的测试我这里就不说明了，童鞋们自行测试，脚本如下（测试通过）<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#!/usr/bin/env perl</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> strict;</span><br><span class="line"><span class="keyword">use</span> warnings <span class="string">FATAL =&gt;</span> <span class="string">'all'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> Getopt::Long;</span><br><span class="line"></span><br><span class="line"><span class="keyword">my</span> (</span><br><span class="line">    $command,          $ssh_user,        $orig_master_host, $orig_master_ip,</span><br><span class="line">    $orig_master_port, $new_master_host, $new_master_ip,    $new_master_port</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">my</span> $vip = <span class="string">'192.168.0.88/24'</span>;</span><br><span class="line"><span class="keyword">my</span> $key = <span class="string">'1'</span>;</span><br><span class="line"><span class="keyword">my</span> $ssh_start_vip = <span class="string">"/sbin/ifconfig eth1:$key $vip"</span>;</span><br><span class="line"><span class="keyword">my</span> $ssh_stop_vip = <span class="string">"/sbin/ifconfig eth1:$key down"</span>;</span><br><span class="line"></span><br><span class="line">GetOptions(</span><br><span class="line">    <span class="string">'command=s'</span>          =&gt; \$command,</span><br><span class="line">    <span class="string">'ssh_user=s'</span>         =&gt; \$ssh_user,</span><br><span class="line">    <span class="string">'orig_master_host=s'</span> =&gt; \$orig_master_host,</span><br><span class="line">    <span class="string">'orig_master_ip=s'</span>   =&gt; \$orig_master_ip,</span><br><span class="line">    <span class="string">'orig_master_port=i'</span> =&gt; \$orig_master_port,</span><br><span class="line">    <span class="string">'new_master_host=s'</span>  =&gt; \$new_master_host,</span><br><span class="line">    <span class="string">'new_master_ip=s'</span>    =&gt; \$new_master_ip,</span><br><span class="line">    <span class="string">'new_master_port=i'</span>  =&gt; \$new_master_port,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">exit</span> &amp;main();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">main</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"\n\nIN SCRIPT TEST====$ssh_stop_vip==$ssh_start_vip===\n\n"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( $command eq <span class="string">"stop"</span> || $command eq <span class="string">"stopssh"</span> ) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">my</span> $exit_code = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">eval</span> &#123;</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"Disabling the VIP on old master: $orig_master_host \n"</span>;</span><br><span class="line">            &amp;stop_vip();</span><br><span class="line">            $exit_code = <span class="number">0</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> ($@) &#123;</span><br><span class="line">            <span class="keyword">warn</span> <span class="string">"Got Error: $@\n"</span>;</span><br><span class="line">            <span class="keyword">exit</span> $exit_code;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">exit</span> $exit_code;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">elsif</span> ( $command eq <span class="string">"start"</span> ) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">my</span> $exit_code = <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">eval</span> &#123;</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"Enabling the VIP - $vip on the new master - $new_master_host \n"</span>;</span><br><span class="line">            &amp;start_vip();</span><br><span class="line">            $exit_code = <span class="number">0</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> ($@) &#123;</span><br><span class="line">            <span class="keyword">warn</span> $@;</span><br><span class="line">            <span class="keyword">exit</span> $exit_code;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">exit</span> $exit_code;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">elsif</span> ( $command eq <span class="string">"status"</span> ) &#123;</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Checking the Status of the script.. OK \n"</span>;</span><br><span class="line">        <span class="keyword">exit</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        &amp;usage();</span><br><span class="line">        <span class="keyword">exit</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">start_vip</span>() </span>&#123;</span><br><span class="line">    <span class="string">`ssh $ssh_user\@$new_master_host \" $ssh_start_vip \"`</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">stop_vip</span>() </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="number">0</span>  <span class="keyword">unless</span>  ($ssh_user);</span><br><span class="line">    <span class="string">`ssh $ssh_user\@$orig_master_host \" $ssh_stop_vip \"`</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">usage</span> </span>&#123;</span><br><span class="line">    <span class="keyword">print</span></span><br><span class="line">    <span class="string">"Usage: master_ip_failover --command=start|stop|stopssh|status --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\n"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>为了防止脑裂发生，推荐生产环境采用脚本的方式来管理虚拟ip，而不是使用keepalived来完成。到此为止，基本MHA集群已经配置完毕。接下来就是实际的测试环节了。通过一些测试来看一下MHA到底是如何进行工作的。下面将从MHA自动failover，我们手动failover，在线切换三种方式来介绍MHA的工作情况。</p>
<h2 id="一-自动Failover"><a href="#一-自动Failover" class="headerlink" title="一.自动Failover"></a>一.自动Failover</h2><p>（<font color="red">必须先启动MHA Manager，否则无法自动切换，当然手动切换不需要开启MHA Manager监控。</font>各位童鞋请参考前面启动MHA Manager）</p>
<p>测试环境再次贴一下，文章太长，自己都搞晕了。<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">角色                    ip地址          主机名          server_id               类型</span><br><span class="line">Monitor host            <span class="number">192.168</span><span class="number">.0</span><span class="number">.20</span>    server01            -                   监控复制组</span><br><span class="line">Master                  <span class="number">192.168</span><span class="number">.0</span><span class="number">.50</span>    server02            <span class="number">1</span>                   写入</span><br><span class="line">Candicate master        <span class="number">192.168</span><span class="number">.0</span><span class="number">.60</span>    server03            <span class="number">2</span>                   读</span><br><span class="line">Slave                   <span class="number">192.168</span><span class="number">.0</span><span class="number">.70</span>    server04            <span class="number">3</span>                   读</span><br></pre></td></tr></table></figure></p>
<p>自动failover模拟测试的操作步骤如下。<br>（1）使用sysbench生成测试数据（使用yum快速安装）<br><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span> sysbench -y</span><br></pre></td></tr></table></figure></p>
<p>在主库（192.168.0.50）上进行sysbench数据生成，在sbtest库下生成sbtest表，共100W记录。<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@192.168.0.50 ~]# sysbench <span class="attribute">--test</span>=oltp <span class="attribute">--oltp-table-size</span>=1000000 <span class="attribute">--oltp-read-only</span>=off <span class="attribute">--init-rng</span>=on <span class="attribute">--num-threads</span>=16 <span class="attribute">--max-requests</span>=0 <span class="attribute">--oltp-dist-type</span>=uniform <span class="attribute">--max-time</span>=1800 <span class="attribute">--mysql-user</span>=root <span class="attribute">--mysql-socket</span>=/tmp/mysql.sock <span class="attribute">--mysql-password</span>=123456 <span class="attribute">--db-driver</span>=mysql <span class="attribute">--mysql-table-engine</span>=innodb <span class="attribute">--oltp-test-mode</span>=complex prepare</span><br></pre></td></tr></table></figure></p>
<p>（2）停掉slave sql线程，模拟主从延时。（192.168.0.60）<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="literal">stop</span> <span class="literal">slave</span> io_thread;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.08</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure></p>
<p>另外一台slave我们没有停止io线程，所以还在继续接收日志。</p>
<p>（3）模拟sysbench压力测试。</p>
<p>在主库上（192.168.0.50）进行压力测试，持续时间为3分钟，产生大量的binlog。<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@192.168.0.50 ~]# sysbench <span class="attribute">--test</span>=oltp <span class="attribute">--oltp-table-size</span>=1000000 <span class="attribute">--oltp-read-only</span>=off <span class="attribute">--init-rng</span>=on <span class="attribute">--num-threads</span>=16 <span class="attribute">--max-requests</span>=0 <span class="attribute">--oltp-dist-type</span>=uniform <span class="attribute">--max-time</span>=180 <span class="attribute">--mysql-user</span>=root <span class="attribute">--mysql-socket</span>=/tmp/mysql.sock <span class="attribute">--mysql-password</span>=123456 <span class="attribute">--db-driver</span>=mysql <span class="attribute">--mysql-table-engine</span>=innodb <span class="attribute">--oltp-test-mode</span>=complex <span class="builtin-name">run</span> </span><br><span class="line">sysbench 0.4.12:  multi-threaded<span class="built_in"> system </span>evaluation benchmark</span><br><span class="line"></span><br><span class="line">Running the test with following options:</span><br><span class="line">Number of threads: 16</span><br><span class="line">Initializing random number generator <span class="keyword">from</span> timer.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Doing OLTP test.</span><br><span class="line">Running mixed OLTP test</span><br><span class="line">Using Uniform distribution</span><br><span class="line">Using <span class="string">"BEGIN"</span> <span class="keyword">for</span> starting transactions</span><br><span class="line">Using auto_inc on the id column</span><br><span class="line">Threads started!</span><br><span class="line">Time limit exceeded, exiting<span class="built_in">..</span>.</span><br><span class="line">(last message repeated 15 times)</span><br><span class="line">Done.</span><br><span class="line"></span><br><span class="line">OLTP test statistics:</span><br><span class="line">    queries performed:</span><br><span class="line">        read:                            15092</span><br><span class="line">        write:                           5390</span><br><span class="line">        other:                           2156</span><br><span class="line">        total:                           22638</span><br><span class="line">    transactions:                        1078   (5.92 per sec.)</span><br><span class="line">    deadlocks:                           0      (0.00 per sec.)</span><br><span class="line">    read/write requests:                 20482  (112.56 per sec.)</span><br><span class="line">    other operations:                    2156   (11.85 per sec.)</span><br><span class="line"></span><br><span class="line">Test execution summary:</span><br><span class="line">    total time:                          181.9728s</span><br><span class="line">    total number of events:              1078</span><br><span class="line">    total time taken by event execution: 2910.4518</span><br><span class="line">    per-request statistics:</span><br><span class="line">         min:                                934.29ms</span><br><span class="line">         avg:                               2699.86ms</span><br><span class="line">         max:                               7679.95ms</span><br><span class="line">         approx.  95 percentile:            4441.47ms</span><br><span class="line"></span><br><span class="line">Threads fairness:</span><br><span class="line">    events (avg/stddev):           67.3750/1.49</span><br><span class="line">    execution time (avg/stddev):   181.9032/0.11</span><br></pre></td></tr></table></figure></p>
<p>（4）开启slave（192.168.0.60）上的IO线程，追赶落后于master的binlog。<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="literal">start</span> <span class="literal">slave</span> io_thread;     </span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure></p>
<p>（5）杀掉主库mysql进程，模拟主库发生故障，进行自动failover操作。<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="number">192.168</span><span class="number">.0</span><span class="number">.50</span> ~]# pkill <span class="number">-9</span> mysqld</span><br></pre></td></tr></table></figure></p>
<p>（6）查看MHA切换日志，了解整个切换过程，在192.168.0.20上查看日志：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br></pre></td><td class="code"><pre><span class="line">[root@192.168.0.20 ~]# cat /var/log/masterha/app1/manager.log </span><br><span class="line">Mon Apr 21 20:15:45 2014 - [<span class="builtin-name">warning</span>] Got <span class="builtin-name">error</span> on MySQL select ping: 2006 (MySQL<span class="built_in"> server </span>has gone away)</span><br><span class="line">Mon Apr 21 20:15:45 2014 - [<span class="builtin-name">info</span>] Executing seconary<span class="built_in"> network </span>check script: /usr/local/bin/masterha_secondary_check -s server03 -s server02 <span class="attribute">--user</span>=root <span class="attribute">--master_host</span>=server02 <span class="attribute">--master_ip</span>=192.168.0.50 --master_  Creating /tmp <span class="keyword">if</span> <span class="keyword">not</span> exists<span class="built_in">..</span>    ok.</span><br><span class="line">  Checking output directory is accessible <span class="keyword">or</span> <span class="keyword">not</span><span class="built_in">..</span></span><br><span class="line">   ok.</span><br><span class="line">  Binlog found at /data/mysql, up <span class="keyword">to</span> mysql-bin.000018</span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">warning</span>] Global configuration file /etc/masterha_default.cnf <span class="keyword">not</span> found. Skipping.</span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">info</span>] Reading application<span class="built_in"> default </span>configurations <span class="keyword">from</span> /etc/masterha/app1.cnf<span class="built_in">..</span></span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">info</span>] Reading<span class="built_in"> server </span>configurations <span class="keyword">from</span> /etc/masterha/app1.cnf<span class="built_in">..</span></span><br><span class="line">ble <span class="keyword">from</span> server03. OK.</span><br><span class="line">Monitoring<span class="built_in"> server </span>server02 is reachable, Master is <span class="keyword">not</span> reachable <span class="keyword">from</span> server02. OK.</span><br><span class="line">Mon Apr 21 20:15:46 2014 - [<span class="builtin-name">info</span>] Master is <span class="keyword">not</span> reachable <span class="keyword">from</span> all other monitoring servers. Failover should start.</span><br><span class="line">Mon Apr 21 20:15:46 2014 - [<span class="builtin-name">warning</span>] Got <span class="builtin-name">error</span> on MySQL connect: 2013 (Lost<span class="built_in"> connection </span><span class="keyword">to</span> MySQL<span class="built_in"> server </span>at <span class="string">'reading initial communication packet'</span>,<span class="built_in"> system </span>error: 111)</span><br><span class="line">Mon Apr 21 20:15:46 2014 - [<span class="builtin-name">warning</span>]<span class="built_in"> Connection </span>failed 1 time(s)<span class="built_in">..</span></span><br><span class="line">Mon Apr 21 20:15:47 2014 - [<span class="builtin-name">warning</span>] Got <span class="builtin-name">error</span> on MySQL connect: 2013 (Lost<span class="built_in"> connection </span><span class="keyword">to</span> MySQL<span class="built_in"> server </span>at <span class="string">'reading initial communication packet'</span>,<span class="built_in"> system </span>error: 111)</span><br><span class="line">Mon Apr 21 20:15:47 2014 - [<span class="builtin-name">warning</span>]<span class="built_in"> Connection </span>failed 2 time(s)<span class="built_in">..</span></span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">warning</span>] Got <span class="builtin-name">error</span> on MySQL connect: 2013 (Lost<span class="built_in"> connection </span><span class="keyword">to</span> MySQL<span class="built_in"> server </span>at <span class="string">'reading initial communication packet'</span>,<span class="built_in"> system </span>error: 111)</span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">warning</span>]<span class="built_in"> Connection </span>failed 3 time(s)<span class="built_in">..</span></span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">warning</span>] Master is <span class="keyword">not</span> reachable <span class="keyword">from</span><span class="built_in"> health </span>checker!</span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">warning</span>] Master 192.168.0.50(192.168.0.50:3306) is <span class="keyword">not</span> reachable!</span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">warning</span>] SSH is reachable.</span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">info</span>] Connecting <span class="keyword">to</span> a master<span class="built_in"> server </span>failed. Reading configuration file /etc/masterha_default.cnf <span class="keyword">and</span> /etc/masterha/app1.cnf again, <span class="keyword">and</span> trying <span class="keyword">to</span> connect <span class="keyword">to</span> all servers <span class="keyword">to</span> check<span class="built_in"> server </span>status<span class="built_in">..</span></span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">warning</span>] Global configuration file /etc/masterha_default.cnf <span class="keyword">not</span> found. Skipping.</span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">info</span>] Reading application<span class="built_in"> default </span>configurations <span class="keyword">from</span> /etc/masterha/app1.cnf<span class="built_in">..</span></span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">info</span>] Reading<span class="built_in"> server </span>configurations <span class="keyword">from</span> /etc/masterha/app1.cnf<span class="built_in">..</span></span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">info</span>] Dead Servers:</span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">info</span>]   192.168.0.50(192.168.0.50:3306)</span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">info</span>] Alive Servers:</span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">info</span>]   192.168.0.60(192.168.0.60:3306)</span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">info</span>]   192.168.0.70(192.168.0.70:3306)</span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">info</span>] Alive Slaves:</span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">info</span>]   192.168.0.60(192.168.0.60:3306)  <span class="attribute">Version</span>=5.5.19-ndb-7.2.4-gpl-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">info</span>]     Replicating <span class="keyword">from</span> 192.168.0.50(192.168.0.50:3306)</span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">info</span>]     Primary candidate <span class="keyword">for</span> the new Master (candidate_master is set)</span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">info</span>]   192.168.0.70(192.168.0.70:3306)  <span class="attribute">Version</span>=5.5.19-ndb-7.2.4-gpl-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">info</span>]     Replicating <span class="keyword">from</span> 192.168.0.50(192.168.0.50:3306)</span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">info</span>] Checking slave configurations<span class="built_in">..</span></span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">info</span>] Checking replication filtering settings<span class="built_in">..</span></span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">info</span>]  Replication filtering check ok.</span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">info</span>] Master is down!</span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">info</span>] Terminating monitoring script.</span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">info</span>] Got exit code 20 (Master dead).</span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">info</span>] MHA::MasterFailover version 0.53.</span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">info</span>] Starting master failover.</span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">info</span>] </span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">info</span>] * Phase 1: Configuration Check Phase<span class="built_in">..</span></span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">info</span>] </span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">info</span>] Dead Servers:</span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">info</span>]   192.168.0.50(192.168.0.50:3306)</span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">info</span>] Checking master reachability via mysql(double check)<span class="built_in">..</span></span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">info</span>]  ok.</span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">info</span>] Alive Servers:</span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">info</span>]   192.168.0.60(192.168.0.60:3306)</span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">info</span>]   192.168.0.70(192.168.0.70:3306)</span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">info</span>] Alive Slaves:</span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">info</span>]   192.168.0.60(192.168.0.60:3306)  <span class="attribute">Version</span>=5.5.19-ndb-7.2.4-gpl-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">info</span>]     Replicating <span class="keyword">from</span> 192.168.0.50(192.168.0.50:3306)</span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">info</span>]     Primary candidate <span class="keyword">for</span> the new Master (candidate_master is set)</span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">info</span>]   192.168.0.70(192.168.0.70:3306)  <span class="attribute">Version</span>=5.5.19-ndb-7.2.4-gpl-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Apr 21 20:15:48 2014 - [<span class="builtin-name">info</span>]     Replicating <span class="keyword">from</span> 192.168.0.50(192.168.0.50:3306)</span><br><span class="line">Mon Apr 21 20:15:49 2014 - [<span class="builtin-name">info</span>] ** Phase 1: Configuration Check Phase completed.</span><br><span class="line">Mon Apr 21 20:15:49 2014 - [<span class="builtin-name">info</span>] </span><br><span class="line">Mon Apr 21 20:15:49 2014 - [<span class="builtin-name">info</span>] * Phase 2: Dead Master Shutdown Phase<span class="built_in">..</span></span><br><span class="line">Mon Apr 21 20:15:49 2014 - [<span class="builtin-name">info</span>] </span><br><span class="line">Mon Apr 21 20:15:49 2014 - [<span class="builtin-name">info</span>] Forcing shutdown so that applications never connect <span class="keyword">to</span> the current master<span class="built_in">..</span></span><br><span class="line">Mon Apr 21 20:15:49 2014 - [<span class="builtin-name">info</span>] Executing master<span class="built_in"> IP </span>deactivatation script:</span><br><span class="line">Mon Apr 21 20:15:49 2014 - [<span class="builtin-name">info</span>]   /usr/local/bin/master_ip_failover <span class="attribute">--orig_master_host</span>=192.168.0.50 <span class="attribute">--orig_master_ip</span>=192.168.0.50 <span class="attribute">--orig_master_port</span>=3306 <span class="attribute">--command</span>=stopssh <span class="attribute">--ssh_user</span>=root  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">IN</span><span class="built_in"> SCRIPT </span><span class="attribute">TEST</span>====/etc/init.d/keepalived <span class="attribute">stop</span>==/etc/init.d/keepalived <span class="attribute">start</span>===</span><br><span class="line"></span><br><span class="line">Disabling the VIP on old master: 192.168.0.50 </span><br><span class="line">Mon Apr 21 20:15:49 2014 - [<span class="builtin-name">info</span>]  done.</span><br><span class="line">Mon Apr 21 20:15:49 2014 - [<span class="builtin-name">warning</span>] shutdown_script is <span class="keyword">not</span> set. Skipping explicit shutting down of the dead master.</span><br><span class="line">Mon Apr 21 20:15:49 2014 - [<span class="builtin-name">info</span>] * Phase 2: Dead Master Shutdown Phase completed.</span><br><span class="line">Mon Apr 21 20:15:49 2014 - [<span class="builtin-name">info</span>] </span><br><span class="line">Mon Apr 21 20:15:49 2014 - [<span class="builtin-name">info</span>] * Phase 3: Master Recovery Phase<span class="built_in">..</span></span><br><span class="line">Mon Apr 21 20:15:49 2014 - [<span class="builtin-name">info</span>] </span><br><span class="line">Mon Apr 21 20:15:49 2014 - [<span class="builtin-name">info</span>] * Phase 3.1: Getting Latest Slaves Phase<span class="built_in">..</span></span><br><span class="line">Mon Apr 21 20:15:49 2014 - [<span class="builtin-name">info</span>] </span><br><span class="line">Mon Apr 21 20:15:49 2014 - [<span class="builtin-name">info</span>] The latest binary log file/position on all slaves is mysql-bin.000018:112</span><br><span class="line">Mon Apr 21 20:15:49 2014 - [<span class="builtin-name">info</span>] Latest slaves (Slaves that received relay log files <span class="keyword">to</span> the latest):</span><br><span class="line">Mon Apr 21 20:15:49 2014 - [<span class="builtin-name">info</span>]   192.168.0.60(192.168.0.60:3306)  <span class="attribute">Version</span>=5.5.19-ndb-7.2.4-gpl-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Apr 21 20:15:49 2014 - [<span class="builtin-name">info</span>]     Replicating <span class="keyword">from</span> 192.168.0.50(192.168.0.50:3306)</span><br><span class="line">Mon Apr 21 20:15:49 2014 - [<span class="builtin-name">info</span>]     Primary candidate <span class="keyword">for</span> the new Master (candidate_master is set)</span><br><span class="line">Mon Apr 21 20:15:49 2014 - [<span class="builtin-name">info</span>]   192.168.0.70(192.168.0.70:3306)  <span class="attribute">Version</span>=5.5.19-ndb-7.2.4-gpl-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Apr 21 20:15:49 2014 - [<span class="builtin-name">info</span>]     Replicating <span class="keyword">from</span> 192.168.0.50(192.168.0.50:3306)</span><br><span class="line">Mon Apr 21 20:15:49 2014 - [<span class="builtin-name">info</span>] The oldest binary log file/position on all slaves is mysql-bin.000018:112</span><br><span class="line">Mon Apr 21 20:15:49 2014 - [<span class="builtin-name">info</span>] Oldest slaves:</span><br><span class="line">Mon Apr 21 20:15:49 2014 - [<span class="builtin-name">info</span>]   192.168.0.60(192.168.0.60:3306)  <span class="attribute">Version</span>=5.5.19-ndb-7.2.4-gpl-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Apr 21 20:15:49 2014 - [<span class="builtin-name">info</span>]     Replicating <span class="keyword">from</span> 192.168.0.50(192.168.0.50:3306)</span><br><span class="line">Mon Apr 21 20:15:49 2014 - [<span class="builtin-name">info</span>]     Primary candidate <span class="keyword">for</span> the new Master (candidate_master is set)</span><br><span class="line">Mon Apr 21 20:15:49 2014 - [<span class="builtin-name">info</span>]   192.168.0.70(192.168.0.70:3306)  <span class="attribute">Version</span>=5.5.19-ndb-7.2.4-gpl-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Apr 21 20:15:49 2014 - [<span class="builtin-name">info</span>]     Replicating <span class="keyword">from</span> 192.168.0.50(192.168.0.50:3306)</span><br><span class="line">Mon Apr 21 20:15:49 2014 - [<span class="builtin-name">info</span>] </span><br><span class="line">Mon Apr 21 20:15:49 2014 - [<span class="builtin-name">info</span>] * Phase 3.2: Saving Dead Master<span class="string">'s Binlog Phase..</span></span><br><span class="line"><span class="string">Mon Apr 21 20:15:49 2014 - [info] </span></span><br><span class="line"><span class="string">Mon Apr 21 20:15:49 2014 - [info] Fetching dead master'</span>s binary logs<span class="built_in">..</span></span><br><span class="line">Mon Apr 21 20:15:49 2014 - [<span class="builtin-name">info</span>] Executing command on the dead master 192.168.0.50(192.168.0.50:3306): save_binary_logs <span class="attribute">--command</span>=save <span class="attribute">--start_file</span>=mysql-bin.000018  <span class="attribute">--start_pos</span>=112 <span class="attribute">--binlog_dir</span>=/data/mysql <span class="attribute">--output_file</span>=/tmp/saved_master_binlog_from_192.168.0.50_3306_20140421201548.binlog <span class="attribute">--handle_raw_binlog</span>=1 <span class="attribute">--disable_log_bin</span>=0 <span class="attribute">--manager_version</span>=0.53</span><br><span class="line">  Creating /tmp <span class="keyword">if</span> <span class="keyword">not</span> exists<span class="built_in">..</span>    ok.</span><br><span class="line"> Concat binary/relay logs <span class="keyword">from</span> mysql-bin.000018 pos 112 <span class="keyword">to</span> mysql-bin.000018 EOF into /tmp/saved_master_binlog_from_192.168.0.50_3306_20140421201548.binlog <span class="built_in">..</span></span><br><span class="line">  Dumping binlog format description event, <span class="keyword">from</span> position 0 <span class="keyword">to</span> 112<span class="built_in">..</span> ok.</span><br><span class="line">  Dumping effective binlog data <span class="keyword">from</span> /data/mysql/mysql-bin.000018 position 112 <span class="keyword">to</span> tail(131)<span class="built_in">..</span> ok.</span><br><span class="line"> Concat succeeded.</span><br><span class="line">Mon Apr 21 20:15:50 2014 - [<span class="builtin-name">info</span>] scp <span class="keyword">from</span> root@192.168.0.50:/tmp/saved_master_binlog_from_192.168.0.50_3306_20140421201548.binlog <span class="keyword">to</span> local:/var/log/masterha/app1.log/saved_master_binlog_from_192.168.0.50_3306_20140421201548.binlog succeeded.</span><br><span class="line">Mon Apr 21 20:15:50 2014 - [<span class="builtin-name">info</span>] HealthCheck: SSH <span class="keyword">to</span> 192.168.0.60 is reachable.</span><br><span class="line">Mon Apr 21 20:15:50 2014 - [<span class="builtin-name">info</span>] HealthCheck: SSH <span class="keyword">to</span> 192.168.0.70 is reachable.</span><br><span class="line">Mon Apr 21 20:15:50 2014 - [<span class="builtin-name">info</span>] </span><br><span class="line">Mon Apr 21 20:15:50 2014 - [<span class="builtin-name">info</span>] * Phase 3.3: Determining New Master Phase<span class="built_in">..</span></span><br><span class="line">Mon Apr 21 20:15:50 2014 - [<span class="builtin-name">info</span>] </span><br><span class="line">Mon Apr 21 20:15:50 2014 - [<span class="builtin-name">info</span>] Finding the latest slave that has all relay logs <span class="keyword">for</span> recovering other slaves<span class="built_in">..</span></span><br><span class="line">Mon Apr 21 20:15:50 2014 - [<span class="builtin-name">info</span>] All slaves received relay logs <span class="keyword">to</span> the same position. <span class="literal">No</span> need <span class="keyword">to</span> resync each other.</span><br><span class="line">Mon Apr 21 20:15:50 2014 - [<span class="builtin-name">info</span>] Searching new master <span class="keyword">from</span> slaves<span class="built_in">..</span></span><br><span class="line">Mon Apr 21 20:15:50 2014 - [<span class="builtin-name">info</span>]  Candidate masters <span class="keyword">from</span> the configuration file:</span><br><span class="line">Mon Apr 21 20:15:50 2014 - [<span class="builtin-name">info</span>]   192.168.0.60(192.168.0.60:3306)  <span class="attribute">Version</span>=5.5.19-ndb-7.2.4-gpl-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Apr 21 20:15:50 2014 - [<span class="builtin-name">info</span>]     Replicating <span class="keyword">from</span> 192.168.0.50(192.168.0.50:3306)</span><br><span class="line">Mon Apr 21 20:15:50 2014 - [<span class="builtin-name">info</span>]     Primary candidate <span class="keyword">for</span> the new Master (candidate_master is set)</span><br><span class="line">Mon Apr 21 20:15:50 2014 - [<span class="builtin-name">info</span>]  Non-candidate masters:</span><br><span class="line">Mon Apr 21 20:15:50 2014 - [<span class="builtin-name">info</span>]  Searching <span class="keyword">from</span> candidate_master slaves which have received the latest relay log events<span class="built_in">..</span></span><br><span class="line">Mon Apr 21 20:15:50 2014 - [<span class="builtin-name">info</span>] New master is 192.168.0.60(192.168.0.60:3306)</span><br><span class="line">Mon Apr 21 20:15:50 2014 - [<span class="builtin-name">info</span>] Starting master failover<span class="built_in">..</span></span><br><span class="line">Mon Apr 21 20:15:50 2014 - [<span class="builtin-name">info</span>] </span><br><span class="line"><span class="keyword">From</span>:</span><br><span class="line">192.168.0.50 (current master)</span><br><span class="line"> +--192.168.0.60</span><br><span class="line"> +--192.168.0.70</span><br><span class="line"></span><br><span class="line"><span class="keyword">To</span>:</span><br><span class="line">192.168.0.60 (new master)</span><br><span class="line"> +--192.168.0.70</span><br><span class="line">Mon Apr 21 20:15:50 2014 - [<span class="builtin-name">info</span>] </span><br><span class="line">Mon Apr 21 20:15:50 2014 - [<span class="builtin-name">info</span>] * Phase 3.3: New Master Diff Log Generation Phase<span class="built_in">..</span></span><br><span class="line">Mon Apr 21 20:15:50 2014 - [<span class="builtin-name">info</span>] </span><br><span class="line">Mon Apr 21 20:15:50 2014 - [<span class="builtin-name">info</span>]  This<span class="built_in"> server </span>has all relay logs. <span class="literal">No</span> need <span class="keyword">to</span> generate diff files <span class="keyword">from</span> the latest slave.</span><br><span class="line">Mon Apr 21 20:15:50 2014 - [<span class="builtin-name">info</span>] Sending binlog<span class="built_in">..</span></span><br><span class="line">Mon Apr 21 20:15:51 2014 - [<span class="builtin-name">info</span>] scp <span class="keyword">from</span> local:/var/log/masterha/app1.log/saved_master_binlog_from_192.168.0.50_3306_20140421201548.binlog <span class="keyword">to</span> root@192.168.0.60:/tmp/saved_master_binlog_from_192.168.0.50_3306_20140421201548.binlog succeeded.</span><br><span class="line">Mon Apr 21 20:15:51 2014 - [<span class="builtin-name">info</span>] </span><br><span class="line">Mon Apr 21 20:15:51 2014 - [<span class="builtin-name">info</span>] * Phase 3.4: Master Log Apply Phase<span class="built_in">..</span></span><br><span class="line">Mon Apr 21 20:15:51 2014 - [<span class="builtin-name">info</span>] </span><br><span class="line">Mon Apr 21 20:15:51 2014 - [<span class="builtin-name">info</span>] *NOTICE: <span class="keyword">If</span> any <span class="builtin-name">error</span> happens <span class="keyword">from</span> this phase,<span class="built_in"> manual </span>recovery is needed.</span><br><span class="line">Mon Apr 21 20:15:51 2014 - [<span class="builtin-name">info</span>] Starting recovery on 192.168.0.60(192.168.0.60:3306)<span class="built_in">..</span></span><br><span class="line">Mon Apr 21 20:15:51 2014 - [<span class="builtin-name">info</span>]  Generating diffs succeeded.</span><br><span class="line">Mon Apr 21 20:15:51 2014 - [<span class="builtin-name">info</span>] Waiting until all relay logs are applied.</span><br><span class="line">Mon Apr 21 20:15:51 2014 - [<span class="builtin-name">info</span>]  done.</span><br><span class="line">Mon Apr 21 20:15:51 2014 - [<span class="builtin-name">info</span>] Getting slave status<span class="built_in">..</span></span><br><span class="line">Mon Apr 21 20:15:51 2014 - [<span class="builtin-name">info</span>] This slave(192.168.0.60)<span class="string">'s Exec_Master_Log_Pos equals to Read_Master_Log_Pos(mysql-bin.000018:112). No need to recover from Exec_Master_Log_Pos.</span></span><br><span class="line"><span class="string">Mon Apr 21 20:15:51 2014 - [info] Connecting to the target slave host 192.168.0.60, running recover script..</span></span><br><span class="line"><span class="string">Mon Apr 21 20:15:51 2014 - [info] Executing command: apply_diff_relay_logs --command=apply --slave_user=root --slave_host=192.168.0.60 --slave_ip=192.168.0.60  --slave_port=3306 --apply_files=/tmp/saved_master_binlog_from_192.168.0.50_3306_20140421201548.binlog --workdir=/tmp --target_version=5.5.19-ndb-7.2.4-gpl-log --timestamp=20140421201548 --handle_raw_binlog=1 --disable_log_bin=0 --manager_version=0.53 --slave_pass=xxx</span></span><br><span class="line"><span class="string">Mon Apr 21 20:15:51 2014 - [info] </span></span><br><span class="line"><span class="string">Applying differential binary/relay log files /tmp/saved_master_binlog_from_192.168.0.50_3306_20140421201548.binlog on 192.168.0.60:3306. This may take long time...</span></span><br><span class="line"><span class="string">Applying log files succeeded.</span></span><br><span class="line"><span class="string">Mon Apr 21 20:15:51 2014 - [info]  All relay logs were successfully applied.</span></span><br><span class="line"><span class="string">Mon Apr 21 20:15:51 2014 - [info] Getting new master'</span>s binlog name <span class="keyword">and</span> position<span class="built_in">..</span></span><br><span class="line">Mon Apr 21 20:15:51 2014 - [<span class="builtin-name">info</span>]  mysql-bin.000022:506716</span><br><span class="line">Mon Apr 21 20:15:51 2014 - [<span class="builtin-name">info</span>]  All other slaves should start replication <span class="keyword">from</span> here. Statement should be: CHANGE MASTER <span class="keyword">TO</span> <span class="attribute">MASTER_HOST</span>=<span class="string">'192.168.0.60'</span>, <span class="attribute">MASTER_PORT</span>=3306, <span class="attribute">MASTER_LOG_FILE</span>=<span class="string">'mysql-bin.000022'</span>, <span class="attribute">MASTER_LOG_POS</span>=506716, <span class="attribute">MASTER_USER</span>=<span class="string">'repl'</span>, <span class="attribute">MASTER_PASSWORD</span>=<span class="string">'xxx'</span>;</span><br><span class="line">Mon Apr 21 20:15:51 2014 - [<span class="builtin-name">info</span>] Executing master<span class="built_in"> IP </span>activate script:</span><br><span class="line">Mon Apr 21 20:15:51 2014 - [<span class="builtin-name">info</span>]   /usr/local/bin/master_ip_failover <span class="attribute">--command</span>=start <span class="attribute">--ssh_user</span>=root <span class="attribute">--orig_master_host</span>=192.168.0.50 <span class="attribute">--orig_master_ip</span>=192.168.0.50 <span class="attribute">--orig_master_port</span>=3306 <span class="attribute">--new_master_host</span>=192.168.0.60 <span class="attribute">--new_master_ip</span>=192.168.0.60 <span class="attribute">--new_master_port</span>=3306  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">IN</span><span class="built_in"> SCRIPT </span><span class="attribute">TEST</span>====/etc/init.d/keepalived <span class="attribute">stop</span>==/etc/init.d/keepalived <span class="attribute">start</span>===</span><br><span class="line"></span><br><span class="line">Enabling the VIP - 192.168.0.88 on the new master - 192.168.0.60 </span><br><span class="line">Mon Apr 21 20:15:52 2014 - [<span class="builtin-name">info</span>]  OK.</span><br><span class="line">Mon Apr 21 20:15:52 2014 - [<span class="builtin-name">info</span>] Setting <span class="attribute">read_only</span>=0 on 192.168.0.60(192.168.0.60:3306)<span class="built_in">..</span></span><br><span class="line">Mon Apr 21 20:15:52 2014 - [<span class="builtin-name">info</span>]  ok.</span><br><span class="line">Mon Apr 21 20:15:52 2014 - [<span class="builtin-name">info</span>] ** Finished master recovery successfully.</span><br><span class="line">Mon Apr 21 20:15:52 2014 - [<span class="builtin-name">info</span>] * Phase 3: Master Recovery Phase completed.</span><br><span class="line">Mon Apr 21 20:15:52 2014 - [<span class="builtin-name">info</span>] </span><br><span class="line">Mon Apr 21 20:15:52 2014 - [<span class="builtin-name">info</span>] * Phase 4: Slaves Recovery Phase<span class="built_in">..</span></span><br><span class="line">Mon Apr 21 20:15:52 2014 - [<span class="builtin-name">info</span>] </span><br><span class="line">Mon Apr 21 20:15:52 2014 - [<span class="builtin-name">info</span>] * Phase 4.1: Starting Parallel Slave Diff Log Generation Phase<span class="built_in">..</span></span><br><span class="line">Mon Apr 21 20:15:52 2014 - [<span class="builtin-name">info</span>] </span><br><span class="line">Mon Apr 21 20:15:52 2014 - [<span class="builtin-name">info</span>] -- Slave diff file generation on host 192.168.0.70(192.168.0.70:3306) started, pid: 31321. Check tmp log /var/log/masterha/app1.log/192.168.0.70_3306_20140421201548.log <span class="keyword">if</span> it takes time<span class="built_in">..</span></span><br><span class="line">Mon Apr 21 20:15:52 2014 - [<span class="builtin-name">info</span>] </span><br><span class="line">Mon Apr 21 20:15:52 2014 - [<span class="builtin-name">info</span>] Log messages <span class="keyword">from</span> 192.168.0.70 <span class="built_in">..</span>.</span><br><span class="line">Mon Apr 21 20:15:52 2014 - [<span class="builtin-name">info</span>] </span><br><span class="line">Mon Apr 21 20:15:52 2014 - [<span class="builtin-name">info</span>]  This<span class="built_in"> server </span>has all relay logs. <span class="literal">No</span> need <span class="keyword">to</span> generate diff files <span class="keyword">from</span> the latest slave.</span><br><span class="line">Mon Apr 21 20:15:52 2014 - [<span class="builtin-name">info</span>] End of log messages <span class="keyword">from</span> 192.168.0.70.</span><br><span class="line">Mon Apr 21 20:15:52 2014 - [<span class="builtin-name">info</span>] -- 192.168.0.70(192.168.0.70:3306) has the latest relay log events.</span><br><span class="line">Mon Apr 21 20:15:52 2014 - [<span class="builtin-name">info</span>] Generating relay diff files <span class="keyword">from</span> the latest slave succeeded.</span><br><span class="line">Mon Apr 21 20:15:52 2014 - [<span class="builtin-name">info</span>] </span><br><span class="line">Mon Apr 21 20:15:52 2014 - [<span class="builtin-name">info</span>] * Phase 4.2: Starting Parallel Slave Log Apply Phase<span class="built_in">..</span></span><br><span class="line">Mon Apr 21 20:15:52 2014 - [<span class="builtin-name">info</span>] </span><br><span class="line">Mon Apr 21 20:15:52 2014 - [<span class="builtin-name">info</span>] -- Slave recovery on host 192.168.0.70(192.168.0.70:3306) started, pid: 31323. Check tmp log /var/log/masterha/app1.log/192.168.0.70_3306_20140421201548.log <span class="keyword">if</span> it takes time<span class="built_in">..</span></span><br><span class="line">Mon Apr 21 20:15:52 2014 - [<span class="builtin-name">info</span>] </span><br><span class="line">Mon Apr 21 20:15:52 2014 - [<span class="builtin-name">info</span>] Log messages <span class="keyword">from</span> 192.168.0.70 <span class="built_in">..</span>.</span><br><span class="line">Mon Apr 21 20:15:52 2014 - [<span class="builtin-name">info</span>] </span><br><span class="line">Mon Apr 21 20:15:52 2014 - [<span class="builtin-name">info</span>] Sending binlog<span class="built_in">..</span></span><br><span class="line">Mon Apr 21 20:15:52 2014 - [<span class="builtin-name">info</span>] scp <span class="keyword">from</span> local:/var/log/masterha/app1.log/saved_master_binlog_from_192.168.0.50_3306_20140421201548.binlog <span class="keyword">to</span> root@192.168.0.70:/tmp/saved_master_binlog_from_192.168.0.50_3306_20140421201548.binlog succeeded.</span><br><span class="line">Mon Apr 21 20:15:52 2014 - [<span class="builtin-name">info</span>] Starting recovery on 192.168.0.70(192.168.0.70:3306)<span class="built_in">..</span></span><br><span class="line">Mon Apr 21 20:15:52 2014 - [<span class="builtin-name">info</span>]  Generating diffs succeeded.</span><br><span class="line">Mon Apr 21 20:15:52 2014 - [<span class="builtin-name">info</span>] Waiting until all relay logs are applied.</span><br><span class="line">Mon Apr 21 20:15:52 2014 - [<span class="builtin-name">info</span>]  done.</span><br><span class="line">Mon Apr 21 20:15:52 2014 - [<span class="builtin-name">info</span>] Getting slave status<span class="built_in">..</span></span><br><span class="line">Mon Apr 21 20:15:52 2014 - [<span class="builtin-name">info</span>] This slave(192.168.0.70)<span class="string">'s Exec_Master_Log_Pos equals to Read_Master_Log_Pos(mysql-bin.000018:112). No need to recover from Exec_Master_Log_Pos.</span></span><br><span class="line"><span class="string">Mon Apr 21 20:15:52 2014 - [info] Connecting to the target slave host 192.168.0.70, running recover script..</span></span><br><span class="line"><span class="string">Mon Apr 21 20:15:52 2014 - [info] Executing command: apply_diff_relay_logs --command=apply --slave_user=root --slave_host=192.168.0.70 --slave_ip=192.168.0.70  --slave_port=3306 --apply_files=/tmp/saved_master_binlog_from_192.168.0.50_3306_20140421201548.binlog --workdir=/tmp --target_version=5.5.19-ndb-7.2.4-gpl-log --timestamp=20140421201548 --handle_raw_binlog=1 --disable_log_bin=0 --manager_version=0.53 --slave_pass=xxx</span></span><br><span class="line"><span class="string">Mon Apr 21 20:15:52 2014 - [info] </span></span><br><span class="line"><span class="string">Applying differential binary/relay log files /tmp/saved_master_binlog_from_192.168.0.50_3306_20140421201548.binlog on 192.168.0.70:3306. This may take long time...</span></span><br><span class="line"><span class="string">Applying log files succeeded.</span></span><br><span class="line"><span class="string">Mon Apr 21 20:15:52 2014 - [info]  All relay logs were successfully applied.</span></span><br><span class="line"><span class="string">Mon Apr 21 20:15:52 2014 - [info]  Resetting slave 192.168.0.70(192.168.0.70:3306) and starting replication from the new master 192.168.0.60(192.168.0.60:3306)..</span></span><br><span class="line"><span class="string">Mon Apr 21 20:15:52 2014 - [info]  Executed CHANGE MASTER.</span></span><br><span class="line"><span class="string">Mon Apr 21 20:15:52 2014 - [info]  Slave started.</span></span><br><span class="line"><span class="string">Mon Apr 21 20:15:52 2014 - [info] End of log messages from 192.168.0.70.</span></span><br><span class="line"><span class="string">Mon Apr 21 20:15:52 2014 - [info] -- Slave recovery on host 192.168.0.70(192.168.0.70:3306) succeeded.</span></span><br><span class="line"><span class="string">Mon Apr 21 20:15:52 2014 - [info] All new slave servers recovered successfully.</span></span><br><span class="line"><span class="string">Mon Apr 21 20:15:52 2014 - [info] </span></span><br><span class="line"><span class="string">Mon Apr 21 20:15:52 2014 - [info] * Phase 5: New master cleanup phease..</span></span><br><span class="line"><span class="string">Mon Apr 21 20:15:52 2014 - [info] </span></span><br><span class="line"><span class="string">Mon Apr 21 20:15:52 2014 - [info] Resetting slave info on the new master..</span></span><br><span class="line"><span class="string">Mon Apr 21 20:15:53 2014 - [info]  192.168.0.60: Resetting slave info succeeded.</span></span><br><span class="line"><span class="string">Mon Apr 21 20:15:53 2014 - [info] Master failover to 192.168.0.60(192.168.0.60:3306) completed successfully.</span></span><br><span class="line"><span class="string">Mon Apr 21 20:15:53 2014 - [info] Deleted server1 entry from /etc/masterha/app1.cnf .</span></span><br><span class="line"><span class="string">Mon Apr 21 20:15:53 2014 - [info] </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">----- Failover Report -----</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">app1: MySQL Master failover 192.168.0.50 to 192.168.0.60 succeeded</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Master 192.168.0.50 is down!</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Check MHA Manager logs at server01:/var/log/masterha/app1/manager.log for details.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Started automated(non-interactive) failover.</span></span><br><span class="line"><span class="string">Invalidated master IP address on 192.168.0.50.</span></span><br><span class="line"><span class="string">The latest slave 192.168.0.60(192.168.0.60:3306) has all relay logs for recovery.</span></span><br><span class="line"><span class="string">Selected 192.168.0.60 as a new master.</span></span><br><span class="line"><span class="string">192.168.0.60: OK: Applying all logs succeeded.</span></span><br><span class="line"><span class="string">192.168.0.60: OK: Activated master IP address.</span></span><br><span class="line"><span class="string">192.168.0.70: This host has the latest relay log events.</span></span><br><span class="line"><span class="string">Generating relay diff files from the latest slave succeeded.</span></span><br><span class="line"><span class="string">192.168.0.70: OK: Applying all logs succeeded. Slave started, replicating from 192.168.0.60.</span></span><br><span class="line"><span class="string">192.168.0.60: Resetting slave info succeeded.</span></span><br><span class="line"><span class="string">Master failover to 192.168.0.60(192.168.0.60:3306) completed successfully.</span></span><br><span class="line"><span class="string">[root@192.168.0.20 ~]#</span></span><br></pre></td></tr></table></figure></p>
<p>看到最后的Master failover to 192.168.0.60(192.168.0.60:3306) completed successfully.说明备选master现在已经上位了。</p>
<p>从上面的输出可以看出整个MHA的切换过程，共包括以下的步骤：</p>
<font color="red">1.配置文件检查阶段，这个阶段会检查整个集群配置文件配置</font><br><font color="red">2.宕机的master处理，这个阶段包括虚拟ip摘除操作，主机关机操作（这个我这里还没有实现，需要研究）</font><br><font color="red">3.复制dead maste和最新slave相差的relay log，并保存到MHA Manger具体的目录下</font><br><font color="red">4.识别含有最新更新的slave</font><br><font color="red">5.应用从master保存的二进制日志事件（binlog events）</font><br><font color="red">6.提升一个slave为新的master进行复制</font><br><font color="red">7.使其他的slave连接新的master进行复制</font>

<p>最后启动MHA Manger监控，查看集群里面现在谁是master（在切换后监控就停止了。。。还有东西没搞对？）后来在官方网站看到这句话就明白了 。<br><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Running MHA Manager <span class="built_in">from</span> daemontools</span><br><span class="line"></span><br><span class="line">    Currently MHA Manager <span class="built_in">process</span> does <span class="keyword">not</span> run <span class="keyword">as</span> <span class="keyword">a</span> daemon. If failover completed successfully <span class="keyword">or</span> <span class="keyword">the</span> master <span class="built_in">process</span> was killed <span class="keyword">by</span> accident, <span class="keyword">the</span> manager stops working. To run <span class="keyword">as</span> <span class="keyword">a</span> daemon, daemontool. <span class="keyword">or</span> <span class="keyword">any</span> external daemon program can be used. Here is <span class="keyword">an</span> example <span class="built_in">to</span> run <span class="built_in">from</span> daemontools.</span><br></pre></td></tr></table></figure></p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@192</span>.<span class="number">168.0</span>.<span class="number">20</span> ~]<span class="comment"># masterha_check_status --conf=/etc/masterha/app1.cnf</span></span><br><span class="line">app1 (<span class="symbol">pid:</span><span class="number">23971</span>) is running(0<span class="symbol">:PING_OK</span>), <span class="symbol">master:</span><span class="number">192.168</span>.0.<span class="number">60</span></span><br><span class="line">[root<span class="variable">@192</span>.<span class="number">168.0</span>.<span class="number">20</span> ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h2 id="二-手动Failover（MHA-Manager必须没有运行）"><a href="#二-手动Failover（MHA-Manager必须没有运行）" class="headerlink" title="二.手动Failover（MHA Manager必须没有运行）"></a>二.手动Failover（<font color="red">MHA Manager必须没有运行</font>）</h2><p>手动failover，这种场景意味着在业务上没有启用MHA自动切换功能，当主服务器故障时，人工手动调用MHA来进行故障切换操作，具体命令如下：</p>
<font color="red">注意：如果，MHA manager检测到没有dead的server，将报错，并结束failover： </font><br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Mon Apr 21 21:23:33 2014 - [info] Dead Servers:</span><br><span class="line">Mon Apr 21 21:23:33 2014 - [<span class="string">error</span>][<span class="symbol">/usr/local/share/perl5/MHA/MasterFailover.pm, ln181</span>] None of server is dead. Stop failover.</span><br><span class="line">Mon Apr 21 21:23:33 2014 - [<span class="string">error</span>][<span class="symbol">/usr/local/share/perl5/MHA/ManagerUtil.pm, ln178</span>] Got ERROR:  at /usr/local/bin/masterha<span class="emphasis">_master_</span>switch line 53</span><br></pre></td></tr></table></figure><br><br>进行手动切换命令如下：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@192.168.0.20 ~]# masterha_master_switch <span class="attribute">--master_state</span>=dead <span class="attribute">--conf</span>=/etc/masterha/app1.cnf <span class="attribute">--dead_master_host</span>=192.168.0.50 <span class="attribute">--dead_master_port</span>=3306 <span class="attribute">--new_master_host</span>=192.168.0.60 <span class="attribute">--new_master_port</span>=3306 --ignore_last_failover</span><br></pre></td></tr></table></figure><br><br>输出的信息会询问你是否进行切换：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:28:00</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[warning]</span> <span class="string">Global</span> <span class="string">configuration</span> <span class="string">file</span> <span class="string">/etc/masterha_default.cnf</span> <span class="string">not</span> <span class="string">found.</span> <span class="string">Skipping.</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:28:00</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Reading</span> <span class="string">application</span> <span class="string">default</span> <span class="string">configurations</span> <span class="string">from</span> <span class="string">/etc/masterha/app1.cnf..</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:28:00</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Reading</span> <span class="string">server</span> <span class="string">configurations</span> <span class="string">from</span> <span class="string">/etc/masterha/app1.cnf..</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:28:00</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">MHA::MasterFailover</span> <span class="string">version</span> <span class="number">0.53</span><span class="string">.</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:28:00</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Starting</span> <span class="string">master</span> <span class="string">failover.</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:28:00</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> </span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:28:00</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">*</span> <span class="attr">Phase 1:</span> <span class="string">Configuration</span> <span class="string">Check</span> <span class="string">Phase..</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:28:00</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> </span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:28:00</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="attr">Dead Servers:</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:28:00</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>   <span class="number">192.168</span><span class="number">.0</span><span class="number">.50</span><span class="string">(192.168.0.50:3306)</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:28:00</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Checking</span> <span class="string">master</span> <span class="string">reachability</span> <span class="string">via</span> <span class="string">mysql(double</span> <span class="string">check)..</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:28:00</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>  <span class="string">ok.</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:28:00</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="attr">Alive Servers:</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:28:00</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>   <span class="number">192.168</span><span class="number">.0</span><span class="number">.60</span><span class="string">(192.168.0.60:3306)</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:28:00</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>   <span class="number">192.168</span><span class="number">.0</span><span class="number">.70</span><span class="string">(192.168.0.70:3306)</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:28:00</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="attr">Alive Slaves:</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:28:00</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>   <span class="number">192.168</span><span class="number">.0</span><span class="number">.60</span><span class="string">(192.168.0.60:3306)</span>  <span class="string">Version=5.5.19-ndb-7.2.4-gpl-log</span> <span class="string">(oldest</span> <span class="string">major</span> <span class="string">version</span> <span class="string">between</span> <span class="string">slaves)</span> <span class="string">log-bin:enabled</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:28:00</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>     <span class="string">Replicating</span> <span class="string">from</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.50</span><span class="string">(192.168.0.50:3306)</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:28:00</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>     <span class="string">Primary</span> <span class="string">candidate</span> <span class="string">for</span> <span class="string">the</span> <span class="string">new</span> <span class="string">Master</span> <span class="string">(candidate_master</span> <span class="string">is</span> <span class="string">set)</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:28:00</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>   <span class="number">192.168</span><span class="number">.0</span><span class="number">.70</span><span class="string">(192.168.0.70:3306)</span>  <span class="string">Version=5.5.19-ndb-7.2.4-gpl-log</span> <span class="string">(oldest</span> <span class="string">major</span> <span class="string">version</span> <span class="string">between</span> <span class="string">slaves)</span> <span class="string">log-bin:enabled</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:28:00</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>     <span class="string">Replicating</span> <span class="string">from</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.50</span><span class="string">(192.168.0.50:3306)</span></span><br><span class="line"><span class="string">Master</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.50</span> <span class="string">is</span> <span class="string">dead.</span> <span class="string">Proceed?</span> <span class="string">(yes/NO):</span> <span class="literal">yes</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:01</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">**</span> <span class="attr">Phase 1:</span> <span class="string">Configuration</span> <span class="string">Check</span> <span class="string">Phase</span> <span class="string">completed.</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:01</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> </span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:01</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">*</span> <span class="attr">Phase 2:</span> <span class="string">Dead</span> <span class="string">Master</span> <span class="string">Shutdown</span> <span class="string">Phase..</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:01</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> </span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:01</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="attr">HealthCheck:</span> <span class="string">SSH</span> <span class="string">to</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.50</span> <span class="string">is</span> <span class="string">reachable.</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:01</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Forcing</span> <span class="string">shutdown</span> <span class="string">so</span> <span class="string">that</span> <span class="string">applications</span> <span class="string">never</span> <span class="string">connect</span> <span class="string">to</span> <span class="string">the</span> <span class="string">current</span> <span class="string">master..</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:01</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="attr">Executing master IP deactivatation script:</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:01</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>   <span class="string">/usr/local/bin/master_ip_failover</span> <span class="string">--orig_master_host=192.168.0.50</span> <span class="string">--orig_master_ip=192.168.0.50</span> <span class="string">--orig_master_port=3306</span> <span class="string">--command=stopssh</span> <span class="string">--ssh_user=root</span>  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">IN</span> <span class="string">SCRIPT</span> <span class="string">TEST====/sbin/ifconfig</span> <span class="string">eth1:1</span> <span class="string">down==/sbin/ifconfig</span> <span class="string">eth1:1</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.88</span><span class="string">/24===</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Disabling the VIP on old master:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.50</span> </span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>  <span class="string">done.</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[warning]</span> <span class="string">shutdown_script</span> <span class="string">is</span> <span class="string">not</span> <span class="string">set.</span> <span class="string">Skipping</span> <span class="string">explicit</span> <span class="string">shutting</span> <span class="string">down</span> <span class="string">of</span> <span class="string">the</span> <span class="string">dead</span> <span class="string">master.</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">*</span> <span class="attr">Phase 2:</span> <span class="string">Dead</span> <span class="string">Master</span> <span class="string">Shutdown</span> <span class="string">Phase</span> <span class="string">completed.</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> </span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">*</span> <span class="attr">Phase 3:</span> <span class="string">Master</span> <span class="string">Recovery</span> <span class="string">Phase..</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> </span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">*</span> <span class="attr">Phase 3.1:</span> <span class="string">Getting</span> <span class="string">Latest</span> <span class="string">Slaves</span> <span class="string">Phase..</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> </span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">The</span> <span class="string">latest</span> <span class="string">binary</span> <span class="string">log</span> <span class="string">file/position</span> <span class="string">on</span> <span class="string">all</span> <span class="string">slaves</span> <span class="string">is</span> <span class="string">mysql-bin.000020:112</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Latest</span> <span class="string">slaves</span> <span class="string">(Slaves</span> <span class="string">that</span> <span class="string">received</span> <span class="string">relay</span> <span class="string">log</span> <span class="string">files</span> <span class="string">to</span> <span class="string">the</span> <span class="string">latest):</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>   <span class="number">192.168</span><span class="number">.0</span><span class="number">.60</span><span class="string">(192.168.0.60:3306)</span>  <span class="string">Version=5.5.19-ndb-7.2.4-gpl-log</span> <span class="string">(oldest</span> <span class="string">major</span> <span class="string">version</span> <span class="string">between</span> <span class="string">slaves)</span> <span class="string">log-bin:enabled</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>     <span class="string">Replicating</span> <span class="string">from</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.50</span><span class="string">(192.168.0.50:3306)</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>     <span class="string">Primary</span> <span class="string">candidate</span> <span class="string">for</span> <span class="string">the</span> <span class="string">new</span> <span class="string">Master</span> <span class="string">(candidate_master</span> <span class="string">is</span> <span class="string">set)</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>   <span class="number">192.168</span><span class="number">.0</span><span class="number">.70</span><span class="string">(192.168.0.70:3306)</span>  <span class="string">Version=5.5.19-ndb-7.2.4-gpl-log</span> <span class="string">(oldest</span> <span class="string">major</span> <span class="string">version</span> <span class="string">between</span> <span class="string">slaves)</span> <span class="string">log-bin:enabled</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>     <span class="string">Replicating</span> <span class="string">from</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.50</span><span class="string">(192.168.0.50:3306)</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">The</span> <span class="string">oldest</span> <span class="string">binary</span> <span class="string">log</span> <span class="string">file/position</span> <span class="string">on</span> <span class="string">all</span> <span class="string">slaves</span> <span class="string">is</span> <span class="string">mysql-bin.000020:112</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="attr">Oldest slaves:</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>   <span class="number">192.168</span><span class="number">.0</span><span class="number">.60</span><span class="string">(192.168.0.60:3306)</span>  <span class="string">Version=5.5.19-ndb-7.2.4-gpl-log</span> <span class="string">(oldest</span> <span class="string">major</span> <span class="string">version</span> <span class="string">between</span> <span class="string">slaves)</span> <span class="string">log-bin:enabled</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>     <span class="string">Replicating</span> <span class="string">from</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.50</span><span class="string">(192.168.0.50:3306)</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>     <span class="string">Primary</span> <span class="string">candidate</span> <span class="string">for</span> <span class="string">the</span> <span class="string">new</span> <span class="string">Master</span> <span class="string">(candidate_master</span> <span class="string">is</span> <span class="string">set)</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>   <span class="number">192.168</span><span class="number">.0</span><span class="number">.70</span><span class="string">(192.168.0.70:3306)</span>  <span class="string">Version=5.5.19-ndb-7.2.4-gpl-log</span> <span class="string">(oldest</span> <span class="string">major</span> <span class="string">version</span> <span class="string">between</span> <span class="string">slaves)</span> <span class="string">log-bin:enabled</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>     <span class="string">Replicating</span> <span class="string">from</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.50</span><span class="string">(192.168.0.50:3306)</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> </span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">*</span> <span class="attr">Phase 3.2:</span> <span class="string">Saving</span> <span class="string">Dead</span> <span class="string">Master's</span> <span class="string">Binlog</span> <span class="string">Phase..</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> </span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Fetching</span> <span class="string">dead</span> <span class="string">master's</span> <span class="string">binary</span> <span class="string">logs..</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Executing</span> <span class="string">command</span> <span class="string">on</span> <span class="string">the</span> <span class="string">dead</span> <span class="string">master</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.50</span><span class="string">(192.168.0.50:3306):</span> <span class="string">save_binary_logs</span> <span class="string">--command=save</span> <span class="string">--start_file=mysql-bin.000020</span>  <span class="string">--start_pos=112</span> <span class="string">--binlog_dir=/data/mysql</span> <span class="string">--output_file=/tmp/saved_master_binlog_from_192.168.0.50_3306_20140421212800.binlog</span> <span class="string">--handle_raw_binlog=1</span> <span class="string">--disable_log_bin=0</span> <span class="string">--manager_version=0.53</span></span><br><span class="line">  <span class="string">Creating</span> <span class="string">/tmp</span> <span class="string">if</span> <span class="string">not</span> <span class="string">exists..</span>    <span class="string">ok.</span></span><br><span class="line"> <span class="string">Concat</span> <span class="string">binary/relay</span> <span class="string">logs</span> <span class="string">from</span> <span class="string">mysql-bin.000020</span> <span class="string">pos</span> <span class="number">112</span> <span class="string">to</span> <span class="string">mysql-bin.000020</span> <span class="string">EOF</span> <span class="string">into</span> <span class="string">/tmp/saved_master_binlog_from_192.168.0.50_3306_20140421212800.binlog</span> <span class="string">..</span></span><br><span class="line">  <span class="string">Dumping</span> <span class="string">binlog</span> <span class="string">format</span> <span class="string">description</span> <span class="string">event,</span> <span class="string">from</span> <span class="string">position</span> <span class="number">0</span> <span class="string">to</span> <span class="number">112</span><span class="string">..</span> <span class="string">ok.</span></span><br><span class="line">  <span class="string">Dumping</span> <span class="string">effective</span> <span class="string">binlog</span> <span class="string">data</span> <span class="string">from</span> <span class="string">/data/mysql/mysql-bin.000020</span> <span class="string">position</span> <span class="number">112</span> <span class="string">to</span> <span class="string">tail(131)..</span> <span class="string">ok.</span></span><br><span class="line"> <span class="string">Concat</span> <span class="string">succeeded.</span></span><br><span class="line"><span class="string">saved_master_binlog_from_192.168.0.50_3306_20140421212800.binlog</span>                                                   <span class="number">100</span><span class="string">%</span>  <span class="number">131</span>     <span class="number">0.</span><span class="string">1KB/s</span>   <span class="number">00</span><span class="string">:00</span>    </span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">scp</span> <span class="string">from</span> <span class="string">root@192.168.0.50:/tmp/saved_master_binlog_from_192.168.0.50_3306_20140421212800.binlog</span> <span class="string">to</span> <span class="string">local:/var/log/masterha/app1.log/saved_master_binlog_from_192.168.0.50_3306_20140421212800.binlog</span> <span class="string">succeeded.</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="attr">HealthCheck:</span> <span class="string">SSH</span> <span class="string">to</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.60</span> <span class="string">is</span> <span class="string">reachable.</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:03</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="attr">HealthCheck:</span> <span class="string">SSH</span> <span class="string">to</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.70</span> <span class="string">is</span> <span class="string">reachable.</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:03</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> </span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:03</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">*</span> <span class="attr">Phase 3.3:</span> <span class="string">Determining</span> <span class="string">New</span> <span class="string">Master</span> <span class="string">Phase..</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:03</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> </span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:03</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Finding</span> <span class="string">the</span> <span class="string">latest</span> <span class="string">slave</span> <span class="string">that</span> <span class="string">has</span> <span class="string">all</span> <span class="string">relay</span> <span class="string">logs</span> <span class="string">for</span> <span class="string">recovering</span> <span class="string">other</span> <span class="string">slaves..</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:03</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">All</span> <span class="string">slaves</span> <span class="string">received</span> <span class="string">relay</span> <span class="string">logs</span> <span class="string">to</span> <span class="string">the</span> <span class="string">same</span> <span class="string">position.</span> <span class="literal">No</span> <span class="string">need</span> <span class="string">to</span> <span class="string">resync</span> <span class="string">each</span> <span class="string">other.</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:03</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.60</span> <span class="string">can</span> <span class="string">be</span> <span class="string">new</span> <span class="string">master.</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:03</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">New</span> <span class="string">master</span> <span class="string">is</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.60</span><span class="string">(192.168.0.60:3306)</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:03</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Starting</span> <span class="string">master</span> <span class="string">failover..</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:03</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> </span><br><span class="line"><span class="attr">From:</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.0</span><span class="number">.50</span> <span class="string">(current</span> <span class="string">master)</span></span><br><span class="line"> <span class="string">+--192.168.0.60</span></span><br><span class="line"> <span class="string">+--192.168.0.70</span></span><br><span class="line"></span><br><span class="line"><span class="attr">To:</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.0</span><span class="number">.60</span> <span class="string">(new</span> <span class="string">master)</span></span><br><span class="line"> <span class="string">+--192.168.0.70</span></span><br><span class="line"></span><br><span class="line"><span class="string">Starting</span> <span class="string">master</span> <span class="string">switch</span> <span class="string">from</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.50</span><span class="string">(192.168.0.50:3306)</span> <span class="string">to</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.60</span><span class="string">(192.168.0.60:3306)?</span> <span class="string">(yes/NO):</span> <span class="literal">yes</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:06</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">New</span> <span class="string">master</span> <span class="string">decided</span> <span class="string">manually</span> <span class="string">is</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.60</span><span class="string">(192.168.0.60:3306)</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:06</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> </span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:06</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">*</span> <span class="attr">Phase 3.3:</span> <span class="string">New</span> <span class="string">Master</span> <span class="string">Diff</span> <span class="string">Log</span> <span class="string">Generation</span> <span class="string">Phase..</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:06</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> </span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:06</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>  <span class="string">This</span> <span class="string">server</span> <span class="string">has</span> <span class="string">all</span> <span class="string">relay</span> <span class="string">logs.</span> <span class="literal">No</span> <span class="string">need</span> <span class="string">to</span> <span class="string">generate</span> <span class="string">diff</span> <span class="string">files</span> <span class="string">from</span> <span class="string">the</span> <span class="string">latest</span> <span class="string">slave.</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:06</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Sending</span> <span class="string">binlog..</span></span><br><span class="line"><span class="string">saved_master_binlog_from_192.168.0.50_3306_20140421212800.binlog</span>                                                   <span class="number">100</span><span class="string">%</span>  <span class="number">131</span>     <span class="number">0.</span><span class="string">1KB/s</span>   <span class="number">00</span><span class="string">:00</span>    </span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:07</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">scp</span> <span class="string">from</span> <span class="string">local:/var/log/masterha/app1.log/saved_master_binlog_from_192.168.0.50_3306_20140421212800.binlog</span> <span class="string">to</span> <span class="string">root@192.168.0.60:/tmp/saved_master_binlog_from_192.168.0.50_3306_20140421212800.binlog</span> <span class="string">succeeded.</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:07</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> </span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:07</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">*</span> <span class="attr">Phase 3.4:</span> <span class="string">Master</span> <span class="string">Log</span> <span class="string">Apply</span> <span class="string">Phase..</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:07</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> </span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:07</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">*NOTICE:</span> <span class="string">If</span> <span class="string">any</span> <span class="string">error</span> <span class="string">happens</span> <span class="string">from</span> <span class="string">this</span> <span class="string">phase,</span> <span class="string">manual</span> <span class="string">recovery</span> <span class="string">is</span> <span class="string">needed.</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:07</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Starting</span> <span class="string">recovery</span> <span class="string">on</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.60</span><span class="string">(192.168.0.60:3306)..</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:07</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>  <span class="string">Generating</span> <span class="string">diffs</span> <span class="string">succeeded.</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:07</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Waiting</span> <span class="string">until</span> <span class="string">all</span> <span class="string">relay</span> <span class="string">logs</span> <span class="string">are</span> <span class="string">applied.</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:07</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>  <span class="string">done.</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:07</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Getting</span> <span class="string">slave</span> <span class="string">status..</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:07</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">This</span> <span class="string">slave(192.168.0.60)'s</span> <span class="string">Exec_Master_Log_Pos</span> <span class="string">equals</span> <span class="string">to</span> <span class="string">Read_Master_Log_Pos(mysql-bin.000020:112).</span> <span class="literal">No</span> <span class="string">need</span> <span class="string">to</span> <span class="string">recover</span> <span class="string">from</span> <span class="string">Exec_Master_Log_Pos.</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:07</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Connecting</span> <span class="string">to</span> <span class="string">the</span> <span class="string">target</span> <span class="string">slave</span> <span class="string">host</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.60</span><span class="string">,</span> <span class="string">running</span> <span class="string">recover</span> <span class="string">script..</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:07</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="attr">Executing command:</span> <span class="string">apply_diff_relay_logs</span> <span class="string">--command=apply</span> <span class="string">--slave_user=root</span> <span class="string">--slave_host=192.168.0.60</span> <span class="string">--slave_ip=192.168.0.60</span>  <span class="string">--slave_port=3306</span> <span class="string">--apply_files=/tmp/saved_master_binlog_from_192.168.0.50_3306_20140421212800.binlog</span> <span class="string">--workdir=/tmp</span> <span class="string">--target_version=5.5.19-ndb-7.2.4-gpl-log</span> <span class="string">--timestamp=20140421212800</span> <span class="string">--handle_raw_binlog=1</span> <span class="string">--disable_log_bin=0</span> <span class="string">--manager_version=0.53</span> <span class="string">--slave_pass=xxx</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:07</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> </span><br><span class="line"><span class="string">Applying</span> <span class="string">differential</span> <span class="string">binary/relay</span> <span class="string">log</span> <span class="string">files</span> <span class="string">/tmp/saved_master_binlog_from_192.168.0.50_3306_20140421212800.binlog</span> <span class="string">on</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.60</span><span class="string">:3306.</span> <span class="string">This</span> <span class="string">may</span> <span class="string">take</span> <span class="string">long</span> <span class="string">time...</span></span><br><span class="line"><span class="string">Applying</span> <span class="string">log</span> <span class="string">files</span> <span class="string">succeeded.</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:07</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>  <span class="string">All</span> <span class="string">relay</span> <span class="string">logs</span> <span class="string">were</span> <span class="string">successfully</span> <span class="string">applied.</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:07</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Getting</span> <span class="string">new</span> <span class="string">master's</span> <span class="string">binlog</span> <span class="string">name</span> <span class="string">and</span> <span class="string">position..</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:07</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>  <span class="string">mysql-bin.000022:506716</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:07</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>  <span class="attr">All other slaves should start replication from here. Statement should be:</span> <span class="string">CHANGE</span> <span class="string">MASTER</span> <span class="string">TO</span> <span class="string">MASTER_HOST='192.168.0.60',</span> <span class="string">MASTER_PORT=3306,</span> <span class="string">MASTER_LOG_FILE='mysql-bin.000022',</span> <span class="string">MASTER_LOG_POS=506716,</span> <span class="string">MASTER_USER='repl',</span> <span class="string">MASTER_PASSWORD='xxx';</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:07</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="attr">Executing master IP activate script:</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:07</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>   <span class="string">/usr/local/bin/master_ip_failover</span> <span class="string">--command=start</span> <span class="string">--ssh_user=root</span> <span class="string">--orig_master_host=192.168.0.50</span> <span class="string">--orig_master_ip=192.168.0.50</span> <span class="string">--orig_master_port=3306</span> <span class="string">--new_master_host=192.168.0.60</span> <span class="string">--new_master_ip=192.168.0.60</span> <span class="string">--new_master_port=3306</span>  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">IN</span> <span class="string">SCRIPT</span> <span class="string">TEST====/sbin/ifconfig</span> <span class="string">eth1:1</span> <span class="string">down==/sbin/ifconfig</span> <span class="string">eth1:1</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.88</span><span class="string">/24===</span></span><br><span class="line"></span><br><span class="line"><span class="string">Enabling</span> <span class="string">the</span> <span class="string">VIP</span> <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.88</span><span class="string">/24</span> <span class="string">on</span> <span class="string">the</span> <span class="string">new</span> <span class="string">master</span> <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.60</span> </span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:08</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>  <span class="string">OK.</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:08</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Setting</span> <span class="string">read_only=0</span> <span class="string">on</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.60</span><span class="string">(192.168.0.60:3306)..</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:08</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>  <span class="string">ok.</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:08</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">**</span> <span class="string">Finished</span> <span class="string">master</span> <span class="string">recovery</span> <span class="string">successfully.</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:08</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">*</span> <span class="attr">Phase 3:</span> <span class="string">Master</span> <span class="string">Recovery</span> <span class="string">Phase</span> <span class="string">completed.</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:08</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> </span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:08</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">*</span> <span class="attr">Phase 4:</span> <span class="string">Slaves</span> <span class="string">Recovery</span> <span class="string">Phase..</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:08</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> </span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:08</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">*</span> <span class="attr">Phase 4.1:</span> <span class="string">Starting</span> <span class="string">Parallel</span> <span class="string">Slave</span> <span class="string">Diff</span> <span class="string">Log</span> <span class="string">Generation</span> <span class="string">Phase..</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:08</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> </span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:08</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">--</span> <span class="string">Slave</span> <span class="string">diff</span> <span class="string">file</span> <span class="string">generation</span> <span class="string">on</span> <span class="string">host</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.70</span><span class="string">(192.168.0.70:3306)</span> <span class="string">started,</span> <span class="attr">pid:</span> <span class="number">33518</span><span class="string">.</span> <span class="string">Check</span> <span class="string">tmp</span> <span class="string">log</span> <span class="string">/var/log/masterha/app1.log/192.168.0.70_3306_20140421212800.log</span> <span class="string">if</span> <span class="string">it</span> <span class="string">takes</span> <span class="string">time..</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:08</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> </span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:08</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Log</span> <span class="string">messages</span> <span class="string">from</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.70</span> <span class="string">...</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:08</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> </span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:08</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>  <span class="string">This</span> <span class="string">server</span> <span class="string">has</span> <span class="string">all</span> <span class="string">relay</span> <span class="string">logs.</span> <span class="literal">No</span> <span class="string">need</span> <span class="string">to</span> <span class="string">generate</span> <span class="string">diff</span> <span class="string">files</span> <span class="string">from</span> <span class="string">the</span> <span class="string">latest</span> <span class="string">slave.</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:08</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">End</span> <span class="string">of</span> <span class="string">log</span> <span class="string">messages</span> <span class="string">from</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.70</span><span class="string">.</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:08</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">--</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.70</span><span class="string">(192.168.0.70:3306)</span> <span class="string">has</span> <span class="string">the</span> <span class="string">latest</span> <span class="string">relay</span> <span class="string">log</span> <span class="string">events.</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:08</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Generating</span> <span class="string">relay</span> <span class="string">diff</span> <span class="string">files</span> <span class="string">from</span> <span class="string">the</span> <span class="string">latest</span> <span class="string">slave</span> <span class="string">succeeded.</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:08</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> </span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:08</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">*</span> <span class="attr">Phase 4.2:</span> <span class="string">Starting</span> <span class="string">Parallel</span> <span class="string">Slave</span> <span class="string">Log</span> <span class="string">Apply</span> <span class="string">Phase..</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:08</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> </span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:08</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">--</span> <span class="string">Slave</span> <span class="string">recovery</span> <span class="string">on</span> <span class="string">host</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.70</span><span class="string">(192.168.0.70:3306)</span> <span class="string">started,</span> <span class="attr">pid:</span> <span class="number">33520</span><span class="string">.</span> <span class="string">Check</span> <span class="string">tmp</span> <span class="string">log</span> <span class="string">/var/log/masterha/app1.log/192.168.0.70_3306_20140421212800.log</span> <span class="string">if</span> <span class="string">it</span> <span class="string">takes</span> <span class="string">time..</span></span><br><span class="line"><span class="string">saved_master_binlog_from_192.168.0.50_3306_20140421212800.binlog</span>                                                   <span class="number">100</span><span class="string">%</span>  <span class="number">131</span>     <span class="number">0.</span><span class="string">1KB/s</span>   <span class="number">00</span><span class="string">:00</span>    </span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:09</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> </span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:09</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Log</span> <span class="string">messages</span> <span class="string">from</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.70</span> <span class="string">...</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:09</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> </span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:08</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Sending</span> <span class="string">binlog..</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:08</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">scp</span> <span class="string">from</span> <span class="string">local:/var/log/masterha/app1.log/saved_master_binlog_from_192.168.0.50_3306_20140421212800.binlog</span> <span class="string">to</span> <span class="string">root@192.168.0.70:/tmp/saved_master_binlog_from_192.168.0.50_3306_20140421212800.binlog</span> <span class="string">succeeded.</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:08</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Starting</span> <span class="string">recovery</span> <span class="string">on</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.70</span><span class="string">(192.168.0.70:3306)..</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:08</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>  <span class="string">Generating</span> <span class="string">diffs</span> <span class="string">succeeded.</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:08</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Waiting</span> <span class="string">until</span> <span class="string">all</span> <span class="string">relay</span> <span class="string">logs</span> <span class="string">are</span> <span class="string">applied.</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:08</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>  <span class="string">done.</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:08</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Getting</span> <span class="string">slave</span> <span class="string">status..</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:08</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">This</span> <span class="string">slave(192.168.0.70)'s</span> <span class="string">Exec_Master_Log_Pos</span> <span class="string">equals</span> <span class="string">to</span> <span class="string">Read_Master_Log_Pos(mysql-bin.000020:112).</span> <span class="literal">No</span> <span class="string">need</span> <span class="string">to</span> <span class="string">recover</span> <span class="string">from</span> <span class="string">Exec_Master_Log_Pos.</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:08</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Connecting</span> <span class="string">to</span> <span class="string">the</span> <span class="string">target</span> <span class="string">slave</span> <span class="string">host</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.70</span><span class="string">,</span> <span class="string">running</span> <span class="string">recover</span> <span class="string">script..</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:08</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="attr">Executing command:</span> <span class="string">apply_diff_relay_logs</span> <span class="string">--command=apply</span> <span class="string">--slave_user=root</span> <span class="string">--slave_host=192.168.0.70</span> <span class="string">--slave_ip=192.168.0.70</span>  <span class="string">--slave_port=3306</span> <span class="string">--apply_files=/tmp/saved_master_binlog_from_192.168.0.50_3306_20140421212800.binlog</span> <span class="string">--workdir=/tmp</span> <span class="string">--target_version=5.5.19-ndb-7.2.4-gpl-log</span> <span class="string">--timestamp=20140421212800</span> <span class="string">--handle_raw_binlog=1</span> <span class="string">--disable_log_bin=0</span> <span class="string">--manager_version=0.53</span> <span class="string">--slave_pass=xxx</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:09</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> </span><br><span class="line"><span class="string">Applying</span> <span class="string">differential</span> <span class="string">binary/relay</span> <span class="string">log</span> <span class="string">files</span> <span class="string">/tmp/saved_master_binlog_from_192.168.0.50_3306_20140421212800.binlog</span> <span class="string">on</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.70</span><span class="string">:3306.</span> <span class="string">This</span> <span class="string">may</span> <span class="string">take</span> <span class="string">long</span> <span class="string">time...</span></span><br><span class="line"><span class="string">Applying</span> <span class="string">log</span> <span class="string">files</span> <span class="string">succeeded.</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:09</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>  <span class="string">All</span> <span class="string">relay</span> <span class="string">logs</span> <span class="string">were</span> <span class="string">successfully</span> <span class="string">applied.</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:09</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>  <span class="string">Resetting</span> <span class="string">slave</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.70</span><span class="string">(192.168.0.70:3306)</span> <span class="string">and</span> <span class="string">starting</span> <span class="string">replication</span> <span class="string">from</span> <span class="string">the</span> <span class="string">new</span> <span class="string">master</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.60</span><span class="string">(192.168.0.60:3306)..</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:09</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>  <span class="string">Executed</span> <span class="string">CHANGE</span> <span class="string">MASTER.</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:09</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>  <span class="string">Slave</span> <span class="string">started.</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:09</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">End</span> <span class="string">of</span> <span class="string">log</span> <span class="string">messages</span> <span class="string">from</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.70</span><span class="string">.</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:09</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">--</span> <span class="string">Slave</span> <span class="string">recovery</span> <span class="string">on</span> <span class="string">host</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.70</span><span class="string">(192.168.0.70:3306)</span> <span class="string">succeeded.</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:09</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">All</span> <span class="string">new</span> <span class="string">slave</span> <span class="string">servers</span> <span class="string">recovered</span> <span class="string">successfully.</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:09</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> </span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:09</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">*</span> <span class="attr">Phase 5:</span> <span class="string">New</span> <span class="string">master</span> <span class="string">cleanup</span> <span class="string">phease..</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:09</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> </span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:09</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Resetting</span> <span class="string">slave</span> <span class="string">info</span> <span class="string">on</span> <span class="string">the</span> <span class="string">new</span> <span class="string">master..</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:09</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>  <span class="attr">192.168.0.60:</span> <span class="string">Resetting</span> <span class="string">slave</span> <span class="string">info</span> <span class="string">succeeded.</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:09</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Master</span> <span class="string">failover</span> <span class="string">to</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.60</span><span class="string">(192.168.0.60:3306)</span> <span class="string">completed</span> <span class="string">successfully.</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Apr</span> <span class="number">21</span> <span class="number">21</span><span class="string">:36:09</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> </span><br><span class="line"></span><br><span class="line"><span class="string">-----</span> <span class="string">Failover</span> <span class="string">Report</span> <span class="string">-----</span></span><br><span class="line"></span><br><span class="line"><span class="attr">app1:</span> <span class="string">MySQL</span> <span class="string">Master</span> <span class="string">failover</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.50</span> <span class="string">to</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.60</span> <span class="string">succeeded</span></span><br><span class="line"></span><br><span class="line"><span class="string">Master</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.50</span> <span class="string">is</span> <span class="string">down!</span></span><br><span class="line"></span><br><span class="line"><span class="string">Check</span> <span class="string">MHA</span> <span class="string">Manager</span> <span class="string">logs</span> <span class="string">at</span> <span class="string">server01</span> <span class="string">for</span> <span class="string">details.</span></span><br><span class="line"></span><br><span class="line"><span class="string">Started</span> <span class="string">manual(interactive)</span> <span class="string">failover.</span></span><br><span class="line"><span class="string">Invalidated</span> <span class="string">master</span> <span class="string">IP</span> <span class="string">address</span> <span class="string">on</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.50</span><span class="string">.</span></span><br><span class="line"><span class="string">The</span> <span class="string">latest</span> <span class="string">slave</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.60</span><span class="string">(192.168.0.60:3306)</span> <span class="string">has</span> <span class="string">all</span> <span class="string">relay</span> <span class="string">logs</span> <span class="string">for</span> <span class="string">recovery.</span></span><br><span class="line"><span class="string">Selected</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.60</span> <span class="string">as</span> <span class="string">a</span> <span class="string">new</span> <span class="string">master.</span></span><br><span class="line"><span class="attr">192.168.0.60: OK:</span> <span class="string">Applying</span> <span class="string">all</span> <span class="string">logs</span> <span class="string">succeeded.</span></span><br><span class="line"><span class="attr">192.168.0.60: OK:</span> <span class="string">Activated</span> <span class="string">master</span> <span class="string">IP</span> <span class="string">address.</span></span><br><span class="line"><span class="attr">192.168.0.70:</span> <span class="string">This</span> <span class="string">host</span> <span class="string">has</span> <span class="string">the</span> <span class="string">latest</span> <span class="string">relay</span> <span class="string">log</span> <span class="string">events.</span></span><br><span class="line"><span class="string">Generating</span> <span class="string">relay</span> <span class="string">diff</span> <span class="string">files</span> <span class="string">from</span> <span class="string">the</span> <span class="string">latest</span> <span class="string">slave</span> <span class="string">succeeded.</span></span><br><span class="line"><span class="attr">192.168.0.70: OK:</span> <span class="string">Applying</span> <span class="string">all</span> <span class="string">logs</span> <span class="string">succeeded.</span> <span class="string">Slave</span> <span class="string">started,</span> <span class="string">replicating</span> <span class="string">from</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.60</span><span class="string">.</span></span><br><span class="line"><span class="attr">192.168.0.60:</span> <span class="string">Resetting</span> <span class="string">slave</span> <span class="string">info</span> <span class="string">succeeded.</span></span><br><span class="line"><span class="string">Master</span> <span class="string">failover</span> <span class="string">to</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.60</span><span class="string">(192.168.0.60:3306)</span> <span class="string">completed</span> <span class="string">successfully.</span></span><br></pre></td></tr></table></figure><br><br>上述模拟了master宕机的情况下手动把192.168.0.60提升为主库的操作过程。<br><br>## 三.在线进行切换<br><br> 在许多情况下， 需要将现有的主服务器迁移到另外一台服务器上。 比如主服务器硬件故障，RAID 控制卡需要重建，将主服务器移到性能更好的服务器上等等。维护主服务器引起性能下降， 导致停机时间至少无法写入数据。 另外， 阻塞或杀掉当前运行的会话会导致主主之间数据不一致的问题发生。 MHA 提供快速切换和优雅的阻塞写入，这个切换过程只需要 0.5-2s 的时间，这段时间内数据是无法写入的。在很多情况下，0.5-2s 的阻塞写入是可以接受的。因此切换主服务器不需要计划分配维护时间窗口。<br><br>### MHA在线切换的大概过程：<br>1.检测复制设置和确定当前主服务器<br>2.确定新的主服务器<br>3.阻塞写入到当前主服务器<br>4.等待所有从服务器赶上复制<br>5.授予写入到新的主服务器<br>6.重新设置从服务器<br><br><font color="red">注意，在线切换的时候应用架构需要考虑以下两个问题：</font>

<p>1.自动识别master和slave的问题（master的机器可能会切换），如果采用了vip的方式，基本可以解决这个问题。<br>2.负载均衡的问题（可以定义大概的读写比例，每台机器可承担的负载比例，当有机器离开集群时，需要考虑这个问题）</p>
<p><strong>为了保证数据完全一致性，在最快的时间内完成切换，MHA的在线切换必须满足以下条件才会切换成功，否则会切换失败。</strong></p>
<font color="red">1.所有slave的IO线程都在运行</font><br><font color="red">2.所有slave的SQL线程都在运行</font><br><font color="red">3.所有的show slave status的输出中Seconds_Behind_Master参数小于或者等于running_updates_limit秒，如果在切换过程中不指定running_updates_limit,那么默认情况下running_updates_limit为1秒。</font><br><font color="red">4.在master端，通过show processlist输出，没有一个更新花费的时间大于running_updates_limit秒。</font>

<h3 id="在线切换步骤如下："><a href="#在线切换步骤如下：" class="headerlink" title="在线切换步骤如下："></a>在线切换步骤如下：</h3><p>首先，停掉MHA监控：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="number">192.168</span><span class="number">.0</span><span class="number">.20</span> ~]# masterha_stop --conf=/etc/masterha/app1.cnf</span><br></pre></td></tr></table></figure></p>
<p>其次，进行在线切换操作（模拟在线切换主库操作，原主库192.168.0.50变为slave，192.168.0.60提升为新的主库）<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@192.168.0.20 ~]# masterha_master_switch <span class="attribute">--conf</span>=/etc/masterha/app1.cnf <span class="attribute">--master_state</span>=alive <span class="attribute">--new_master_host</span>=192.168.0.60 <span class="attribute">--new_master_port</span>=3306 --orig_master_is_new_slave <span class="attribute">--running_updates_limit</span>=10000</span><br></pre></td></tr></table></figure></p>
<p>最后查看日志，了解切换过程，输出信息如下：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@192.168.0.20</span> <span class="string">~]#</span>  <span class="string">masterha_master_switch</span> <span class="string">--conf=/etc/masterha/app1.cnf</span> <span class="string">--master_state=alive</span> <span class="string">--new_master_host=192.168.0.60</span> <span class="string">--new_master_port=3306</span> <span class="string">--orig_master_is_new_slave</span> <span class="string">--running_updates_limit=10000</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:39</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">MHA::MasterRotate</span> <span class="string">version</span> <span class="number">0.53</span><span class="string">.</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:39</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Starting</span> <span class="string">online</span> <span class="string">master</span> <span class="string">switch..</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:39</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> </span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:39</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">*</span> <span class="attr">Phase 1:</span> <span class="string">Configuration</span> <span class="string">Check</span> <span class="string">Phase..</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:39</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> </span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:39</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Reading</span> <span class="string">default</span> <span class="string">configuratoins</span> <span class="string">from</span> <span class="string">/etc/masterha_default.cnf..</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:39</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Reading</span> <span class="string">application</span> <span class="string">default</span> <span class="string">configurations</span> <span class="string">from</span> <span class="string">/etc/masterha/app1.cnf..</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:39</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Reading</span> <span class="string">server</span> <span class="string">configurations</span> <span class="string">from</span> <span class="string">/etc/masterha/app1.cnf..</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:39</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Multi-master</span> <span class="string">configuration</span> <span class="string">is</span> <span class="string">detected.</span> <span class="string">Current</span> <span class="string">primary(writable)</span> <span class="string">master</span> <span class="string">is</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.50</span><span class="string">(192.168.0.50:3306)</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:39</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="attr">Master configurations are as below:</span> </span><br><span class="line"><span class="string">Master</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.60</span><span class="string">(192.168.0.60:3306),</span> <span class="string">replicating</span> <span class="string">from</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.50</span><span class="string">(192.168.0.50:3306),</span> <span class="string">read-only</span></span><br><span class="line"><span class="string">Master</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.50</span><span class="string">(192.168.0.50:3306),</span> <span class="string">replicating</span> <span class="string">from</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.60</span><span class="string">(192.168.0.60:3306)</span></span><br><span class="line"></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:39</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="attr">Current Alive Master:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.50</span><span class="string">(192.168.0.50:3306)</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:39</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="attr">Alive Slaves:</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:39</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>   <span class="number">192.168</span><span class="number">.0</span><span class="number">.60</span><span class="string">(192.168.0.60:3306)</span>  <span class="string">Version=5.5.19-ndb-7.2.4-gpl-log</span> <span class="string">(oldest</span> <span class="string">major</span> <span class="string">version</span> <span class="string">between</span> <span class="string">slaves)</span> <span class="string">log-bin:enabled</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:39</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>     <span class="string">Replicating</span> <span class="string">from</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.50</span><span class="string">(192.168.0.50:3306)</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:39</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>     <span class="string">Primary</span> <span class="string">candidate</span> <span class="string">for</span> <span class="string">the</span> <span class="string">new</span> <span class="string">Master</span> <span class="string">(candidate_master</span> <span class="string">is</span> <span class="string">set)</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:39</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>   <span class="number">192.168</span><span class="number">.0</span><span class="number">.70</span><span class="string">(192.168.0.70:3306)</span>  <span class="string">Version=5.5.19-ndb-7.2.4-gpl-log</span> <span class="string">(oldest</span> <span class="string">major</span> <span class="string">version</span> <span class="string">between</span> <span class="string">slaves)</span> <span class="string">log-bin:enabled</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:39</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>     <span class="string">Replicating</span> <span class="string">from</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.50</span><span class="string">(192.168.0.50:3306)</span></span><br><span class="line"></span><br><span class="line"><span class="string">It</span> <span class="string">is</span> <span class="string">better</span> <span class="string">to</span> <span class="string">execute</span> <span class="string">FLUSH</span> <span class="string">NO_WRITE_TO_BINLOG</span> <span class="string">TABLES</span> <span class="string">on</span> <span class="string">the</span> <span class="string">master</span> <span class="string">before</span> <span class="string">switching.</span> <span class="string">Is</span> <span class="string">it</span> <span class="string">ok</span> <span class="string">to</span> <span class="string">execute</span> <span class="string">on</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.50</span><span class="string">(192.168.0.50:3306)?</span> <span class="string">(YES/no):</span> <span class="literal">yes</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:40</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Executing</span> <span class="string">FLUSH</span> <span class="string">NO_WRITE_TO_BINLOG</span> <span class="string">TABLES.</span> <span class="string">This</span> <span class="string">may</span> <span class="string">take</span> <span class="string">long</span> <span class="string">time..</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:40</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>  <span class="string">ok.</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:40</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Checking</span> <span class="string">MHA</span> <span class="string">is</span> <span class="string">not</span> <span class="string">monitoring</span> <span class="string">or</span> <span class="string">doing</span> <span class="string">failover..</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:40</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Checking</span> <span class="string">replication</span> <span class="string">health</span> <span class="string">on</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.60</span><span class="string">..</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:40</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>  <span class="string">ok.</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:40</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Checking</span> <span class="string">replication</span> <span class="string">health</span> <span class="string">on</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.70</span><span class="string">..</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:40</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>  <span class="string">ok.</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:40</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.60</span> <span class="string">can</span> <span class="string">be</span> <span class="string">new</span> <span class="string">master.</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:40</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> </span><br><span class="line"><span class="attr">From:</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.0</span><span class="number">.50</span> <span class="string">(current</span> <span class="string">master)</span></span><br><span class="line"> <span class="string">+--192.168.0.60</span></span><br><span class="line"> <span class="string">+--192.168.0.70</span></span><br><span class="line"></span><br><span class="line"><span class="attr">To:</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.0</span><span class="number">.60</span> <span class="string">(new</span> <span class="string">master)</span></span><br><span class="line"> <span class="string">+--192.168.0.70</span></span><br><span class="line"> <span class="string">+--192.168.0.50</span></span><br><span class="line"></span><br><span class="line"><span class="string">Starting</span> <span class="string">master</span> <span class="string">switch</span> <span class="string">from</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.50</span><span class="string">(192.168.0.50:3306)</span> <span class="string">to</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.60</span><span class="string">(192.168.0.60:3306)?</span> <span class="string">(yes/NO):</span> <span class="literal">yes</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:41</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Checking</span> <span class="string">whether</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.60</span><span class="string">(192.168.0.60:3306)</span> <span class="string">is</span> <span class="string">ok</span> <span class="string">for</span> <span class="string">the</span> <span class="string">new</span> <span class="string">master..</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:41</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>  <span class="string">ok.</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:41</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">**</span> <span class="attr">Phase 1:</span> <span class="string">Configuration</span> <span class="string">Check</span> <span class="string">Phase</span> <span class="string">completed.</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:41</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> </span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:41</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">*</span> <span class="attr">Phase 2:</span> <span class="string">Rejecting</span> <span class="string">updates</span> <span class="string">Phase..</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:41</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> </span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:41</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="attr">Executing master ip online change script to disable write on the current master:</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:41</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>   <span class="string">/usr/local/bin/master_ip_online_change.pl</span> <span class="string">--command=stop</span> <span class="string">--orig_master_host=192.168.0.50</span> <span class="string">--orig_master_ip=192.168.0.50</span> <span class="string">--orig_master_port=3306</span> <span class="string">--new_master_host=192.168.0.60</span> <span class="string">--new_master_ip=192.168.0.60</span> <span class="string">--new_master_port=3306</span>  </span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:41</span> <span class="number">2014</span> <span class="number">714804</span> <span class="string">Set</span> <span class="string">read_only</span> <span class="string">on</span> <span class="string">the</span> <span class="string">new</span> <span class="string">master..</span> <span class="string">ok.</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:41</span> <span class="number">2014</span> <span class="number">719969</span> <span class="string">Set</span> <span class="string">read_only=1</span> <span class="string">on</span> <span class="string">the</span> <span class="string">orig</span> <span class="string">master..</span> <span class="string">ok.</span></span><br><span class="line"><span class="attr">Disabling the VIP on old master:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.50</span> </span><br><span class="line"><span class="string">reverse</span> <span class="string">mapping</span> <span class="string">checking</span> <span class="string">getaddrinfo</span> <span class="string">for</span> <span class="string">bogon</span> <span class="string">[192.168.0.50]</span> <span class="string">failed</span> <span class="bullet">-</span> <span class="string">POSSIBLE</span> <span class="string">BREAK-IN</span> <span class="string">ATTEMPT!</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:51</span> <span class="number">2014</span> <span class="number">963762</span> <span class="string">Killing</span> <span class="string">all</span> <span class="string">application</span> <span class="string">threads..</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:51</span> <span class="number">2014</span> <span class="number">963869</span> <span class="string">done.</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:51</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>  <span class="string">ok.</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:51</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Locking</span> <span class="string">all</span> <span class="string">tables</span> <span class="string">on</span> <span class="string">the</span> <span class="string">orig</span> <span class="string">master</span> <span class="string">to</span> <span class="string">reject</span> <span class="string">updates</span> <span class="string">from</span> <span class="string">everybody</span> <span class="string">(including</span> <span class="string">root):</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:51</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Executing</span> <span class="string">FLUSH</span> <span class="string">TABLES</span> <span class="string">WITH</span> <span class="string">READ</span> <span class="string">LOCK..</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:51</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>  <span class="string">ok.</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:51</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Orig</span> <span class="string">master</span> <span class="string">binlog:pos</span> <span class="string">is</span> <span class="string">mysql-bin.000028:112.</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:51</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>  <span class="string">Waiting</span> <span class="string">to</span> <span class="string">execute</span> <span class="string">all</span> <span class="string">relay</span> <span class="string">logs</span> <span class="string">on</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.60</span><span class="string">(192.168.0.60:3306)..</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:51</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>  <span class="string">master_pos_wait(mysql-bin.000028:112)</span> <span class="string">completed</span> <span class="string">on</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.60</span><span class="string">(192.168.0.60:3306).</span> <span class="string">Executed</span> <span class="number">0</span> <span class="string">events.</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:51</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>   <span class="string">done.</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:51</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Getting</span> <span class="string">new</span> <span class="string">master's</span> <span class="string">binlog</span> <span class="string">name</span> <span class="string">and</span> <span class="string">position..</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:51</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>  <span class="string">mysql-bin.000023:1550</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:51</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>  <span class="attr">All other slaves should start replication from here. Statement should be:</span> <span class="string">CHANGE</span> <span class="string">MASTER</span> <span class="string">TO</span> <span class="string">MASTER_HOST='192.168.0.60',</span> <span class="string">MASTER_PORT=3306,</span> <span class="string">MASTER_LOG_FILE='mysql-bin.000023',</span> <span class="string">MASTER_LOG_POS=1550,</span> <span class="string">MASTER_USER='repl',</span> <span class="string">MASTER_PASSWORD='xxx';</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:51</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="attr">Executing master ip online change script to allow write on the new master:</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:51</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>   <span class="string">/usr/local/bin/master_ip_online_change.pl</span> <span class="string">--command=start</span> <span class="string">--orig_master_host=192.168.0.50</span> <span class="string">--orig_master_ip=192.168.0.50</span> <span class="string">--orig_master_port=3306</span> <span class="string">--new_master_host=192.168.0.60</span> <span class="string">--new_master_ip=192.168.0.60</span> <span class="string">--new_master_port=3306</span>  </span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:27:52</span> <span class="number">2014</span> <span class="number">077334</span> <span class="string">Set</span> <span class="string">read_only=0</span> <span class="string">on</span> <span class="string">the</span> <span class="string">new</span> <span class="string">master.</span></span><br><span class="line"><span class="string">Enabling</span> <span class="string">the</span> <span class="string">VIP</span> <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.88</span><span class="string">/24</span> <span class="string">on</span> <span class="string">the</span> <span class="string">new</span> <span class="string">master</span> <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.60</span> </span><br><span class="line"><span class="string">reverse</span> <span class="string">mapping</span> <span class="string">checking</span> <span class="string">getaddrinfo</span> <span class="string">for</span> <span class="string">bogon</span> <span class="string">[192.168.0.60]</span> <span class="string">failed</span> <span class="bullet">-</span> <span class="string">POSSIBLE</span> <span class="string">BREAK-IN</span> <span class="string">ATTEMPT!</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:28:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>  <span class="string">ok.</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:28:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> </span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:28:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">*</span> <span class="string">Switching</span> <span class="string">slaves</span> <span class="string">in</span> <span class="string">parallel..</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:28:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> </span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:28:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">--</span> <span class="string">Slave</span> <span class="string">switch</span> <span class="string">on</span> <span class="string">host</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.70</span><span class="string">(192.168.0.70:3306)</span> <span class="string">started,</span> <span class="attr">pid:</span> <span class="number">3036</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:28:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> </span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:28:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Log</span> <span class="string">messages</span> <span class="string">from</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.70</span> <span class="string">...</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:28:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> </span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:28:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>  <span class="string">Waiting</span> <span class="string">to</span> <span class="string">execute</span> <span class="string">all</span> <span class="string">relay</span> <span class="string">logs</span> <span class="string">on</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.70</span><span class="string">(192.168.0.70:3306)..</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:28:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>  <span class="string">master_pos_wait(mysql-bin.000028:112)</span> <span class="string">completed</span> <span class="string">on</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.70</span><span class="string">(192.168.0.70:3306).</span> <span class="string">Executed</span> <span class="number">0</span> <span class="string">events.</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:28:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>   <span class="string">done.</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:28:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>  <span class="string">Resetting</span> <span class="string">slave</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.70</span><span class="string">(192.168.0.70:3306)</span> <span class="string">and</span> <span class="string">starting</span> <span class="string">replication</span> <span class="string">from</span> <span class="string">the</span> <span class="string">new</span> <span class="string">master</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.60</span><span class="string">(192.168.0.60:3306)..</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:28:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>  <span class="string">Executed</span> <span class="string">CHANGE</span> <span class="string">MASTER.</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:28:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>  <span class="string">Slave</span> <span class="string">started.</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:28:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">End</span> <span class="string">of</span> <span class="string">log</span> <span class="string">messages</span> <span class="string">from</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.70</span> <span class="string">...</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:28:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> </span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:28:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">--</span> <span class="string">Slave</span> <span class="string">switch</span> <span class="string">on</span> <span class="string">host</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.70</span><span class="string">(192.168.0.70:3306)</span> <span class="string">succeeded.</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:28:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="attr">Unlocking all tables on the orig master:</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:28:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Executing</span> <span class="string">UNLOCK</span> <span class="string">TABLES..</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:28:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>  <span class="string">ok.</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:28:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Starting</span> <span class="string">orig</span> <span class="string">master</span> <span class="string">as</span> <span class="string">a</span> <span class="string">new</span> <span class="string">slave..</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:28:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>  <span class="string">Resetting</span> <span class="string">slave</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.50</span><span class="string">(192.168.0.50:3306)</span> <span class="string">and</span> <span class="string">starting</span> <span class="string">replication</span> <span class="string">from</span> <span class="string">the</span> <span class="string">new</span> <span class="string">master</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.60</span><span class="string">(192.168.0.60:3306)..</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:28:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>  <span class="string">Executed</span> <span class="string">CHANGE</span> <span class="string">MASTER.</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:28:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>  <span class="string">Slave</span> <span class="string">started.</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:28:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">All</span> <span class="string">new</span> <span class="string">slave</span> <span class="string">servers</span> <span class="string">switched</span> <span class="string">successfully.</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:28:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> </span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:28:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">*</span> <span class="attr">Phase 5:</span> <span class="string">New</span> <span class="string">master</span> <span class="string">cleanup</span> <span class="string">phease..</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:28:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> </span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:28:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span>  <span class="attr">192.168.0.60:</span> <span class="string">Resetting</span> <span class="string">slave</span> <span class="string">info</span> <span class="string">succeeded.</span></span><br><span class="line"><span class="string">Wed</span> <span class="string">Apr</span> <span class="number">23</span> <span class="number">00</span><span class="string">:28:02</span> <span class="number">2014</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Switching</span> <span class="string">master</span> <span class="string">to</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.60</span><span class="string">(192.168.0.60:3306)</span> <span class="string">completed</span> <span class="string">successfully.</span></span><br></pre></td></tr></table></figure></p>
<p>其中参数的意思：<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--orig_master_is_new_slave 切换时加上此参数是将原 <span class="keyword">master</span> <span class="title">变为 slave</span> 节点，如果不加此参数，原来的 <span class="keyword">master</span> <span class="title">将不启动</span></span><br><span class="line"><span class="title"></span></span><br><span class="line"><span class="title">--running_updates_limit</span>=<span class="number">10000</span>,故障切换时,候选<span class="keyword">master</span> <span class="title">如果有延迟的话， mha</span> 切换不能成功，加上此参数表示延迟在此时间范围内都可切换（单位为s），但是切换的时间长短是由recover 时relay 日志的大小决定</span><br></pre></td></tr></table></figure></p>
<p><font color="red">注意：由于在线进行切换需要调用到master_ip_online_change这个脚本，但是由于该脚本不完整，需要自己进行相应的修改，我google到后发现还是有问题，脚本中new_master_password这个变量获取不到，导致在线切换失败，所以进行了相关的硬编码，直接把mysql的root用户密码赋值给变量new_master_password，如果有哪位大牛知道原因，请指点指点。这个脚本还可以管理vip。下面贴出脚本：</font><br><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env perl</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  Copyright (C) 2011 DeNA Co.,Ltd.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  This program is free software; you can redistribute it and/or modify</span></span><br><span class="line"><span class="comment">#  it under the terms of the GNU General Public License as published by</span></span><br><span class="line"><span class="comment">#  the Free Software Foundation; either version 2 of the License, or</span></span><br><span class="line"><span class="comment">#  (at your option) any later version.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  This program is distributed in the hope that it will be useful,</span></span><br><span class="line"><span class="comment">#  but WITHOUT ANY WARRANTY; without even the implied warranty of</span></span><br><span class="line"><span class="comment">#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></span><br><span class="line"><span class="comment">#  GNU General Public License for more details.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  You should have received a copy of the GNU General Public License</span></span><br><span class="line"><span class="comment">#   along with this program; if not, write to the Free Software</span></span><br><span class="line"><span class="comment">#  Foundation, Inc.,</span></span><br><span class="line"><span class="comment">#  51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Note: This is a sample script and is not complete. Modify the script based on your environment.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> strict;</span><br><span class="line"><span class="keyword">use</span> warnings <span class="string">FATAL =&gt;</span> <span class="string">'all'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> Getopt::Long;</span><br><span class="line"><span class="keyword">use</span> MHA::DBHelper;</span><br><span class="line"><span class="keyword">use</span> MHA::NodeUtil;</span><br><span class="line"><span class="keyword">use</span> Time::HiRes <span class="string">qw( sleep gettimeofday tv_interval )</span>;</span><br><span class="line"><span class="keyword">use</span> Data::Dumper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">my</span> $_tstart;</span><br><span class="line"><span class="keyword">my</span> $_running_interval = <span class="number">0</span>.<span class="number">1</span>;</span><br><span class="line"><span class="keyword">my</span> (</span><br><span class="line">  $command,          $orig_master_host, $orig_master_ip,</span><br><span class="line">  $orig_master_port, $orig_master_user, </span><br><span class="line">  $new_master_host,  $new_master_ip,    $new_master_port,</span><br><span class="line">  $new_master_user,  </span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">my</span> $vip = <span class="string">'192.168.0.88/24'</span>;  <span class="comment"># Virtual IP </span></span><br><span class="line"><span class="keyword">my</span> $key = <span class="string">"1"</span>; </span><br><span class="line"><span class="keyword">my</span> $ssh_start_vip = <span class="string">"/sbin/ifconfig eth1:$key $vip"</span>;</span><br><span class="line"><span class="keyword">my</span> $ssh_stop_vip = <span class="string">"/sbin/ifconfig eth1:$key down"</span>;</span><br><span class="line"><span class="keyword">my</span> $ssh_user = <span class="string">"root"</span>;</span><br><span class="line"><span class="keyword">my</span> $new_master_password=<span class="string">'123456'</span>;</span><br><span class="line"><span class="keyword">my</span> $orig_master_password=<span class="string">'123456'</span>;</span><br><span class="line">GetOptions(</span><br><span class="line">  <span class="string">'command=s'</span>              =&gt; \$command,</span><br><span class="line">  <span class="comment">#'ssh_user=s'             =&gt; \$ssh_user,  </span></span><br><span class="line">  <span class="string">'orig_master_host=s'</span>     =&gt; \$orig_master_host,</span><br><span class="line">  <span class="string">'orig_master_ip=s'</span>       =&gt; \$orig_master_ip,</span><br><span class="line">  <span class="string">'orig_master_port=i'</span>     =&gt; \$orig_master_port,</span><br><span class="line">  <span class="string">'orig_master_user=s'</span>     =&gt; \$orig_master_user,</span><br><span class="line">  <span class="comment">#'orig_master_password=s' =&gt; \$orig_master_password,</span></span><br><span class="line">  <span class="string">'new_master_host=s'</span>      =&gt; \$new_master_host,</span><br><span class="line">  <span class="string">'new_master_ip=s'</span>        =&gt; \$new_master_ip,</span><br><span class="line">  <span class="string">'new_master_port=i'</span>      =&gt; \$new_master_port,</span><br><span class="line">  <span class="string">'new_master_user=s'</span>      =&gt; \$new_master_user,</span><br><span class="line">  <span class="comment">#'new_master_password=s'  =&gt; \$new_master_password,</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">exit</span> &amp;main();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">current_time_us</span> </span>&#123;</span><br><span class="line">  <span class="keyword">my</span> ( $sec, $microsec ) = gettimeofday();</span><br><span class="line">  <span class="keyword">my</span> $curdate = <span class="keyword">localtime</span>($sec);</span><br><span class="line">  <span class="keyword">return</span> $curdate . <span class="string">" "</span> . <span class="keyword">sprintf</span>( <span class="string">"%06d"</span>, $microsec );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">sleep_until</span> </span>&#123;</span><br><span class="line">  <span class="keyword">my</span> $elapsed = tv_interval($_tstart);</span><br><span class="line">  <span class="keyword">if</span> ( $_running_interval &gt; $elapsed ) &#123;</span><br><span class="line">    <span class="keyword">sleep</span>( $_running_interval - $elapsed );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">get_threads_util</span> </span>&#123;</span><br><span class="line">  <span class="keyword">my</span> $dbh                    = <span class="keyword">shift</span>;</span><br><span class="line">  <span class="keyword">my</span> $my_connection_id       = <span class="keyword">shift</span>;</span><br><span class="line">  <span class="keyword">my</span> $running_time_threshold = <span class="keyword">shift</span>;</span><br><span class="line">  <span class="keyword">my</span> $type                   = <span class="keyword">shift</span>;</span><br><span class="line">  $running_time_threshold = <span class="number">0</span> <span class="keyword">unless</span> ($running_time_threshold);</span><br><span class="line">  $type                   = <span class="number">0</span> <span class="keyword">unless</span> ($type);</span><br><span class="line">  <span class="keyword">my</span> @threads;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">my</span> $sth = $dbh-&gt;prepare(<span class="string">"SHOW PROCESSLIST"</span>);</span><br><span class="line">  $sth-&gt;execute();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> ( <span class="keyword">my</span> $ref = $sth-&gt;fetchrow_hashref() ) &#123;</span><br><span class="line">    <span class="keyword">my</span> $id         = $ref-&gt;&#123;Id&#125;;</span><br><span class="line">    <span class="keyword">my</span> $user       = $ref-&gt;&#123;User&#125;;</span><br><span class="line">    <span class="keyword">my</span> $host       = $ref-&gt;&#123;Host&#125;;</span><br><span class="line">    <span class="keyword">my</span> $command    = $ref-&gt;&#123;Command&#125;;</span><br><span class="line">    <span class="keyword">my</span> $state      = $ref-&gt;&#123;State&#125;;</span><br><span class="line">    <span class="keyword">my</span> $query_time = $ref-&gt;&#123;Time&#125;;</span><br><span class="line">    <span class="keyword">my</span> $info       = $ref-&gt;&#123;Info&#125;;</span><br><span class="line">    $info =~ <span class="regexp">s/^\s*(.*?)\s*$/$1/</span> <span class="keyword">if</span> <span class="keyword">defined</span>($info);</span><br><span class="line">    <span class="keyword">next</span> <span class="keyword">if</span> ( $my_connection_id == $id );</span><br><span class="line">    <span class="keyword">next</span> <span class="keyword">if</span> ( <span class="keyword">defined</span>($query_time) &amp;&amp; $query_time &lt; $running_time_threshold );</span><br><span class="line">    <span class="keyword">next</span> <span class="keyword">if</span> ( <span class="keyword">defined</span>($command)    &amp;&amp; $command eq <span class="string">"Binlog Dump"</span> );</span><br><span class="line">    <span class="keyword">next</span> <span class="keyword">if</span> ( <span class="keyword">defined</span>($user)       &amp;&amp; $user eq <span class="string">"system user"</span> );</span><br><span class="line">    <span class="keyword">next</span></span><br><span class="line">      <span class="keyword">if</span> ( <span class="keyword">defined</span>($command)</span><br><span class="line">      &amp;&amp; $command eq <span class="string">"Sleep"</span></span><br><span class="line">      &amp;&amp; <span class="keyword">defined</span>($query_time)</span><br><span class="line">      &amp;&amp; $query_time &gt;= <span class="number">1</span> );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( $type &gt;= <span class="number">1</span> ) &#123;</span><br><span class="line">      <span class="keyword">next</span> <span class="keyword">if</span> ( <span class="keyword">defined</span>($command) &amp;&amp; $command eq <span class="string">"Sleep"</span> );</span><br><span class="line">      <span class="keyword">next</span> <span class="keyword">if</span> ( <span class="keyword">defined</span>($command) &amp;&amp; $command eq <span class="string">"Connect"</span> );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( $type &gt;= <span class="number">2</span> ) &#123;</span><br><span class="line">      <span class="keyword">next</span> <span class="keyword">if</span> ( <span class="keyword">defined</span>($info) &amp;&amp; $info =~ <span class="regexp">m/^select/i</span> );</span><br><span class="line">      <span class="keyword">next</span> <span class="keyword">if</span> ( <span class="keyword">defined</span>($info) &amp;&amp; $info =~ <span class="regexp">m/^show/i</span> );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">push</span> @threads, $ref;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> @threads;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">main</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( $command eq <span class="string">"stop"</span> ) &#123;</span><br><span class="line">    <span class="comment">## Gracefully killing connections on the current master</span></span><br><span class="line">    <span class="comment"># 1. Set read_only= 1 on the new master</span></span><br><span class="line">    <span class="comment"># 2. DROP USER so that no app user can establish new connections</span></span><br><span class="line">    <span class="comment"># 3. Set read_only= 1 on the current master</span></span><br><span class="line">    <span class="comment"># 4. Kill current queries</span></span><br><span class="line">    <span class="comment"># * Any database access failure will result in script die.</span></span><br><span class="line">    <span class="keyword">my</span> $exit_code = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">eval</span> &#123;</span><br><span class="line">      <span class="comment">## Setting read_only=1 on the new master (to avoid accident)</span></span><br><span class="line">      <span class="keyword">my</span> $new_master_handler = new MHA::DBHelper();</span><br><span class="line"></span><br><span class="line">      <span class="comment"># args: hostname, port, user, password, raise_error(die_on_error)_or_not</span></span><br><span class="line">      $new_master_handler-&gt;<span class="keyword">connect</span>( $new_master_ip, $new_master_port,</span><br><span class="line">        $new_master_user, $new_master_password, <span class="number">1</span> );</span><br><span class="line">      <span class="keyword">print</span> current_time_us() . <span class="string">" Set read_only on the new master.. "</span>;</span><br><span class="line">      $new_master_handler-&gt;enable_read_only();</span><br><span class="line">      <span class="keyword">if</span> ( $new_master_handler-&gt;is_read_only() ) &#123;</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"ok.\n"</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">die</span> <span class="string">"Failed!\n"</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      $new_master_handler-&gt;disconnect();</span><br><span class="line"></span><br><span class="line">      <span class="comment"># Connecting to the orig master, die if any database error happens</span></span><br><span class="line">      <span class="keyword">my</span> $orig_master_handler = new MHA::DBHelper();</span><br><span class="line">      $orig_master_handler-&gt;<span class="keyword">connect</span>( $orig_master_ip, $orig_master_port,</span><br><span class="line">        $orig_master_user, $orig_master_password, <span class="number">1</span> );</span><br><span class="line"></span><br><span class="line">      <span class="comment">## Drop application user so that nobody can connect. Disabling per-session binlog beforehand</span></span><br><span class="line">      <span class="comment">#$orig_master_handler-&gt;disable_log_bin_local();</span></span><br><span class="line">      <span class="comment">#print current_time_us() . " Drpping app user on the orig master..\n";</span></span><br><span class="line">      <span class="comment">#FIXME_xxx_drop_app_user($orig_master_handler);</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">## Waiting for N * 100 milliseconds so that current connections can exit</span></span><br><span class="line">      <span class="keyword">my</span> $time_until_read_only = <span class="number">15</span>;</span><br><span class="line">      $_tstart = [gettimeofday];</span><br><span class="line">      <span class="keyword">my</span> @threads = get_threads_util( $orig_master_handler-&gt;&#123;dbh&#125;,</span><br><span class="line">        $orig_master_handler-&gt;&#123;connection_id&#125; );</span><br><span class="line">      <span class="keyword">while</span> ( $time_until_read_only &gt; <span class="number">0</span> &amp;&amp; $#threads &gt;= <span class="number">0</span> ) &#123;</span><br><span class="line">        <span class="keyword">if</span> ( $time_until_read_only % <span class="number">5</span> == <span class="number">0</span> ) &#123;</span><br><span class="line">          <span class="keyword">printf</span></span><br><span class="line"><span class="string">"%s Waiting all running %d threads are disconnected.. (max %d milliseconds)\n"</span>,</span><br><span class="line">            current_time_us(), $#threads + <span class="number">1</span>, $time_until_read_only * <span class="number">100</span>;</span><br><span class="line">          <span class="keyword">if</span> ( $#threads &lt; <span class="number">5</span> ) &#123;</span><br><span class="line">            <span class="keyword">print</span> Data::Dumper-&gt;new( [$_] )-&gt;Indent(<span class="number">0</span>)-&gt;Terse(<span class="number">1</span>)-&gt;Dump . <span class="string">"\n"</span></span><br><span class="line">              <span class="keyword">foreach</span> (@threads);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        sleep_until();</span><br><span class="line">        $_tstart = [gettimeofday];</span><br><span class="line">        $time_until_read_only--;</span><br><span class="line">        @threads = get_threads_util( $orig_master_handler-&gt;&#123;dbh&#125;,</span><br><span class="line">          $orig_master_handler-&gt;&#123;connection_id&#125; );</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">## Setting read_only=1 on the current master so that nobody(except SUPER) can write</span></span><br><span class="line">      <span class="keyword">print</span> current_time_us() . <span class="string">" Set read_only=1 on the orig master.. "</span>;</span><br><span class="line">      $orig_master_handler-&gt;enable_read_only();</span><br><span class="line">      <span class="keyword">if</span> ( $orig_master_handler-&gt;is_read_only() ) &#123;</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"ok.\n"</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">die</span> <span class="string">"Failed!\n"</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">## Waiting for M * 100 milliseconds so that current update queries can complete</span></span><br><span class="line">      <span class="keyword">my</span> $time_until_kill_threads = <span class="number">5</span>;</span><br><span class="line">      @threads = get_threads_util( $orig_master_handler-&gt;&#123;dbh&#125;,</span><br><span class="line">        $orig_master_handler-&gt;&#123;connection_id&#125; );</span><br><span class="line">      <span class="keyword">while</span> ( $time_until_kill_threads &gt; <span class="number">0</span> &amp;&amp; $#threads &gt;= <span class="number">0</span> ) &#123;</span><br><span class="line">        <span class="keyword">if</span> ( $time_until_kill_threads % <span class="number">5</span> == <span class="number">0</span> ) &#123;</span><br><span class="line">          <span class="keyword">printf</span></span><br><span class="line"><span class="string">"%s Waiting all running %d queries are disconnected.. (max %d milliseconds)\n"</span>,</span><br><span class="line">            current_time_us(), $#threads + <span class="number">1</span>, $time_until_kill_threads * <span class="number">100</span>;</span><br><span class="line">          <span class="keyword">if</span> ( $#threads &lt; <span class="number">5</span> ) &#123;</span><br><span class="line">            <span class="keyword">print</span> Data::Dumper-&gt;new( [$_] )-&gt;Indent(<span class="number">0</span>)-&gt;Terse(<span class="number">1</span>)-&gt;Dump . <span class="string">"\n"</span></span><br><span class="line">              <span class="keyword">foreach</span> (@threads);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        sleep_until();</span><br><span class="line">        $_tstart = [gettimeofday];</span><br><span class="line">        $time_until_kill_threads--;</span><br><span class="line">        @threads = get_threads_util( $orig_master_handler-&gt;&#123;dbh&#125;,</span><br><span class="line">          $orig_master_handler-&gt;&#123;connection_id&#125; );</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="keyword">print</span> <span class="string">"Disabling the VIP on old master: $orig_master_host \n"</span>;</span><br><span class="line">                &amp;stop_vip();     </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="comment">## Terminating all threads</span></span><br><span class="line">      <span class="keyword">print</span> current_time_us() . <span class="string">" Killing all application threads..\n"</span>;</span><br><span class="line">      $orig_master_handler-&gt;kill_threads(@threads) <span class="keyword">if</span> ( $#threads &gt;= <span class="number">0</span> );</span><br><span class="line">      <span class="keyword">print</span> current_time_us() . <span class="string">" done.\n"</span>;</span><br><span class="line">      <span class="comment">#$orig_master_handler-&gt;enable_log_bin_local();</span></span><br><span class="line">      $orig_master_handler-&gt;disconnect();</span><br><span class="line"></span><br><span class="line">      <span class="comment">## After finishing the script, MHA executes FLUSH TABLES WITH READ LOCK</span></span><br><span class="line">      $exit_code = <span class="number">0</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> ($@) &#123;</span><br><span class="line">      <span class="keyword">warn</span> <span class="string">"Got Error: $@\n"</span>;</span><br><span class="line">      <span class="keyword">exit</span> $exit_code;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">exit</span> $exit_code;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">elsif</span> ( $command eq <span class="string">"start"</span> ) &#123;</span><br><span class="line">    <span class="comment">## Activating master ip on the new master</span></span><br><span class="line">    <span class="comment"># 1. Create app user with write privileges</span></span><br><span class="line">    <span class="comment"># 2. Moving backup script if needed</span></span><br><span class="line">    <span class="comment"># 3. Register new master's ip to the catalog database</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># We don't return error even though activating updatable accounts/ip failed so that we don't interrupt slaves' recovery.</span></span><br><span class="line"><span class="comment"># If exit code is 0 or 10, MHA does not abort</span></span><br><span class="line">    <span class="keyword">my</span> $exit_code = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">eval</span> &#123;</span><br><span class="line">      <span class="keyword">my</span> $new_master_handler = new MHA::DBHelper();</span><br><span class="line"></span><br><span class="line">      <span class="comment"># args: hostname, port, user, password, raise_error_or_not</span></span><br><span class="line">      $new_master_handler-&gt;<span class="keyword">connect</span>( $new_master_ip, $new_master_port,</span><br><span class="line">        $new_master_user, $new_master_password, <span class="number">1</span> );</span><br><span class="line"></span><br><span class="line">      <span class="comment">## Set read_only=0 on the new master</span></span><br><span class="line">      <span class="comment">#$new_master_handler-&gt;disable_log_bin_local();</span></span><br><span class="line">      <span class="keyword">print</span> current_time_us() . <span class="string">" Set read_only=0 on the new master.\n"</span>;</span><br><span class="line">      $new_master_handler-&gt;disable_read_only();</span><br><span class="line"></span><br><span class="line">      <span class="comment">## Creating an app user on the new master</span></span><br><span class="line">      <span class="comment">#print current_time_us() . " Creating app user on the new master..\n";</span></span><br><span class="line">      <span class="comment">#FIXME_xxx_create_app_user($new_master_handler);</span></span><br><span class="line">      <span class="comment">#$new_master_handler-&gt;enable_log_bin_local();</span></span><br><span class="line">      $new_master_handler-&gt;disconnect();</span><br><span class="line"></span><br><span class="line">      <span class="comment">## Update master ip on the catalog database, etc</span></span><br><span class="line">                <span class="keyword">print</span> <span class="string">"Enabling the VIP - $vip on the new master - $new_master_host \n"</span>;</span><br><span class="line">                &amp;start_vip();</span><br><span class="line">                $exit_code = <span class="number">0</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> ($@) &#123;</span><br><span class="line">      <span class="keyword">warn</span> <span class="string">"Got Error: $@\n"</span>;</span><br><span class="line">      <span class="keyword">exit</span> $exit_code;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">exit</span> $exit_code;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">elsif</span> ( $command eq <span class="string">"status"</span> ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># do nothing</span></span><br><span class="line">    <span class="keyword">exit</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    &amp;usage();</span><br><span class="line">    <span class="keyword">exit</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># A simple system call that enable the VIP on the new master </span></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">start_vip</span>() </span>&#123;</span><br><span class="line">    <span class="string">`ssh $ssh_user\@$new_master_host \" $ssh_start_vip \"`</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># A simple system call that disable the VIP on the old_master</span></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">stop_vip</span>() </span>&#123;</span><br><span class="line">    <span class="string">`ssh $ssh_user\@$orig_master_host \" $ssh_stop_vip \"`</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">usage</span> </span>&#123;</span><br><span class="line">  <span class="keyword">print</span></span><br><span class="line"><span class="string">"Usage: master_ip_online_change --command=start|stop|status --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\n"</span>;</span><br><span class="line">  <span class="keyword">die</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="四-修复宕机的Master"><a href="#四-修复宕机的Master" class="headerlink" title="四.修复宕机的Master"></a>四.修复宕机的Master</h2><p>通常情况下自动切换以后，原master可能已经废弃掉，待原master主机修复后，如果数据完整的情况下，可能想把原来master重新作为新主库的slave，这时我们可以借助当时自动切换时刻的MHA日志来完成对原master的修复。下面是提取相关日志的命令：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@192.168.0.20 app1]# grep -i <span class="string">"All other slaves should start"</span> manager.log </span><br><span class="line">Mon Apr 21 22:28:33 2014 - [<span class="builtin-name">info</span>]  All other slaves should start replication <span class="keyword">from</span> here. Statement should be: CHANGE MASTER <span class="keyword">TO</span> <span class="attribute">MASTER_HOST</span>=<span class="string">'192.168.0.60'</span>, <span class="attribute">MASTER_PORT</span>=3306, <span class="attribute">MASTER_LOG_FILE</span>=<span class="string">'mysql-bin.000022'</span>, <span class="attribute">MASTER_LOG_POS</span>=506716, <span class="attribute">MASTER_USER</span>=<span class="string">'repl'</span>, <span class="attribute">MASTER_PASSWORD</span>=<span class="string">'xxx'</span>;</span><br><span class="line">[root@192.168.0.20 app1]#</span><br></pre></td></tr></table></figure></p>
<p>获取上述信息以后，就可以直接在修复后的master上执行change master to相关操作，重新作为从库了。</p>
<p>最后补充一下邮件发送脚本send_report ，这个脚本在询问一位朋友后可以使用，如下：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/perl</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  Copyright (C) 2011 DeNA Co.,Ltd.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  This program is free software; you can redistribute it and/or modify</span></span><br><span class="line"><span class="comment">#  it under the terms of the GNU General Public License as published by</span></span><br><span class="line"><span class="comment">#  the Free Software Foundation; either version 2 of the License, or</span></span><br><span class="line"><span class="comment">#  (at your option) any later version.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  This program is distributed in the hope that it will be useful,</span></span><br><span class="line"><span class="comment">#  but WITHOUT ANY WARRANTY; without even the implied warranty of</span></span><br><span class="line"><span class="comment">#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></span><br><span class="line"><span class="comment">#  GNU General Public License for more details.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  You should have received a copy of the GNU General Public License</span></span><br><span class="line"><span class="comment">#   along with this program; if not, write to the Free Software</span></span><br><span class="line"><span class="comment">#  Foundation, Inc.,</span></span><br><span class="line"><span class="comment">#  51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## <span class="doctag">Note:</span> This is a sample script and is not complete. Modify the script based on your environment.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">strict</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">warnings</span> <span class="title">FATAL</span> =&gt; '<span class="title">all</span>';</span><br><span class="line"><span class="keyword">use</span> <span class="title">Mail</span>::<span class="title">Sender</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Getopt</span>::<span class="title">Long</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#new_master_host and new_slave_hosts are set only when recovering master succeeded</span></span><br><span class="line">my ( $dead_master_host, $new_master_host, $new_slave_hosts, $subject, $body );</span><br><span class="line">my $smtp=<span class="string">'smtp.163.com'</span>;</span><br><span class="line">my $mail_from=<span class="string">'xxxx'</span>;</span><br><span class="line">my $mail_user=<span class="string">'xxxxx'</span>;</span><br><span class="line">my $mail_pass=<span class="string">'xxxxx'</span>;</span><br><span class="line">my $mail_to=[<span class="string">'xxxx'</span>,<span class="string">'xxxx'</span>];</span><br><span class="line">GetOptions(</span><br><span class="line">  <span class="string">'orig_master_host=s'</span> =&gt; \$dead_master_host,</span><br><span class="line">  <span class="string">'new_master_host=s'</span>  =&gt; \$new_master_host,</span><br><span class="line">  <span class="string">'new_slave_hosts=s'</span>  =&gt; \$new_slave_hosts,</span><br><span class="line">  <span class="string">'subject=s'</span>          =&gt; \$subject,</span><br><span class="line">  <span class="string">'body=s'</span>             =&gt; \$body,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">mailToContacts($smtp,$mail_from,$mail_user,$mail_pass,$mail_to,$subject,$body);</span><br><span class="line"></span><br><span class="line">sub mailToContacts &#123;</span><br><span class="line">    my ( $smtp, $mail_from, $user, $passwd, $mail_to, $subject, $msg ) = @_;</span><br><span class="line">    open my $DEBUG, <span class="string">"&gt; /tmp/monitormail.log"</span></span><br><span class="line">        <span class="keyword">or</span> <span class="keyword">die</span> <span class="string">"Can't open the debug      file:$!\n"</span>;</span><br><span class="line">    my $sender = <span class="keyword">new</span> Mail::Sender &#123;</span><br><span class="line">        ctype       =&gt; <span class="string">'text/plain; charset=utf-8'</span>,</span><br><span class="line">        encoding    =&gt; <span class="string">'utf-8'</span>,</span><br><span class="line">        smtp        =&gt; $smtp,</span><br><span class="line">        from        =&gt; $mail_from,</span><br><span class="line">        auth        =&gt; <span class="string">'LOGIN'</span>,</span><br><span class="line">        TLS_allowed =&gt; <span class="string">'0'</span>,</span><br><span class="line">        authid      =&gt; $user,</span><br><span class="line">        authpwd     =&gt; $passwd,</span><br><span class="line">        to          =&gt; $mail_to,</span><br><span class="line">        subject     =&gt; $subject,</span><br><span class="line">        debug       =&gt; $DEBUG</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    $sender-&gt;MailMsg(</span><br><span class="line">        &#123;   msg   =&gt; $msg,</span><br><span class="line">            debug =&gt; $DEBUG</span><br><span class="line">        &#125;</span><br><span class="line">    ) <span class="keyword">or</span> <span class="keyword">print</span> $Mail::Sender::Error;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Do whatever you want here</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">exit</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure></p>
<p>最后切换以后发送告警的邮件示例，注意，这个是我后续的测试，和上面环境出现的ip不一致不要在意。</p>
<h2 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h2><p>目前高可用方案可以一定程度上实现数据库的高可用，比如MMM，<a href="http://www.cnblogs.com/gomysql/p/3674030.html" target="_blank" rel="noopener">heartbeat+drbd</a>，Cluster等。还有percona的Galera Cluster等。这些高可用软件各有优劣。在进行高可用方案选择时，主要是看业务还有对数据一致性方面的要求。最后出于对数据库的高可用和数据一致性的要求，推荐使用MHA架构。</p>
</span>
      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/MHA/" rel="tag">#MHA</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/03/02/shell_expect/" rel="prev">
                <i class="fa fa-chevron-left"></i> shell中调用expect
              </a>
            
          </div>

          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/02/17/python生成器/" rel="next">
                python生成器 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
  <a class="jiathis_button_tsina"></a>
  <a class="jiathis_button_tqq"></a>
  <a class="jiathis_button_weixin"></a>
  <a class="jiathis_button_cqq"></a>
  <a class="jiathis_button_douban"></a>
  <a class="jiathis_button_renren"></a>
  <a class="jiathis_button_qzone"></a>
  <a class="jiathis_button_kaixin001"></a>
  <a class="jiathis_button_copy"></a>
  <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
  <a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript">
  var jiathis_config={
    hideMore:false
  }
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
<!-- JiaThis Button END -->

      
    </div>
  </div>

 </div>

        

        
          <div class="comments" id="comments">
            
              <div class="ds-thread" data-thread-key="2016/02/26/mysql_MHA/" data-title="MHA" data-url="http://leichongxiang.github.io/2016/02/26/mysql_MHA/">
              </div>
            
          </div>
        
      </div>

      
        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="http://ww3.sinaimg.cn/large/8e712944jw1exen95p8hej208c08cq4u.jpg" alt="Vike Lee" itemprop="image">
          <p class="site-author-name" itemprop="name">Vike Lee</p>
        </div>
        <p class="site-description motion-element" itemprop="description">记录时间</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">63</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">15</span>
              <span class="site-state-item-name">分类</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">46</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        

<! -- 添加微信图标 -->
    
<! -- 完成 -->

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/leichongxiang/" target="_blank">
                  <i class="fa fa-github"></i> github
                </a>
              </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="http://creativecommons.org/licenses/by-nc-sa/4.0" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons">
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            <p class="site-author-name">友情链接</p>
            
              <span class="links-of-author-item">
                <a href="http://macshuo.com/" target="_blank">MacTalk</a>
              </span>
            
          
        </div>

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator"></div>
          <div class="post-toc">
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#简介："><span class="nav-number">1.</span> <span class="nav-text">简介：</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-部署MHA"><span class="nav-number">1.1.</span> <span class="nav-text">1.部署MHA</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-安装MHA-Manager"><span class="nav-number">1.2.</span> <span class="nav-text">2.安装MHA Manager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-配置SSH登录无密码验证（使用key登录，工作中常用）"><span class="nav-number">1.3.</span> <span class="nav-text">3.配置SSH登录无密码验证（使用key登录，工作中常用）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-搭建主从复制环境"><span class="nav-number">1.4.</span> <span class="nav-text">4.搭建主从复制环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-配置MHA"><span class="nav-number">1.5.</span> <span class="nav-text">5.配置MHA</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-检查SSH配置"><span class="nav-number">1.6.</span> <span class="nav-text">6.检查SSH配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-检查整个复制环境状况。"><span class="nav-number">1.7.</span> <span class="nav-text">7.检查整个复制环境状况。</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-检查MHA-Manager的状态："><span class="nav-number">1.8.</span> <span class="nav-text">8.检查MHA Manager的状态：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-开启MHA-Manager监控"><span class="nav-number">1.9.</span> <span class="nav-text">9.开启MHA Manager监控</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-通过脚本的方式管理VIP"><span class="nav-number">1.9.1.</span> <span class="nav-text">2.通过脚本的方式管理VIP</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#一-自动Failover"><span class="nav-number">2.</span> <span class="nav-text">一.自动Failover</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二-手动Failover（MHA-Manager必须没有运行）"><span class="nav-number">3.</span> <span class="nav-text">二.手动Failover（MHA Manager必须没有运行）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#在线切换步骤如下："><span class="nav-number">3.1.</span> <span class="nav-text">在线切换步骤如下：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#四-修复宕机的Master"><span class="nav-number">4.</span> <span class="nav-text">四.修复宕机的Master</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结："><span class="nav-number">5.</span> <span class="nav-text">总结：</span></a></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator"></div>
        </section>
      

    </div>
  </aside>


      
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner"> <div class="copyright">
  
  &copy;  2015 - 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Vike Lee</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


 </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  
  
    

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"leicx"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>
    
     

    
  
  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.2"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.2"></script>
  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/js/motion_global.js?v=0.4.5.2" id="motion.global"></script>




  <script type="text/javascript" src="/js/nav-toggle.js?v=0.4.5.2"></script>
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  
<script type="text/javascript" src="/js/bootstrap.scrollspy.js?v=0.4.5.2" id="bootstrap.scrollspy.custom"></script>


<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 0.4 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    var $tocContent = $('.post-toc-content');
    if (isDesktop() && CONFIG.sidebar === 'post') {
      if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
        displaySidebar();
      }
    }
  });
</script>



  <script type="text/javascript">
    $(document).ready(function () {
      if (CONFIG.sidebar === 'always') {
        displaySidebar();
      }
      if (isMobile()) {
        FastClick.attach(document.body);
      }

      motionIntegrator.bootstrap();
    });
  </script>

  
  
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
  });
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for (i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


  
  

  
  <script type="text/javascript" src="/js/lazyload.js"></script>
  <script type="text/javascript">
    $(function () {
      $("#posts").find('img').lazyload({
        placeholder: "/images/loading.gif",
        effect: "fadeIn"
      });
    });
  </script>
  
    	 <!-- custom analytics part  --> 
<script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
<script>AV.initialize("mWA1nE7gcYVszHzU3BxSMc1a-gzGzoHsz", "4zH2GdGce6gOiDRfhcomjPBU");</script>
<script>
function showTime(Counter) {
  var query = new AV.Query(Counter);
  $(".leancloud_visitors").each(function() {
    var url = $(this).attr("id").trim();
    query.equalTo("url", url);
    query.find({
      success: function(results) {
        if (results.length == 0) {
          var content = $(document.getElementById(url)).text() + ': 0';
          $(document.getElementById(url)).text(content);
          return;
        }
        for (var i = 0; i < results.length; i++) {
          var object = results[i];
          var content = $(document.getElementById(url)).text() + ': ' + object.get('time');
          $(document.getElementById(url)).text(content);
        }
      },
      error: function(object, error) {
        console.log("Error: " + error.code + " " + error.message);
      }
    });

  });
}

function addCount(Counter) {
  var Counter = AV.Object.extend("Counter");
  url = $(".leancloud_visitors").attr('id').trim();
  title = $(".leancloud_visitors").attr('data-flag-title').trim();
  var query = new AV.Query(Counter);
  query.equalTo("url", url);
  query.find({
    success: function(results) {
      if (results.length > 0) {
        var counter = results[0];
        counter.fetchWhenSave(true);
        counter.increment("time");
        counter.save(null, {
          success: function(counter) {
            var content = $(document.getElementById(url)).text() + ': ' + counter.get('time');
            $(document.getElementById(url)).text(content);
          },
          error: function(counter, error) {
            console.log('Failed to save Visitor num, with error message: ' + error.message);
          }
        });
      } else {
        var newcounter = new Counter();
        newcounter.set("title", title);
        newcounter.set("url", url);
        newcounter.set("time", 1);
        newcounter.save(null, {
          success: function(newcounter) {
              console.log("newcounter.get('time')="+newcounter.get('time'));
            var content = $(document.getElementById(url)).text() + ': ' + newcounter.get('time');
            $(document.getElementById(url)).text(content);
          },
          error: function(newcounter, error) {
            console.log('Failed to create');
          }
        });
      }
    },
    error: function(error) {
      console.log('Error:' + error.code + " " + error.message);
    }
  });
}
$(function() {
  var Counter = AV.Object.extend("Counter");
  if ($('.leancloud_visitors').length == 1) {
    addCount(Counter);
  } else if ($('.post-title-link').length > 1) {
    showTime(Counter);
  }
}); 
</script>

  
</body>
</html>
